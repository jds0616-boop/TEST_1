<!-- START OF FILE index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>KAC CNS Training Platform</title>
<!-- Firebase ì—”ì§„(ë¼ì´ë¸ŒëŸ¬ë¦¬) ë¶ˆëŸ¬ì˜¤ê¸° -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<!-- [QR ì½”ë“œ ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€] -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
  // ì„œë²„ ì ‘ì† ì£¼ì†Œ ì„¤ì •
  const firebaseConfig = {
    apiKey: "AIzaSyAUt6WqxWjRoB9xgAWXq2YhVMQutaOZCBc",
    authDomain: "catc-dfb9a.firebaseapp.com",
    databaseURL: "https://catc-dfb9a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "catc-dfb9a",
    storageBucket: "catc-dfb9a.firebasestorage.app",
    messagingSenderId: "669905270724",
    appId: "1:669905270724:web:c89fcc1d9c8f81b3071691",
    measurementId: "G-H1ME51B4MZ"
  };
  // Firebase ì‹œì‘
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
<script>
  // [ë³´ì•ˆ] ë¡œê·¸ì¸ ì„¸ì…˜ ì²´í¬ ë° ìŠ¤ë§ˆíŠ¸ ë¦¬ë‹¤ì´ë ‰íŠ¸
  if(sessionStorage.getItem('kac_access_token') !== 'granted') {
    // í˜„ì¬ ë³´ê³  ìˆëŠ” ì£¼ì†Œë¥¼ ê¸°ì–µí•œ ìƒíƒœë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
    location.replace('login.html?redirect=' + encodeURIComponent(window.location.href));
  }
</script>
<style>
  @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
  
  :root { 
    --navy: #0f172a; --bg-main: #f0f4f8; --bg-card: #ffffff; 
    --text-main: #000000; --text-sub: #334155;
    --border-card: 2px solid transparent; 
    --shadow: 0 10px 25px rgba(0,0,0,0.05);
    --btn-bg: #f8fafc; --btn-border: #e2e8f0; --btn-text: #64748b;
    --header-h: 75px;
    --search-border: #cbd5e1;
    --search-shadow: 0 8px 30px rgba(15, 23, 42, 0.12);
  }

  body.dark-mode {
    --navy: #020617; --bg-main: #0f172a; --bg-card: #1e293b; 
    --text-main: #f1f5f9; --text-sub: #cbd5e1;
    --border-card: 2px solid rgba(255,255,255,0.1); 
    --shadow: 0 10px 30px rgba(0,0,0,0.5);
    --btn-bg: rgba(255,255,255,0.05); --btn-border: rgba(255,255,255,0.2); --btn-text: #e2e8f0;
    --search-border: rgba(255,255,255,0.1);
    --search-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
  
  html, body { width: 100%; height: 100%; overflow: hidden; }
  
  body { 
    background: var(--bg-main); display: flex; flex-direction: column; 
    color: var(--text-main); transition: background 0.3s, color 0.3s; 
  }

  /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .modal-overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); 
      z-index: 9999; display: none !important; 
      align-items: center; justify-content: center; 
  }
  .modal-overlay[style*="display: flex"] { display: flex !important; }

  body.preview-active .card-ctrl, body.preview-active .add-slot { display: none !important; }
  
  /* í—¤ë” ìŠ¤íƒ€ì¼ */
  header { 
    height: var(--header-h); background: var(--navy); 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 0 20px; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
    z-index: 5000; position: fixed; top: 0; left: 0; width: 100%;
  }
  
  .header-left { display: flex; align-items: center; gap: 15px; z-index: 10; min-width: 0; flex-shrink: 1; }
  .hamburger-btn { cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; flex-shrink: 0; }
  .hamburger-btn:hover { background: rgba(255,255,255,0.1); }
  .hamburger-btn svg { width: 24px; height: 24px; fill: #fff; }

  .logo-text { 
    font-size: 20px; font-weight: 800; letter-spacing: -0.5px; 
    cursor: pointer; white-space: nowrap; 
    overflow: hidden; text-overflow: ellipsis;
  }
  
  /* í—¤ë” ì¤‘ì•™ í˜ì´ì§€ ì œëª© */
  .header-center-title {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      display: flex; align-items: center; justify-content: center; gap: 10px;
      z-index: 5; white-space: nowrap;
  }
  .page-headline { font-size: 24px; font-weight: 800; color: #fff; letter-spacing: -0.5px; cursor: default; }
  body.admin-mode .page-headline { cursor: pointer; opacity: 0.9; }
  body.admin-mode .page-headline:hover { color: #bfdbfe; }

  .page-badge {
      font-size: 12px; font-weight: 800; color: #0f172a;
      background: #38bdf8; padding: 4px 10px; border-radius: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .header-right { display: flex; align-items: center; gap: 15px; z-index: 10; flex-shrink: 0; }
  
  .theme-toggle { display: flex; gap: 5px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); margin-right: 10px; }
  .theme-btn { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; opacity: 0.5; }
  .theme-btn.active { background: #fff; opacity: 1; color: var(--navy); }
  .theme-btn svg { width: 16px; height: 16px; fill: currentColor; }
  
  .kac-logo-img { height: 30px; width: auto; display: block; object-fit: contain; }
  .settings-btn { display: flex; padding: 8px; width: 34px; height: 34px; border-radius: 100px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: 0.3s; color: #cbd5e1; }
  .settings-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

  /* ì‚¬ì´ë“œë°” */
  .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 6000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
  .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
  .sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100vh; background: var(--bg-card); z-index: 6001; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 5px 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; border-right: 1px solid var(--btn-border); }
  .sidebar.active { left: 0; }
  .sidebar-header { height: var(--header-h); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--btn-border); font-weight: 800; font-size: 18px; justify-content: space-between; color: var(--text-main); }
  .sidebar-close { cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
  .sidebar-close:hover { background: var(--btn-bg); }
  .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
  .sb-item { padding: 12px 15px; cursor: pointer; border-radius: 10px; color: var(--text-main); font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: space-between; font-size: 14px; }
  .sb-item:hover { background: var(--btn-bg); color: #2563eb; }
  .sb-sub-list { display: none; padding-left: 20px; margin-bottom: 5px; }
  .sb-sub-list.open { display: block; animation: slideDown 0.2s; }
  .sb-sub-item { padding: 8px 15px; font-size: 13px; color: var(--text-sub); cursor: pointer; border-left: 2px solid var(--btn-border); transition: 0.2s; }
  .sb-sub-item:hover { border-left-color: #2563eb; color: #2563eb; background: rgba(37,99,235,0.05); }

  /* ì»¨í…ì¸  ì˜ì—­ (PC: ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬) */
  .content-wrapper { 
      width: 100%; height: 100%;
      padding-top: 135px; /* ì´ˆê¸°ê°’ */
      padding-bottom: 120px; 
      overflow: hidden; 
      position: relative; 
      display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  
  .center-content-box { width: 100%; max-width: 1700px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

  /* ê²€ìƒ‰ì°½ */
  .search-wrapper-outer { width: 100%; display: flex; justify-content: center; margin-bottom: 40px; flex-shrink: 0; z-index: 2000; position: relative; padding: 0 20px; pointer-events: none; }
  .search-container { position: relative; width: 600px; max-width: 100%; pointer-events: auto; }
  
  .search-bar { 
    width: 100%; padding: 18px 30px; border-radius: 50px; 
    border: 2px solid #cbd5e1; background: #fff; color: #000;
    font-size: 16px; font-weight: 600; 
    box-shadow: 0 8px 30px rgba(15, 23, 42, 0.12); transition: 0.3s; 
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z'/%3E%3C/svg%3E"); 
    background-repeat: no-repeat; background-position: 25px center; background-size: 24px; padding-left: 65px; 
  }
  .search-bar:focus { outline: none; border-color: #2563eb; box-shadow: 0 12px 40px rgba(37, 99, 235, 0.18); transform: translateY(-2px); }
  body.dark-mode .search-bar { background: #1e293b; color: #fff; border-color: #475569; }

  .search-results { position: absolute; top: calc(100% + 15px); left: 0; right: 0; width: 100%; background: var(--bg-card); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid var(--border-card); overflow: hidden; display: none; max-height: 400px; overflow-y: auto; z-index: 2001; }
  .search-results.active { display: block; animation: slideDown 0.2s ease-out; }
  #searchOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1500; display: none; backdrop-filter: blur(2px); animation: fadeIn 0.3s; }
  #searchOverlay.active { display: block; }

  /* ë©”ì¸ ì¹´ë“œ ì˜ì—­ */
  #cardContainerWrapper { width: 100%; max-width: 1700px; overflow: hidden; padding: 0 20px; flex-shrink: 0; }
  #cardContainer { 
    display: flex; flex-wrap: wrap; gap: 30px; width: 100%; justify-content: center; padding: 20px; 
    transform-style: preserve-3d; min-height: auto; 
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s;
  }
  
  .card { background: var(--bg-card); width: 280px; height: 280px; padding: 30px 20px; border-radius: 25px; box-shadow: var(--shadow); border: var(--border-card); cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-left: 10px solid transparent; color: var(--text-main); --card-color: #64748b; border-left-color: var(--card-color); z-index: 1; }
  .card:hover { transform: translateY(-10px); border-color: var(--card-color); box-shadow: 0 15px 30px -5px var(--card-color); z-index: 2; }
  
  /* ê´€ë¦¬ì ëª¨ë“œì—ì„œ ë¹„ê³µê°œ/ê¶Œí•œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .card.restricted-view { opacity: 0.7; border: 2px dashed #94a3b8; }
  .card.restricted-view:hover { opacity: 1; border-style: solid; }

  /* ë¹ˆì¹¸ ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ (ì•ˆë³´ì´ê²Œ) */
  .card.empty-placeholder { opacity: 0; pointer-events: none; border: none; box-shadow: none; background: transparent; cursor: default; }
  /* ê´€ë¦¬ì ëª¨ë“œì—ì„œëŠ” ë³´ì´ê²Œ */
  body.admin-mode .card.empty-placeholder { opacity: 0.5; border: 2px dashed #cbd5e1; cursor: pointer; pointer-events: auto; }
  body.admin-mode .card.empty-placeholder:hover { border-color: #2563eb; opacity: 1; }

  .card.dragging { opacity: 0.4; border: 2px dashed #94a3b8; }
  .card.drag-over { transform: scale(1.05); box-shadow: 0 0 20px rgba(37, 99, 235, 0.3); border-color: #2563eb; z-index: 10; }

  .card-ctrl { position: absolute; top: 15px; width: 100%; display: none; gap: 5px; justify-content: center; z-index: 10; }
  body.admin-mode .card .card-ctrl { display: flex; }

  .icon-box { width: 100px; height: 100px; border-radius: 30px; margin-bottom: 20px; font-weight: 900; display: flex; align-items: center; justify-content: center; background: var(--btn-bg); border: 1px solid var(--btn-border); font-size: var(--icon-size-idx, 60px); color: var(--card-color); pointer-events: none; }
  .card h2 { font-size: var(--label-size-idx, 24px); font-weight: 800; text-align: center; pointer-events: none; }

  .pagination { display: flex; gap: 10px; margin-top: 20px; align-items: center; justify-content: center; padding-bottom: 0px; flex-shrink: 0; }
  .page-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--btn-border); cursor: pointer; transition: 0.3s; }
  .page-dot.active { background: var(--navy); transform: scale(1.3); }

  /* í•˜ë‹¨ë°” (Footer) - PC ì ˆëŒ€ ê³ ì • */
  .main-footer {
    width: 100%; height: auto;
    background: var(--navy); padding: 25px 20px;
    text-align: center; color: rgba(255,255,255,0.7);
    font-size: 13px; line-height: 1.6;
    border-top: 1px solid rgba(255,255,255,0.1); box-sizing: border-box;
    position: absolute; bottom: 0; left: 0; 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 1000;
  }
  .footer-content p { margin: 0; word-break: keep-all; }
  .footer-content p:last-child { font-weight: 700; margin-top: 8px; color: rgba(255,255,255,0.9); }
  
  .footer-edit-btn { margin-top: 10px; font-size: 11px; cursor: pointer; opacity: 0.5; color: #fff; border: 1px solid rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 4px; display: none; }
  .footer-edit-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }
  body.admin-mode .footer-edit-btn { display: inline-block; }

  /* ëª¨ë°”ì¼ìš© ë– ìˆëŠ” í…Œë§ˆ ë²„íŠ¼ */
  .mobile-theme-float { display: none; }

  /* ========================================= */
  /* [ëª¨ë°”ì¼ ì „ìš© ìµœì í™”] */
  /* ========================================= */
  @media (max-width: 768px) {
    html, body { 
        overflow-y: auto !important; 
        height: auto !important; 
        position: relative !important;
        overflow-x: hidden;
    }
    
    body { display: block; }
    
    header { position: fixed; top: 0; padding: 0 10px; z-index: 5000; justify-content: space-between; }

    .search-wrapper-outer { 
        position: fixed !important; 
        top: var(--header-h); /* í—¤ë” ë°”ë¡œ ì•„ë˜ */
        left: 0; 
        width: 100%; 
        z-index: 4500; 
        margin-bottom: 0; 
        background: var(--bg-main); 
        padding: 10px 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .search-container { width: 100%; }
    .search-bar { padding: 12px 20px 12px 50px; font-size: 14px; background-position: 15px center; }

    .content-wrapper { 
        height: auto !important; 
        overflow: visible; 
        padding-top: 155px !important; 
        padding-bottom: 120px; /* í‘¸í„° ë†’ì´ë§Œí¼ ì—¬ë°± í™•ë³´ */
        display: block; 
    }
    
    .center-content-box { display: block; width: 100%; }

    .header-left { flex: 0 0 auto; }
    
    /* [ìˆ˜ì • 1] ëª¨ë°”ì¼ í—¤ë” íƒ€ì´í‹€ í¬ê¸° ì¶•ì†Œ ë° ì˜ë¦¼ ë°©ì§€ */
    .logo-text { 
        position: absolute; 
        left: 50%; 
        transform: translateX(-50%); 
        font-size: 16px !important; /* ì¶•ì†Œ */
        font-weight: 800;
        max-width: 90%; /* ëŠ˜ë¦¼ */
        text-align: center;
        white-space: nowrap; 
    }
    
    .kac-logo-img { display: none; }
    .header-center-title { display: none; }
    
    .header-right { gap: 8px; }

    .theme-toggle { display: none !important; }
    .settings-btn { display: none; }

    #cardContainerWrapper { padding: 0 15px; }
    /* [ìˆ˜ì • 5] ë¦¬ìŠ¤íŠ¸ ì—°ì† ì¶œë ¥ì„ ìœ„í•œ flex column */
    #cardContainer { gap: 15px; padding: 10px 0; min-height: auto; flex-direction: column; flex-wrap: nowrap; }
    
    .card.empty-placeholder { display: none !important; }

    /* [ìˆ˜ì • 2] ì¹´ë“œ(ë²„íŠ¼) ë†’ì´ ë” ì¶•ì†Œ (50px) */
    .card { 
      width: 100%; 
      height: auto; 
      min-height: 50px; /* 50pxë¡œ ì¶•ì†Œ */
      flex-direction: row; justify-content: flex-start; 
      padding: 10px 12px; /* íŒ¨ë”© ì¶•ì†Œ */
      gap: 15px; 
      border-radius: 15px;
    }
    .card:hover { transform: translateY(-3px); }
    /* ì•„ì´ì½˜ ë°•ìŠ¤ í¬ê¸° ì¶•ì†Œ */
    .icon-box { 
        width: 36px; height: 36px; 
        border-radius: 8px; margin-bottom: 0; 
        font-size: 18px; flex-shrink: 0; 
    }
    .card h2 { font-size: 15px; text-align: left; word-break: keep-all; flex: 1; }
    .card-ctrl { top: 50%; right: 10px; transform: translateY(-50%); width: auto; flex-direction: row; }
    .btn-sm { padding: 6px 10px; }

    /* [ìˆ˜ì • 4] í˜ì´ì§€ë„¤ì´ì…˜(íšŒìƒ‰ë°•ìŠ¤) ì œê±° */
    #pagination { display: none !important; }

    /* [ìˆ˜ì • 3] í•˜ë‹¨ë°” ê³ ì • */
    .main-footer { 
        padding: 20px 15px; 
        margin-top: 0; 
        position: fixed !important; 
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        height: auto; 
        z-index: 5500;
        border-top: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    }
    .main-footer p { font-size: 11px; white-space: normal; }

    /* [ìˆ˜ì • 7] ì£¼/ì•¼ê°„ ì•„ì´ì½˜ í”Œë¡œíŒ… (í•˜ë‹¨ë°” ì¢Œì¸¡ ìœ„) */
    .mobile-theme-float {
        display: flex !important;
        position: fixed;
        bottom: 25px; /* í•˜ë‹¨ë°” ìœ„ì— ì‚´ì§ ê±¸ì¹˜ê±°ë‚˜ ìœ„ë¡œ */
        left: 15px;
        z-index: 6000;
        width: 36px; height: 36px;
        border-radius: 50%;
        background: var(--bg-card);
        border: 1px solid var(--btn-border);
        color: var(--text-sub);
        align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        cursor: pointer;
    }
    .mobile-theme-float svg { width: 18px; height: 18px; fill: currentColor; }
  }

  #loadingSpinner { position: fixed; inset: 0; background: var(--bg-main); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
  .spinner { width: 50px; height: 50px; border: 5px solid #cbd5e1; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }

  .btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; border: 1px solid var(--btn-border); background: var(--btn-bg); font-weight: 700; cursor: pointer; color: var(--btn-text); }
  .btn-del { color: #ef4444; border-color: #fee2e2; }
  .btn-move { color: #3b82f6; border-color: #dbeafe; }

  /* í†µí•© ê´€ë¦¬ì ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .tree-container { display: flex; height: 500px; border: 1px solid var(--btn-border); border-radius: 10px; overflow: hidden; margin-top: 15px; }
  .tree-sidebar { width: 35%; background: var(--bg-main); border-right: 1px solid var(--btn-border); overflow-y: auto; padding: 10px; }
  .tree-content { width: 65%; padding: 20px; overflow-y: auto; background: var(--bg-card); }
  
  .t-node-row { display: flex; align-items: center; padding: 4px 0; }
  .t-toggle-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; color: var(--text-sub); flex-shrink: 0; transition: transform 0.2s; }
  .t-toggle-btn:hover { color: #2563eb; }
  .t-toggle-btn.empty { cursor: default; opacity: 0; } 
  .t-label { padding: 6px 10px; cursor: pointer; border-radius: 6px; font-size: 13px; color: var(--text-main); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .t-label:hover { background: rgba(37,99,235,0.1); }
  .t-label.selected { background: #2563eb; color: #fff; }
  .t-children { display: none; padding-left: 18px; border-left: 1px solid var(--btn-border); margin-left: 11px; }
  .t-children.open { display: block; }

  /* ê³µí†µ ëª¨ë‹¬ */
  .modal-card { background: var(--bg-card); padding: 35px; border-radius: 25px; width: 450px; color: var(--text-main); box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
  .modal-card.large { width: 1000px; max-width: 95%; height: 85vh; }
  .setting-group { margin-bottom: 20px; }
  .setting-label { font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; display: block; }
  .setting-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--btn-border); background: var(--btn-bg); color: var(--text-main); font-size: 14px; outline: none; }
  
  /* ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
  .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; background: var(--btn-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--btn-border); }
  .checkbox-item { display: flex; align-items: center; gap: 10px; font-size: 14px; cursor: pointer; }
  .checkbox-item input { width: 16px; height: 16px; cursor: pointer; }

  /* í•˜ë‹¨ í…ìŠ¤íŠ¸ ìˆ˜ì •ìš© íŒì—… (ë„“ê²Œ) */
  #footerEditModal .modal-card { width: 800px; max-width: 90%; }
  .setting-textarea { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid var(--btn-border); background: var(--btn-bg); color: var(--text-main); font-size: 14px; outline: none; resize: vertical; min-height: 200px; line-height: 1.6; }

  body.dark-mode .setting-input, body.dark-mode select.setting-input, body.dark-mode .setting-textarea { background-color: #334155; color: #fff; border-color: rgba(255,255,255,0.2); }

  .btn-modal { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; margin-top: 5px; }
  .btn-primary { background: var(--navy); color: #fff; }
  .btn-secondary { background: var(--btn-border); color: var(--text-sub); }
  .btn-danger { background: #ef4444; color: #fff; }
  .btn-success { background: #10b981; color: #fff; }
  .btn-preview-active { background: #10b981 !important; color: #fff !important; box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4) !important; }

  .result-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--btn-border); transition: 0.2s; }
  .result-item:hover { background: rgba(37, 99, 235, 0.05); }
  .res-title { font-weight: 700; font-size: 15px; }
  .res-path { font-size: 11px; opacity: 0.7; }
  .res-tag { font-size: 12px; font-weight: 900; padding: 4px 10px; border-radius: 6px; color: #fff; min-width: 50px; text-align: center; }

  @keyframes spin { 100% { transform: rotate(360deg); } }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<div id="loadingSpinner">
  <div class="spinner"></div>
  <div style="font-weight:700; color:#64748b;">ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</div>
</div>

<div id="searchOverlay"></div>

<!-- ì‚¬ì´ë“œë°” -->
<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <span>ì „ì²´ ë©”ë‰´</span>
    <div class="sidebar-close" onclick="toggleSidebar()">âœ•</div>
  </div>
  <div class="sidebar-content" id="sidebarContent">
    <!-- JSë¡œ ë™ì  ìƒì„± -->
  </div>
</div>

<header>
  <div class="header-left">
    <div class="hamburger-btn" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </div>
    <div class="logo-text" onclick="location.reload()">KAC CNS Training Platform</div>
  </div>
  
  <div class="header-center-title">
      <span id="pageHeadline" class="page-headline" onclick="editPageTitle()"></span>
      <span id="pageBadge" class="page-badge">Page 1</span>
  </div>

  <div class="header-right">
    <div class="theme-toggle">
      <div class="theme-btn" id="btnDay" onclick="setTheme('light')"><svg viewBox="0 0 24 24"><path d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,5.29C7.24,6.03 7.06,6.79 7,7.59C6.94,8.39 7.03,9.19 7.26,9.95L3.34,7M3.36,17L7.26,14.04C7.03,14.81 6.94,15.61 7,16.41C7.06,17.21 7.24,17.97 7.5,18.71L3.36,17M20.65,7L16.74,9.95C16.97,9.19 17.06,8.39 17,7.59C16.94,6.79 16.76,6.03 16.5,5.29L20.65,7M20.64,17L16.5,18.71C16.76,17.97 16.94,17.21 17,16.41C17.06,15.61 16.97,14.81 16.74,14.04L20.64,17M12,22L9.61,18.58C10.35,18.85 11.16,19 12,19C12.84,19 13.65,18.85 14.39,18.58L12,22Z"/></svg></div>
      <div class="theme-btn" id="btnNight" onclick="setTheme('dark')"><svg viewBox="0 0 24 24"><path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C6.94,10.39 9.79,16.87 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.36,12.31 6.2,9.5 6.04,6.68C3.23,9.82 3.34,14.64 6.35,17.66C9.37,20.67 14.19,20.78 17.33,17.97Z"/></svg></div>
    </div>
    <div class="settings-btn" onclick="openSettings()">âš™ï¸</div>
    <img src="logo.png" alt="KAC Logo" class="kac-logo-img">
  </div>
</header>

<div class="content-wrapper">
  
  <div class="center-content-box">
    <div class="search-wrapper-outer">
      <div class="search-container">
        <input type="text" id="mainSearch" class="search-bar" placeholder="ì‹œì„¤ëª… ë˜ëŠ” êµìœ¡ ì£¼ì œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”..." autocomplete="off">
        <div id="searchResults" class="search-results"></div>
      </div>
    </div>
    
    <div id="cardContainerWrapper">
      <main id="cardContainer"></main>
    </div>
    <div id="pagination" class="pagination"></div>
  </div>

  <!-- ëª¨ë°”ì¼ìš© í”Œë¡œíŒ… í…Œë§ˆ ë²„íŠ¼ -->
  <div class="mobile-theme-float" onclick="toggleThemeMobile()">
      <svg viewBox="0 0 24 24"><path d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,5.29C7.24,6.03 7.06,6.79 7,7.59C6.94,8.39 7.03,9.19 7.26,9.95L3.34,7M3.36,17L7.26,14.04C7.03,14.81 6.94,15.61 7,16.41C7.06,17.21 7.24,17.97 7.5,18.71L3.36,17M20.65,7L16.74,9.95C16.97,9.19 17.06,8.39 17,7.59C16.94,6.79 16.76,6.03 16.5,5.29L20.65,7M20.64,17L16.5,18.71C16.76,17.97 16.94,17.21 17,16.41C17.06,15.61 16.97,14.81 16.74,14.04L20.64,17M12,22L9.61,18.58C10.35,18.85 11.16,19 12,19C12.84,19 13.65,18.85 14.39,18.58L12,22Z"/></svg>
  </div>

  <!-- í•˜ë‹¨ë°” (Footer) -->
  <footer class="main-footer">
    <div class="footer-content">
        <!-- JSë¡œ ë¡œë“œë¨ -->
    </div>
    <span class="footer-edit-btn" onclick="openFooterEditModal()">í…ìŠ¤íŠ¸ ìˆ˜ì •</span>
  </footer>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</div>
    <div id="guestSettings">
      <p style="margin-bottom:20px; font-size:14px; color:var(--text-sub);">ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
      <button class="btn-modal btn-primary" onclick="toggleAdmin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
    </div>
    <div id="adminSettings" style="display:none;">
      <div class="setting-group">
        <label class="setting-label">ğŸ› ï¸ ì‹œìŠ¤í…œ ê´€ë¦¬</label>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn-modal btn-danger" onclick="toggleAdmin()">ë¡œê·¸ì•„ì›ƒ</button>
          <button class="btn-modal btn-secondary" onclick="openPwChangeModal()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
          <button class="btn-modal btn-success" onclick="saveToFirebase()">â˜ï¸ ì„œë²„ì— ìµœì¢… ì €ì¥ (Firebase)</button>
          <button id="modalPreviewBtn" class="btn-modal btn-secondary" onclick="togglePreview()">ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ ì‹œì‘</button>
        </div>
        
        <button class="btn-modal btn-primary" style="margin-top:10px; background:#4f46e5;" onclick="openIntegratedAdmin()">
            ğŸ—‚ï¸ ì „ì²´ ë°ì´í„° ì¢…í•© ê´€ë¦¬ (Tree Editor)
        </button>

        <button class="btn-modal btn-success" onclick="exportJsonData()">ë³€ê²½ì‚¬í•­ ì €ì¥ (data.json ë‹¤ìš´ë¡œë“œ)</button>
        
        <button class="btn-modal btn-primary" style="background:#24292f; margin-top:10px;" onclick="openGithubModal()">
          <svg style="width:16px;height:16px;vertical-align:middle;margin-right:5px;fill:white;" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
          GitHubì— ë°”ë¡œ ì—…ë¡œë“œ
        </button>

        <p style="font-size:11px; color:red; margin-top:5px;">* ì¤‘ìš”: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë˜ëŠ” ë°ì´í„° ìˆ˜ì • í›„ ë°˜ë“œì‹œ [ë³€ê²½ì‚¬í•­ ì €ì¥] ë˜ëŠ” [GitHub ì—…ë¡œë“œ]ë¥¼ í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤.</p>
        
        <button class="btn-modal btn-danger" style="margin-top:15px; background:#ef4444; opacity:0.8;" onclick="resetToDataJson()">âš ï¸ ì„œë²„ ì›ë³¸ìœ¼ë¡œ ì´ˆê¸°í™” (ìˆ˜ì •ì·¨ì†Œ)</button>
      </div>
      
      <div class="setting-group" style="background: rgba(0,0,0,0.02); padding: 15px; border-radius: 15px; border: 1px solid var(--btn-border);">
        <label class="setting-label">â†•ï¸ ì½˜í…ì¸  ìœ„ì¹˜ ì¡°ì • (ìƒë‹¨ ì—¬ë°±)</label>
        <div style="display:flex; gap:10px;">
          <input type="number" id="setContentTop" class="setting-input" placeholder="ê¸°ë³¸ê°’ 135" value="135">
        </div>
      </div>

      <div class="setting-group" style="background: rgba(0,0,0,0.02); padding: 15px; border-radius: 15px; border: 1px solid var(--btn-border);">
        <label class="setting-label">ğŸ¨ ì¹´ë“œ UI í¬ê¸° ì„¤ì • (px)</label>
        <div style="display:flex; gap:15px; align-items: center; margin-bottom: 10px;">
          <div style="flex:1"><span style="font-size:11px; color:var(--text-sub); display:block; margin-bottom:5px;">ì•„ì´ì½˜</span><input type="number" id="setIconSize" class="setting-input" placeholder="60"></div>
          <div style="flex:1"><span style="font-size:11px; color:var(--text-sub); display:block; margin-bottom:5px;">ë¼ë²¨</span><input type="number" id="setLabelSize" class="setting-input" placeholder="24"></div>
        </div>
        <button class="btn-modal btn-primary" onclick="saveUISettings()" style="margin-top:0;">ì„¤ì • ì ìš©</button>
      </div>
    </div>
    <button class="btn-modal btn-secondary" onclick="document.getElementById('settingsModal').style.display='none'">ë‹«ê¸°</button>
  </div>
</div>

<!-- í†µí•© ê´€ë¦¬ì (Tree Editor) ëª¨ë‹¬ -->
<div id="integratedAdminModal" class="modal-overlay">
  <div class="modal-card modal-card large">
    <div class="modal-title">ğŸ—‚ï¸ ì „ì²´ ë°ì´í„° ì¢…í•© ê´€ë¦¬</div>
    <p style="font-size:13px; color:var(--text-sub);">
      ì¢Œì¸¡ íŠ¸ë¦¬ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”. 'ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.<br>
      <b>â–¶ í™”ì‚´í‘œ:</b> ì ‘ê¸°/í¼ì¹˜ê¸° &nbsp;|&nbsp; <b>í…ìŠ¤íŠ¸:</b> ì„ íƒ ë° í¸ì§‘
    </p>
    
    <div class="tree-container">
      <div class="tree-sidebar" id="treeRoot"></div>
      <div class="tree-content" id="treeDetail">
        <div style="display:flex; height:100%; align-items:center; justify-content:center; color:var(--text-sub);">
          í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        </div>
      </div>
    </div>

    <div class="btn-row" style="margin-top:20px; display:flex; gap:10px;">
      <button class="btn-modal btn-primary" onclick="saveIntegratedData()">ì „ì²´ ì €ì¥ ë° ì ìš©</button>
      <button class="btn-modal btn-secondary" onclick="document.getElementById('integratedAdminModal').style.display='none'">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- GitHub ì—…ë¡œë“œ ì„¤ì • ëª¨ë‹¬ -->
<div id="githubModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">ğŸ™ GitHub ì—°ë™ ì„¤ì •</div>
    <p style="font-size:12px; color:#64748b; margin-bottom:15px;">
      ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì •ë³´ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
    </p>
    <div class="setting-group">
      <label class="setting-label">GitHub ì•„ì´ë”” (Owner)</label>
      <input type="text" id="ghOwner" class="setting-input" placeholder="ì˜ˆ: MyGitID">
    </div>
    <div class="setting-group">
      <label class="setting-label">ì €ì¥ì†Œ ì´ë¦„ (Repo)</label>
      <input type="text" id="ghRepo" class="setting-input" placeholder="ì˜ˆ: kac-training-platform">
    </div>
    <div class="setting-group">
      <label class="setting-label">Personal Access Token</label>
      <input type="password" id="ghToken" class="setting-input" placeholder="ghp_..." autocomplete="new-password">
      <p style="font-size:11px; color:red; margin-top:5px;">* í† í°ì€ ì ˆëŒ€ íƒ€ì¸ì—ê²Œ ê³µìœ í•˜ì§€ ë§ˆì„¸ìš”.</p>
    </div>
    <div class="btn-row">
      <button id="btnGhUpload" class="btn-modal btn-primary" onclick="uploadToGithub()">ì—…ë¡œë“œ ì‹¤í–‰</button>
      <button class="btn-modal btn-secondary" onclick="document.getElementById('githubModal').style.display='none'">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
<div id="pwChangeModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
    <div class="setting-group">
      <label class="setting-label">ë³€ê²½í•  ëŒ€ìƒ</label>
      <select id="pwTarget" class="setting-input">
        <option value="entry">êµìœ¡ìƒ (ì ‘ì†ìš©) ë¹„ë°€ë²ˆí˜¸</option>
        <option value="admin">ê´€ë¦¬ì (ì„¤ì •ìš©) ë¹„ë°€ë²ˆí˜¸</option>
      </select>
    </div>
    <div class="setting-group">
      <label class="setting-label">ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="newPw" class="setting-input" placeholder="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    </div>
    <div class="btn-row">
      <button class="btn-modal btn-primary" onclick="executePwChange()">ë³€ê²½ ì‹¤í–‰</button>
      <button class="btn-modal btn-secondary" onclick="document.getElementById('pwChangeModal').style.display='none'">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- í•˜ë‹¨ë°” í…ìŠ¤íŠ¸ ìˆ˜ì • ëª¨ë‹¬ (ê°„í¸ ì…ë ¥) -->
<div id="footerEditModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">ğŸ“ í•˜ë‹¨ë°” ë¬¸êµ¬ ìˆ˜ì •</div>
    <p style="font-size:13px; color:#64748b; margin-bottom:15px;">
        ì›í•˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ì—”í„°(Enter)ë¥¼ ì¹˜ë©´ ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆì´ ì ìš©ë©ë‹ˆë‹¤.<br>
        ë§ˆì§€ë§‰ ì¤„ì€ ìë™ìœ¼ë¡œ <b>êµµê²Œ(ì €ì‘ê¶Œ ìŠ¤íƒ€ì¼)</b> í‘œì‹œë©ë‹ˆë‹¤.
    </p>
    <div class="setting-group">
      <textarea id="footerTextInput" class="setting-textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    </div>
    <div class="btn-row">
      <button class="btn-modal btn-primary" onclick="saveFooterText()">ì €ì¥ ë° ì ìš©</button>
      <button class="btn-modal btn-secondary" onclick="document.getElementById('footerEditModal').style.display='none'">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ì¹´ë“œ ìˆ˜ì • ëª¨ë‹¬ (ê°„í¸) -->
<div id="cardEditModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">ì¹´í…Œê³ ë¦¬ ìˆ˜ì •</div>
    <div class="setting-group"><label class="setting-label">ëª…ì¹­</label><input type="text" id="editName" class="setting-input"></div>
    <div class="setting-group"><label class="setting-label">ì•„ì´ì½˜ ì½”ë“œ (ì˜ë¬¸ 1ì)</label><input type="text" id="editCode" class="setting-input"></div>
    <div class="setting-group"><label class="setting-label">í…Œë§ˆ ìƒ‰ìƒ</label><input type="color" id="editColor" style="width:100%; height:40px; cursor:pointer;"></div>
    
    <!-- ê³µê°œ/ê´€ë¦¬ì/ì‚¬ì´ë“œë°” ì„¤ì • -->
    <div class="checkbox-group">
        <label class="setting-label">ë…¸ì¶œ ë° ê¶Œí•œ ì„¤ì •</label>
        <label class="checkbox-item"><input type="checkbox" id="chkVisible" checked> <span>ê³µê°œ ì—¬ë¶€ (ì²´í¬ ì‹œ ì‚¬ìš©ìì—ê²Œ ë³´ì„)</span></label>
        <label class="checkbox-item"><input type="checkbox" id="chkAdminOnly"> <span>ê´€ë¦¬ì ì „ìš© (ì²´í¬ ì‹œ ê´€ë¦¬ìë§Œ ë³´ì„)</span></label>
        <label class="checkbox-item"><input type="checkbox" id="chkSidebar" checked> <span>ì‚¬ì´ë“œë°” ë©”ë‰´ì— í‘œì‹œ</span></label>
    </div>

    <div class="btn-row">
      <button class="btn-modal btn-primary" onclick="saveCardEdit()">ì €ì¥</button>
      <button class="btn-modal btn-secondary" onclick="document.getElementById('cardEditModal').style.display='none'">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ì´ë™ ëª¨ë‹¬ -->
<div id="movePageModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">ğŸ“‚ í˜ì´ì§€ ì´ë™</div>
    <select id="moveTargetPage" class="setting-input" style="margin-bottom:20px;"></select>
    <div class="btn-row"><button class="btn-modal btn-primary" onclick="executeMovePage()">ì´ë™</button><button class="btn-modal btn-secondary" onclick="document.getElementById('movePageModal').style.display='none'">ì·¨ì†Œ</button></div>
  </div>
</div>

<script>

function normalizeArray(v) {
  if (Array.isArray(v)) return v;
  if (v && typeof v === 'object') return Object.values(v);
  return [];
}
  let globalData = { categories: [], config: {}, security: {} };
  let isAdmin = localStorage.getItem('kac_admin_mode') === '1';
  let isPreview = localStorage.getItem('kac_preview_active') === '1';
  let searchIndex = [];
  let editingCardId = null;
  let moveSrcIndex = -1;

  // í˜ì´ì§€ë„¤ì´ì…˜
  const itemsPerPage = 5;
  let currentPage = 1;

  // ë“œë˜ê·¸ì•¤ë“œë¡­
  let dragSrcIndex = null;
  
  // ì¢…í•© ê´€ë¦¬ìš© ë³€ìˆ˜
  let currentTreeSelection = null; 

// [ìˆ˜ì •] ì•ˆì „í•œ ì¸ì¦ í™•ì¸ í•¨ìˆ˜
function ensureAnonAuth() {
  return new Promise((resolve) => {
    // 1. ìƒíƒœ ë³€í™” ê°ì§€ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        // ì´ë¯¸ ë¡œê·¸ì¸ ë˜ì–´ ìˆê±°ë‚˜, ë°©ê¸ˆ ë¡œê·¸ì¸ ë¨
        console.log("âœ… Firebase Auth ìƒíƒœ: ì¸ì¦ë¨ (UID: " + user.uid + ")");
        unsubscribe(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
        resolve();
      } else {
        // ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœ -> ìµëª… ë¡œê·¸ì¸ ì‹œë„
        console.log("ğŸ”’ ì¸ì¦ ì •ë³´ ì—†ìŒ. ìµëª… ë¡œê·¸ì¸ ì‹œë„...");
        // ì£¼ì˜: ì—¬ê¸°ì„œ unsubscribe í•˜ì§€ ì•ŠìŒ. ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ìœ„ if(user) ë¸”ë¡ì´ ë‹¤ì‹œ ì‹¤í–‰ë¨.
        firebase.auth().signInAnonymously().catch((error) => {
          console.error("âŒ ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
          unsubscribe();
          resolve(); // ì‹¤íŒ¨í•˜ë”ë¼ë„ ë¡œì»¬ ë°ì´í„°ë¡œ ì§„í–‰í•˜ê¸° ìœ„í•´ resolve
        });
      }
    });
  });
}

async function init() {
  // 1. ë¡œë”© í‘œì‹œ
  const spinner = document.getElementById('loadingSpinner');
  if(spinner) spinner.style.display = 'flex';

  // 2. ìµëª… ê¶Œí•œ íšë“ (DB ì½ê¸° ìœ„í•´ í•„ìˆ˜)
  await ensureAnonAuth();

  // 3. í…Œë§ˆ ì ìš©
  setTheme(localStorage.getItem('kac_theme') || 'light');
  if (isPreview) document.body.classList.add('preview-active');
  if (isAdmin) document.body.classList.add('admin-mode');

  // 4. Firebaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  console.log("ğŸ”¥ Firebase ë°ì´í„° ë¡œë”© ì‹œë„...");
  try {
    const snapshot = await db.ref('/').once('value');
    if (snapshot.exists()) {
      const serverData = snapshot.val();
      console.log("âœ… ì„œë²„ ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ");

      // ì„œë²„ ë°ì´í„°ê°€ ìˆìœ¼ë©´ globalDataë¥¼ ë®ì–´ì”Œì›€
      globalData = serverData;
      
      // ë°ì´í„° ë°°ì—´ ë³´ì • (ë¹ˆ êµ¬ë©ì´ë‚˜ nullê°’ ì²˜ë¦¬)
      if (globalData.categories) {
          globalData.categories = normalizeArray(globalData.categories);
      } else {
          globalData.categories = [];
      }
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë„ ì„œë²„ ë°ì´í„°ë¡œ ë™ê¸°í™” (ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
      syncToLocalStorage(globalData);
      
      if(globalData.config) applyConfig(globalData.config);

    } else {
      console.log("âš ï¸ ì„œë²„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ˆê¸° ìƒíƒœ)");
      // ì„œë²„ê°€ ë¹„ì–´ìˆìœ¼ë©´ ë¡œì»¬ ë°ì´í„° ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
      reconstructGlobalDataFromLocal();
    }
  } catch (e) {
    console.error("âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨(ë¡œì»¬ ëª¨ë“œ ì§„ì…):", e);
    reconstructGlobalDataFromLocal();
  }

  // 5. í™”ë©´ ë Œë”ë§
  const contentTop = localStorage.getItem('kac_content_top');
  if(contentTop) {
      document.querySelector('.content-wrapper').style.paddingTop = contentTop + 'px';
  }
  
  loadFooterText(); // í•˜ë‹¨ ë¬¸êµ¬ ë¡œë“œ
  ensurePageSlots(); // ë¹ˆ ìŠ¬ë¡¯ ì±„ìš°ê¸°
  renderCards(false); // ì¹´ë“œ ê·¸ë¦¬ê¸°
  buildSearchIndex(); // ê²€ìƒ‰ì—”ì§„ ìƒì„±
  renderSidebar(); // ì‚¬ì´ë“œë°” ìƒì„±
  
  // ë¡œë”© ì¢…ë£Œ
  if(spinner) {
      spinner.style.opacity = '0';
      setTimeout(() => spinner.style.display='none', 500);
  }
}
  
  function loadFooterText() {
      let savedHtml = globalData.config.footerText;
      if (!savedHtml) {
          savedHtml = localStorage.getItem('kac_full_footer');
      }
      const defaultHtml = "<p>ë³¸ ì›¹ì‚¬ì´íŠ¸ëŠ” í•œêµ­ê³µí•­ê³µì‚¬ í•­ê³µê¸°ìˆ í›ˆë ¨ì›ì˜ í•­í–‰ì•ˆì „ì‹œì„¤ ë¶„ì•¼ êµìœ¡ ê´€ë ¨ í”Œë«í¼ì…ë‹ˆë‹¤.</p><p>ë¬¸ì˜ ì´ë©”ì¼ : jds0616@airport.co.kr (Developed by DooSeok, Jang)</p><p>ë¬¸ì˜ ì´ë©”ì¼ : jds0616@airport.co.kr (Developed by DooSeok, Jang)</p><p>Â© 2026 Korea Airports Corporation. All rights reserved.</p>";
      document.querySelector('.footer-content').innerHTML = savedHtml || defaultHtml;
  }

  function openFooterEditModal() {
      let content = document.querySelector('.footer-content').innerHTML;
      let plainText = content.replace(/<br\s*\/?>/gi, "\n")
                             .replace(/<\/p>/gi, "\n")
                             .replace(/<p[^>]*>/gi, "")
                             .replace(/^\s*[\r\n]/gm, "") 
                             .trim();
      document.getElementById('footerTextInput').value = plainText;
      document.getElementById('footerEditModal').style.display = 'flex';
  }

  function saveFooterText() {
      const rawText = document.getElementById('footerTextInput').value;
      const lines = rawText.split('\n');
      let htmlOutput = '';
      lines.forEach(line => {
          if(line.trim() !== '') {
              htmlOutput += `<p>${line.trim()}</p>`;
          }
      });
      localStorage.setItem('kac_full_footer', htmlOutput);
      globalData.config.footerText = htmlOutput;
      syncToLocalStorage(globalData);
      loadFooterText();
      document.getElementById('footerEditModal').style.display = 'none';
      alert("í•˜ë‹¨ ë¬¸êµ¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (JSON ì €ì¥ ì‹œ í•¨ê»˜ í¬í•¨ë©ë‹ˆë‹¤)");
  }
  
  function reconstructGlobalDataFromLocal() {
    const currentSecurity = globalData.security || {
        entry_pw: "db2d3257df630ebeb488b0a9435b863702a0a25694205626359045b8427f311c",
        admin_pw: "db2d3257df630ebeb488b0a9435b863702a0a25694205626359045b8427f311c"
    };

    globalData = { 
        meta: { version: "2.1", lastUpdated: new Date().toISOString() }, 
        config: {}, 
        categories: [], 
        security: currentSecurity 
    };
    
    globalData.config.iconSize = parseInt(localStorage.getItem('kac_idx_icon_size') || 60);
    globalData.config.labelSize = parseInt(localStorage.getItem('kac_idx_label_size') || 24);
    
    const savedTitles = localStorage.getItem('kac_page_titles');
    globalData.config.pageTitles = savedTitles ? JSON.parse(savedTitles) : {};
    globalData.config.footerText = localStorage.getItem('kac_full_footer');
    
    const contentTop = localStorage.getItem('kac_content_top');
    if(contentTop) globalData.config.contentTop = contentTop;

    applyConfig(globalData.config);

    const orderRaw = localStorage.getItem('kac_index_order');
    if(orderRaw) {
        const order = JSON.parse(orderRaw);
        globalData.categories = order.map(id => {
            if(!id) return null;
            const s = JSON.parse(localStorage.getItem(`kac_style_${id}`) || '{}');
            const ms = JSON.parse(localStorage.getItem(`kac_menu_${id}`) || '[]');
            
            // access ì •ë³´ ë³µì›
            const access = s.access || { visible: true, adminOnly: false, showSidebar: true };

            const menuList = ms.map(m => {
                const subs = JSON.parse(localStorage.getItem(`kac_subs_${id}_${m.dataId}`) || '[]');
                // [ìˆ˜ì •] ë©”ë‰´ì˜ visible ì†ì„±ë„ ë³µì› (ì—†ìœ¼ë©´ true)
                const isVisible = (m.visible !== undefined) ? m.visible : true;
                return { id: m.dataId, label: m.label, line1: m.line1, line2: m.line2, link: m.link, visible: isVisible, subjects: subs };
            });

            return { id: id, name: s.name, code: s.code, color: s.color, access: access, menus: menuList };
        });
    }
  }

  function resetToDataJson() {
    if(confirm("í˜„ì¬ê¹Œì§€ ìˆ˜ì •í•œ ëª¨ë“  ë‚´ìš©ì´ ì‚¬ë¼ì§€ê³  ì„œë²„ì˜ ì›ë³¸ íŒŒì¼(data.json) ìƒíƒœë¡œ ë˜ëŒì•„ê°‘ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.clear();
        location.reload();
    }
  }

  window.addEventListener('pageshow', () => {
      const savedStatus = localStorage.getItem('kac_admin_mode') === '1';
      if (isAdmin !== savedStatus) location.reload();
      const savedPreview = localStorage.getItem('kac_preview_active') === '1';
      if(isPreview !== savedPreview) location.reload();
  });

  window.addEventListener('storage', (e) => {
      if (e.key === 'kac_admin_mode' || e.key === 'kac_preview_active') location.reload();
  });

  function ensurePageSlots() {
    const cleanList = globalData.categories.filter(c => c !== null);
    globalData.categories = cleanList;
    if (globalData.categories.length % itemsPerPage !== 0) {
        const needed = itemsPerPage - (globalData.categories.length % itemsPerPage);
        for(let i=0; i<needed; i++) globalData.categories.push(null);
    }
    if(globalData.categories.length === 0) {
        for(let i=0; i<itemsPerPage; i++) globalData.categories.push(null);
    }
  }

function syncToLocalStorage(data) {
  const order = [];
  
  if (!data.categories) return; // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨

  data.categories.forEach(cat => {
    if(cat) {
      order.push(cat.id);
      const access = cat.access || { visible: true, adminOnly: false, showSidebar: true };
      localStorage.setItem(`kac_style_${cat.id}`, JSON.stringify({ name: cat.name, code: cat.code, color: cat.color, access: access }));
      
      // [í•µì‹¬ ìˆ˜ì •] cat.menusê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´([])ì„ ì‚¬ìš©í•˜ë„ë¡ (|| []) ì¶”ê°€
      const safeMenus = cat.menus || []; 

      const menuList = safeMenus.map(m => ({ 
          dataId: m.id, 
          label: m.label, 
          line1: m.line1, 
          line2: m.line2, 
          link: m.link,
          visible: (m.visible !== undefined) ? m.visible : true
      }));
      localStorage.setItem(`kac_menu_${cat.id}`, JSON.stringify(menuList));
      
      // ì—¬ê¸°ë„ safeMenus ì‚¬ìš©
      safeMenus.forEach(m => { 
          if(m.subjects) {
              localStorage.setItem(`kac_subs_${cat.id}_${m.id}`, JSON.stringify(m.subjects)); 
          }
      });
    } else {
      order.push(null);
    }
  });
  localStorage.setItem('kac_index_order', JSON.stringify(order));
  
  if(data.config) {
      localStorage.setItem('kac_idx_icon_size', data.config.iconSize);
      localStorage.setItem('kac_idx_label_size', data.config.labelSize);
      if(data.config.pageTitles) {
          localStorage.setItem('kac_page_titles', JSON.stringify(data.config.pageTitles));
      }
      if(data.config.footerText) {
          localStorage.setItem('kac_full_footer', data.config.footerText);
      }
      if(data.config.contentTop) {
          localStorage.setItem('kac_content_top', data.config.contentTop);
      }
  }
}

  function applyConfig(cfg) {
    if(!cfg) return;
    document.documentElement.style.setProperty('--icon-size-idx', (cfg.iconSize||60)+'px');
    document.documentElement.style.setProperty('--label-size-idx', (cfg.labelSize||24)+'px');
  }

  /* ì‚¬ì´ë“œë°” ë¡œì§ */
  function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      const ov = document.getElementById('sidebarOverlay');
      sb.classList.toggle('active');
      ov.classList.toggle('active');
  }

function renderSidebar() {
      const content = document.getElementById('sidebarContent');
      content.innerHTML = '';
      
      const cats = globalData.categories.filter(c => {
          if (c === null) return false;
          const acc = c.access || { visible: true, adminOnly: false, showSidebar: true };
          
          // [ìˆ˜ì • 1] ì¹´í…Œê³ ë¦¬ í•„í„°ë§
          // ë¹„ê³µê°œ(visible:false)ê±°ë‚˜ ì‚¬ì´ë“œë°” ë¯¸ë…¸ì¶œ(showSidebar:false)ì´ë©´ ê´€ë¦¬ì ì—¬ë¶€ ìƒê´€ì—†ì´ ì œì™¸
          if (!acc.visible || !acc.showSidebar) return false;
          
          // ê´€ë¦¬ì ì „ìš©(adminOnly)ì¸ë° ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ì œì™¸
          if (acc.adminOnly && !isAdmin) return false;
          
          return true;
      });

      if(cats.length === 0) {
          content.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;">ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
          cats.forEach((cat, cIdx) => {
              const acc = cat.access || { visible: true, adminOnly: false, showSidebar: true };
              
              // ê´€ë¦¬ì ì „ìš©ì¼ ë•Œë§Œ í‘œì‹œí•  ì ‘ë‘ì–´ (ë¹„ê³µê°œëŠ” ìœ„ì—ì„œ ê±¸ëŸ¬ì§€ë¯€ë¡œ ë¡œì§ ì‚­ì œ)
              let namePrefix = "";
              if (isAdmin && acc.adminOnly) namePrefix = "(ê´€ë¦¬ì) ";
              
              const item = document.createElement('div');
              
              let subHtml = '';
              if(cat.menus && cat.menus.length > 0) {
                  subHtml = `<div class="sb-sub-list" id="sb-sub-${cat.id}">`;
                  cat.menus.forEach(m => {
                      // [ìˆ˜ì • 2] í•˜ìœ„ ë©”ë‰´ í•„í„°ë§
                      // ë©”ë‰´ê°€ ê³µê°œ(visible:true)ì¸ ê²½ìš°ì—ë§Œ ë Œë”ë§ (ê´€ë¦¬ìë„ ë¹„ê³µê°œ ë©”ë‰´ëŠ” ì•ˆ ë³´ì„)
                      const isMenuVisible = (m.visible !== undefined) ? m.visible : true;
                      
                      if(isMenuVisible) {
                          subHtml += `<div class="sb-sub-item" onclick="location.href='viewer_list.html?type=${cat.id}&menu=${encodeURIComponent(m.label)}&id=${m.id}'">
                              ${m.label}
                          </div>`;
                      }
                  });
                  subHtml += `</div>`;
              }

              item.innerHTML = `
                <div class="sb-item" onclick="toggleSubMenu('${cat.id}', this)">
                    <span style="display:flex;align-items:center;gap:10px;">
                        <span style="width:10px;height:10px;border-radius:50%;background:${cat.color}"></span>
                        ${namePrefix}${cat.name}
                    </span>
                    <span class="sb-toggle">â–¶</span>
                </div>
                ${subHtml}
              `;
              content.appendChild(item);
          });
      }

      // [ìˆ˜ì • 6] ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ë§¨ ì•„ë˜ì— 'ì„¤ì •' ë²„íŠ¼ ì¶”ê°€
      const settingsItem = document.createElement('div');
      settingsItem.className = 'sb-item';
      settingsItem.style.marginTop = '20px';
      settingsItem.style.borderTop = '1px solid var(--btn-border)';
      settingsItem.innerHTML = `
        <span style="display:flex;align-items:center;gap:10px;" onclick="openSettings(); toggleSidebar();">
            âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •
        </span>
      `;
      content.appendChild(settingsItem);
  }

  function toggleSubMenu(id, element) {
      const el = document.getElementById(`sb-sub-${id}`);
      if(el) {
          if (el.classList.contains('open')) {
              el.classList.remove('open');
              element.querySelector('.sb-toggle').textContent = 'â–¶';
          } else {
              el.classList.add('open');
              element.querySelector('.sb-toggle').textContent = 'â–¼';
          }
      }
  }

  /* í˜ì´ì§€ í—¤ë“œë¼ì¸ ë¡œì§ */
  function updateHeadline() {
      const el = document.getElementById('pageHeadline');
      const titles = globalData.config.pageTitles || {};
      const t = titles[currentPage] || "";
      el.textContent = t;
      document.getElementById('pageBadge').textContent = `Page ${currentPage}`;
      if(isAdmin && t === "") {
         el.textContent = "ì œëª© ì—†ìŒ (í´ë¦­ ìˆ˜ì •)";
         el.style.opacity = "0.5";
      } else {
         el.style.opacity = "1";
      }
  }

  function editPageTitle() {
      if(!isAdmin) return;
      const titles = globalData.config.pageTitles || {};
      const oldVal = titles[currentPage] || "";
      const newVal = prompt(`[${currentPage}í˜ì´ì§€] ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:`, oldVal);
      if(newVal !== null) {
          titles[currentPage] = newVal;
          globalData.config.pageTitles = titles;
          syncToLocalStorage(globalData);
          updateHeadline();
      }
  }

  /* ë©”ì¸ ì¹´ë“œ ë Œë”ë§ */
  function renderCards(animate = true) {
    const containerWrapper = document.getElementById('cardContainer');
    const pagination = document.getElementById('pagination');
    
    // [ìˆ˜ì • 5] ëª¨ë°”ì¼ì¸ì§€ ì²´í¬ (768px ì´í•˜)
    const isMobile = window.innerWidth <= 768;

    if(animate) {
        containerWrapper.style.opacity = '0';
        containerWrapper.style.transform = 'translateY(10px)';
        setTimeout(() => {
            performRender(isMobile);
            containerWrapper.style.opacity = '1';
            containerWrapper.style.transform = 'translateY(0)';
        }, 300);
    } else {
        performRender(isMobile);
    }

    function performRender(isMobileMode) {
        containerWrapper.innerHTML = ''; 
        pagination.innerHTML = '';

        let renderList = [];
        
        if (isAdmin) {
            renderList = globalData.categories;
        } else {
            renderList = globalData.categories.filter(cat => {
                if(!cat) return false;
                const acc = cat.access || { visible: true, adminOnly: false, showSidebar: true };
                if(!acc.visible || acc.adminOnly) return false;
                return true;
            });
        }

        // [ìˆ˜ì • 5] ëª¨ë°”ì¼ì¼ ê²½ìš° ì „ì²´ ëª©ë¡ì„ í•„í„°ë§í•˜ì—¬ ì¶œë ¥ (í˜ì´ì§€ë„¤ì´ì…˜ ë¬´ì‹œ)
        if(isMobileMode) {
            const mobileList = renderList.filter(item => item !== null); // ë¹ˆì¹¸ ì œì™¸
            mobileList.forEach((cat, i) => {
                // ì›ë˜ globalDataì—ì„œì˜ ì¸ë±ìŠ¤ë¥¼ ì°¾ì•„ì•¼ ìˆ˜ì •/ì‚­ì œê°€ ì •í™•í•¨
                const originalIdx = globalData.categories.indexOf(cat);
                createAndAppendCard(cat, originalIdx, true); 
            });
            // ëª¨ë°”ì¼ì—ì„œëŠ” í˜ì´ì§€ë„¤ì´ì…˜ ì ì„ ìƒì„±í•˜ì§€ ì•ŠìŒ
            return; 
        }

        // PC ëª¨ë“œ: ê¸°ì¡´ í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§ ìœ ì§€
        const totalPages = Math.ceil(renderList.length / itemsPerPage) || 1;
        if(currentPage > totalPages) currentPage = 1; 
        const startIdx = (currentPage - 1) * itemsPerPage;
        const pageItems = renderList.slice(startIdx, startIdx + itemsPerPage);

        pageItems.forEach((cat, i) => {
          let globalIdx = -1;
          if(isAdmin) {
             globalIdx = startIdx + i;
          }
          createAndAppendCard(cat, globalIdx, false);
        });

        // í˜ì´ì§€ë„¤ì´ì…˜ ì  ìƒì„± (PCë§Œ)
        for(let i=1; i<=totalPages; i++) {
            const dot = document.createElement('div');
            dot.className = `page-dot ${i === currentPage ? 'active' : ''}`;
            dot.onclick = () => { 
                if(i === currentPage) return;
                currentPage = i; 
                renderCards(true); 
            };
            pagination.appendChild(dot);
        }
        
        if(isAdmin && !isPreview) {
            const addPageBtn = document.createElement('div');
            addPageBtn.className = 'page-dot';
            addPageBtn.style.background = 'transparent';
            addPageBtn.style.border = '1px solid #cbd5e1';
            addPageBtn.innerText = '+';
            addPageBtn.style.textAlign = 'center';
            addPageBtn.style.lineHeight = '10px';
            addPageBtn.onclick = () => {
                for(let k=0; k<itemsPerPage; k++) globalData.categories.push(null);
                currentPage = Math.ceil(globalData.categories.length / itemsPerPage);
                renderCards(true);
            };
            pagination.appendChild(addPageBtn);
        }
        updateHeadline();
    }

    // ì¹´ë“œ ìƒì„± í—¬í¼ í•¨ìˆ˜
    function createAndAppendCard(cat, idx, isMobileRender) {
        if(cat) { 
            const acc = cat.access || { visible: true, adminOnly: false, showSidebar: true };
            const isHidden = !acc.visible;
            const isAdminOnly = acc.adminOnly;
            
            const card = document.createElement('div');
            card.className = 'card';
            card.style.setProperty('--card-color', cat.color);
            card.onclick = () => location.href = `facility.html?type=${cat.id}`;
            
            if (isAdmin && (isHidden || isAdminOnly)) {
                card.classList.add('restricted-view');
            }

            if(isAdmin && !isPreview && !isMobileRender) { // ëª¨ë°”ì¼ì—ì„œëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë“± ë³µì¡í•œê±° ì œì™¸í•˜ê±°ë‚˜ ë‹¨ìˆœí™”
              card.setAttribute('draggable', 'true');
              card.ondragstart = (e) => handleDragStart(e, idx);
              card.ondragover = (e) => handleDragOver(e);
              card.ondrop = (e) => handleDrop(e, idx);
              card.ondragend = (e) => handleDragEnd(e);
              
              let statusBadges = "";
              if(isHidden) statusBadges += "ğŸš«ë¹„ê³µê°œ ";
              if(isAdminOnly) statusBadges += "ğŸ”’ê´€ë¦¬ìì „ìš© ";

              card.innerHTML = `
                <div class="card-ctrl" onclick="event.stopPropagation()">
                  <button class="btn-sm" onclick="openEdit('${cat.id}')">ìˆ˜ì •</button>
                  <button class="btn-sm btn-move" onclick="openMovePageModal(${idx})">ì´ë™</button>
                  <button class="btn-sm btn-del" onclick="deleteCard('${idx}')">ì‚­ì œ</button>
                </div>
                <div class="icon-box">${cat.code}</div>
                <h2>${cat.name}</h2>
                ${statusBadges ? `<div style="position:absolute; bottom:15px; font-size:12px; color:red; font-weight:800; background:rgba(255,255,255,0.8); padding:2px 8px; border-radius:10px;">${statusBadges}</div>` : ''}
              `;
            } else {
                // ì¼ë°˜ ëª¨ë“œ ë˜ëŠ” ëª¨ë°”ì¼ ë·°
                card.innerHTML = `<div class="icon-box">${cat.code}</div><h2>${cat.name}</h2>`;
            }
            containerWrapper.appendChild(card);
        } else { 
            // ë¹ˆ ìŠ¬ë¡¯ (ëª¨ë°”ì¼ì—ì„œëŠ” ì•ˆë³´ì„, CSSë¡œ ì œì–´ë¨)
            const empty = document.createElement('div');
            empty.className = 'card add-slot';
            if(isAdmin && !isPreview && !isMobileRender) {
               empty.innerHTML = '<div style="font-size:40px;">+</div><div>ì¹´í…Œê³ ë¦¬ ì¶”ê°€</div>';
               empty.onclick = () => openEdit('NEW', idx);
               empty.ondragover = (e) => handleDragOver(e);
               empty.ondrop = (e) => handleDrop(e, idx);
            }
            containerWrapper.appendChild(empty);
        }
    }
  }

  // [ì¶”ê°€] ëª¨ë°”ì¼ìš© í…Œë§ˆ í† ê¸€ í•¨ìˆ˜
  function toggleThemeMobile() {
      const current = localStorage.getItem('kac_theme') || 'light';
      setTheme(current === 'light' ? 'dark' : 'light');
  }

  function handleDragStart(e, idx) { dragSrcIndex = idx; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
  function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
  function handleDrop(e, targetIdx) { e.stopPropagation(); if(dragSrcIndex !== null && dragSrcIndex !== targetIdx) { const srcItem = globalData.categories[dragSrcIndex]; const targetItem = globalData.categories[targetIdx]; globalData.categories[targetIdx] = srcItem; globalData.categories[dragSrcIndex] = targetItem; renderCards(false); } return false; }
  function handleDragEnd(e) { document.querySelectorAll('.card').forEach(c => c.classList.remove('dragging')); }

  function buildSearchIndex() {
    searchIndex = [];
    
    // globalDataë‚˜ categoriesê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì¢…ë£Œ (ì—ëŸ¬ ë°©ì§€)
    if (!globalData || !globalData.categories) return;

    globalData.categories.forEach(cat => {
      if(!cat) return;
      
      const acc = cat.access || { visible: true, adminOnly: false, showSidebar: true };
      if (!isAdmin) {
          if (!acc.visible || acc.adminOnly) return;
      }

      // [í•µì‹¬ ìˆ˜ì • 1] menusê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´([])ë¡œ ì²˜ë¦¬í•˜ì—¬ forEach ì—ëŸ¬ ë°©ì§€
      const safeMenus = cat.menus || [];

      safeMenus.forEach(menu => {
        // ë©”ë‰´ì˜ visible ì†ì„± ì²´í¬
        const isMenuVisible = (menu.visible !== undefined) ? menu.visible : true;
        if(!isAdmin && !isMenuVisible) return;

        // [í•µì‹¬ ìˆ˜ì • 2] subjectsê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´([])ë¡œ ì²˜ë¦¬
        const safeSubjects = menu.subjects || [];

        safeSubjects.forEach(sub => {
          searchIndex.push({
            name: sub.name, type: cat.id, code: cat.code, typeName: cat.name,
            menuName: menu.label, menuId: menu.id, subId: sub.id, color: cat.color, active: sub.active
          });
        });
      });
    });
  }
  const searchInput = document.getElementById('mainSearch');
  const searchRes = document.getElementById('searchResults');
  const sOverlay = document.getElementById('searchOverlay');

  searchInput.addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase().trim();
    if(!q) { searchRes.classList.remove('active'); return; }
    
    const matches = searchIndex.filter(i => i.name.toLowerCase().includes(q) || i.menuName.toLowerCase().includes(q));
    searchRes.innerHTML = matches.map(i => `
      <div class="result-item" onclick="location.href='viewer_list.html?type=${i.type}&menu=${encodeURIComponent(i.menuName)}&id=${i.menuId}&autoOpen=${i.subId}'">
        <div><div class="res-title">${i.name}</div><div class="res-path">${i.typeName} > ${i.menuName}</div></div>
        <div class="res-tag" style="background:${i.color}">${i.code}</div>
      </div>
    `).join('') || '<div style="padding:15px;text-align:center;">ê²°ê³¼ ì—†ìŒ</div>';
    
    searchRes.classList.add('active');
  });

  searchInput.onfocus = () => { sOverlay.classList.add('active'); if(searchInput.value) searchRes.classList.add('active'); };
  sOverlay.onclick = () => { sOverlay.classList.remove('active'); searchRes.classList.remove('active'); };

  function openSettings() {
    const gSet = document.getElementById('guestSettings');
    const aSet = document.getElementById('adminSettings');
    gSet.style.display = isAdmin ? 'none' : 'block';
    aSet.style.display = isAdmin ? 'block' : 'none';
    
    if(isAdmin) {
        document.getElementById('setIconSize').value = globalData.config.iconSize || 60;
        document.getElementById('setLabelSize').value = globalData.config.labelSize || 24;
        document.getElementById('setContentTop').value = localStorage.getItem('kac_content_top') || 135; 

        const pBtn = document.getElementById('modalPreviewBtn');
        pBtn.textContent = isPreview ? "ë¯¸ë¦¬ë³´ê¸° ì¢…ë£Œ" : "ë¯¸ë¦¬ë³´ê¸° ì‹œì‘";
        pBtn.classList.toggle('btn-preview-active', isPreview);
    }
    document.getElementById('settingsModal').style.display='flex';
  }

  function saveUISettings() {
    const is = document.getElementById('setIconSize').value;
    const ls = document.getElementById('setLabelSize').value;
    const ct = document.getElementById('setContentTop').value; 

    globalData.config.iconSize = parseInt(is);
    globalData.config.labelSize = parseInt(ls);
    globalData.config.contentTop = parseInt(ct);

    applyConfig(globalData.config);
    
    localStorage.setItem('kac_idx_icon_size', globalData.config.iconSize);
    localStorage.setItem('kac_idx_label_size', globalData.config.labelSize);
    localStorage.setItem('kac_content_top', globalData.config.contentTop);
    
    document.querySelector('.content-wrapper').style.paddingTop = ct + 'px';
    document.getElementById('settingsModal').style.display='none';
  }

  function togglePreview() {
    isPreview = !isPreview;
    localStorage.setItem('kac_preview_active', isPreview ? '1' : '0');
    document.body.classList.toggle('preview-active', isPreview);
    document.getElementById('settingsModal').style.display='none';
    renderCards(false);
  }

  /* ì¢…í•© ê´€ë¦¬ì (Tree Editor) ë¡œì§ */
  function openIntegratedAdmin() {
    document.getElementById('settingsModal').style.display='none';
    document.getElementById('integratedAdminModal').style.display='flex';
    renderTree();
    document.getElementById('treeDetail').innerHTML = '<div style="display:flex; height:100%; align-items:center; justify-content:center; color:var(--text-sub);">í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
    currentTreeSelection = null;
  }

  function renderTree() {
      const root = document.getElementById('treeRoot');
      root.innerHTML = '';
      globalData.categories.forEach((cat, cIdx) => {
          if(!cat) return;
          const cDiv = createTreeNode(`ğŸ“‚ ${cat.name}`, 'cat', cIdx, null, null, true);
          root.appendChild(cDiv);
          const cChildren = document.createElement('div');
          cChildren.className = 't-children'; 
          cChildren.id = `child-cat-${cIdx}`;
          root.appendChild(cChildren);

          if(cat.menus) {
              cat.menus.forEach((menu, mIdx) => {
                  const mDiv = createTreeNode(`ğŸ“ ${menu.label}`, 'menu', cIdx, mIdx, null, true);
                  cChildren.appendChild(mDiv);
                  const mChildren = document.createElement('div');
                  mChildren.className = 't-children';
                  mChildren.id = `child-menu-${cIdx}-${mIdx}`;
                  cChildren.appendChild(mChildren);
                  if(menu.subjects) {
                      menu.subjects.forEach((subj, sIdx) => {
                          const sDiv = createTreeNode(`ğŸ“„ ${subj.name}`, 'subj', cIdx, mIdx, sIdx, false);
                          mChildren.appendChild(sDiv);
                      });
                  }
              });
          }
      });
  }

  function createTreeNode(label, type, cIdx, mIdx, sIdx, hasChildren) {
      const row = document.createElement('div');
      row.className = 't-node-row';
      const toggleBtn = document.createElement('div');
      toggleBtn.className = hasChildren ? 't-toggle-btn' : 't-toggle-btn empty';
      toggleBtn.textContent = hasChildren ? 'â–¶' : '';
      if(hasChildren) {
          toggleBtn.onclick = (e) => {
              e.stopPropagation();
              toggleNode(toggleBtn, type, cIdx, mIdx);
          };
      }
      const labelDiv = document.createElement('div');
      labelDiv.className = 't-label';
      labelDiv.textContent = label;
      labelDiv.onclick = (e) => {
          e.stopPropagation();
          selectTreeNode(type, cIdx, mIdx, sIdx, labelDiv);
      };
      row.appendChild(toggleBtn);
      row.appendChild(labelDiv);
      return row;
  }

  function toggleNode(btn, type, cIdx, mIdx) {
      let targetId = '';
      if(type === 'cat') targetId = `child-cat-${cIdx}`;
      else if(type === 'menu') targetId = `child-menu-${cIdx}-${mIdx}`;
      const target = document.getElementById(targetId);
      if(target) {
          if(target.classList.contains('open')) {
              target.classList.remove('open');
              btn.textContent = 'â–¶';
          } else {
              target.classList.add('open');
              btn.textContent = 'â–¼';
          }
      }
  }

  function selectTreeNode(type, cIdx, mIdx, sIdx, element) {
      document.querySelectorAll('.t-label').forEach(n => n.classList.remove('selected'));
      element.classList.add('selected');
      currentTreeSelection = { type, cIdx, mIdx, sIdx };
      const content = document.getElementById('treeDetail');
      const cat = globalData.categories[cIdx];

      if(type === 'cat') {
          content.innerHTML = `
            <h3>ğŸ—‚ï¸ ì¹´í…Œê³ ë¦¬ ìˆ˜ì •</h3>
            <div class="setting-group"><label class="setting-label">ëª…ì¹­</label><input type="text" id="tName" class="setting-input" value="${cat.name}"></div>
            <div class="setting-group"><label class="setting-label">ì½”ë“œ (ì˜ë¬¸ 1ì)</label><input type="text" id="tCode" class="setting-input" value="${cat.code}"></div>
            <div class="setting-group"><label class="setting-label">ìƒ‰ìƒ</label><input type="color" id="tColor" style="width:100%;height:40px;" value="${cat.color}"></div>
            <button class="btn-modal btn-success" onclick="addChildMenu()">+ í•˜ìœ„ ë©”ë‰´(Menu) ì¶”ê°€</button>
          `;
      } else if (type === 'menu') {
          const menu = globalData.categories[cIdx].menus[mIdx];
          content.innerHTML = `
            <h3>ğŸ“ ì‹œì„¤(ë©”ë‰´) ìˆ˜ì •</h3>
            <div class="setting-group"><label class="setting-label">ì‹œì„¤ ëª…ì¹­</label><input type="text" id="tLabel" class="setting-input" value="${menu.label}"></div>
            <div class="setting-group"><label class="setting-label">ì•„ì´ì½˜ 1ì¤„</label><input type="text" id="tLine1" class="setting-input" value="${menu.line1||''}"></div>
            <div class="setting-group"><label class="setting-label">ì•„ì´ì½˜ 2ì¤„</label><input type="text" id="tLine2" class="setting-input" value="${menu.line2||''}"></div>
            <div class="setting-group"><label class="setting-label">ì™¸ë¶€ ë§í¬</label><input type="text" id="tLink" class="setting-input" value="${menu.link||''}"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-modal btn-success" onclick="addChildSubject()">+ í•˜ìœ„ ê³¼ëª©(Subject) ì¶”ê°€</button>
                <button class="btn-modal btn-danger" onclick="deleteTreeNode()">ì‚­ì œ</button>
            </div>
          `;
      } else if (type === 'subj') {
          const subj = globalData.categories[cIdx].menus[mIdx].subjects[sIdx];
          content.innerHTML = `
            <h3>ğŸ“„ ê³¼ëª©(Subject) ìˆ˜ì •</h3>
            <div class="setting-group"><label class="setting-label">ê³¼ëª©ëª…</label><input type="text" id="sName" class="setting-input" value="${subj.name}"></div>
            <div class="setting-group"><label class="setting-label">í™œì„± ìƒíƒœ</label>
                <select id="sActive" class="setting-input">
                    <option value="true" ${subj.active !== false ? 'selected':''}>í™œì„±</option>
                    <option value="false" ${subj.active === false ? 'selected':''}>ë¹„í™œì„± (ê°œë°œì¤‘)</option>
                </select>
            </div>
            <div class="setting-group"><label class="setting-label">PDF ê²½ë¡œ</label><input type="text" id="sPdf" class="setting-input" value="${subj.pdfName||''}"></div>
            <div class="setting-group"><label class="setting-label">ë§í¬ ì£¼ì†Œ</label><input type="text" id="sLink" class="setting-input" value="${subj.link||''}"></div>
            <div class="setting-group"><label class="setting-label">ì˜¤ë””ì˜¤ ê²½ë¡œ</label><input type="text" id="sAudio" class="setting-input" value="${subj.audioName||''}"></div>
            <button class="btn-modal btn-danger" onclick="deleteTreeNode()">ì‚­ì œ</button>
          `;
      }
  }
  
  function addChildMenu() {
      if(!currentTreeSelection || currentTreeSelection.type !== 'cat') return;
      const cat = globalData.categories[currentTreeSelection.cIdx];
      const newMenu = { id: 'id_'+Date.now(), label: 'ìƒˆ ë©”ë‰´', line1: '', line2: '', link: '', subjects: [] };
      if(!cat.menus) cat.menus = [];
      cat.menus.push(newMenu);
      renderTree();
      alert("ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
  
  function addChildSubject() {
      if(!currentTreeSelection || currentTreeSelection.type !== 'menu') return;
      const menu = globalData.categories[currentTreeSelection.cIdx].menus[currentTreeSelection.mIdx];
      const newSubj = { id: Date.now().toString(), name: 'ìƒˆ ê³¼ëª©', active: true, pdfName: '', link: '', audioName: '' };
      if(!menu.subjects) menu.subjects = [];
      menu.subjects.push(newSubj);
      renderTree();
      alert("ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
  
  function deleteTreeNode() {
      if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      const { type, cIdx, mIdx, sIdx } = currentTreeSelection;
      if(type === 'menu') {
          globalData.categories[cIdx].menus.splice(mIdx, 1);
      } else if (type === 'subj') {
          globalData.categories[cIdx].menus[mIdx].subjects.splice(sIdx, 1);
      }
      renderTree();
      document.getElementById('treeDetail').innerHTML = '<div style="display:flex; height:100%; align-items:center; justify-content:center; color:var(--text-sub);">ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
      currentTreeSelection = null;
  }

  function saveIntegratedData() {
      if(!currentTreeSelection) return alert("ìˆ˜ì •í•  í•­ëª©ì´ ì—†ê±°ë‚˜ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      const { type, cIdx, mIdx, sIdx } = currentTreeSelection;
      
      if(type === 'cat') {
          const cat = globalData.categories[cIdx];
          cat.name = document.getElementById('tName').value;
          cat.code = document.getElementById('tCode').value;
          cat.color = document.getElementById('tColor').value;
      } else if (type === 'menu') {
          const menu = globalData.categories[cIdx].menus[mIdx];
          menu.label = document.getElementById('tLabel').value;
          menu.line1 = document.getElementById('tLine1').value;
          menu.line2 = document.getElementById('tLine2').value;
          menu.link = document.getElementById('tLink').value;
      } else if (type === 'subj') {
          const subj = globalData.categories[cIdx].menus[mIdx].subjects[sIdx];
          subj.name = document.getElementById('sName').value;
          subj.active = document.getElementById('sActive').value === 'true';
          subj.pdfName = document.getElementById('sPdf').value;
          subj.link = document.getElementById('sLink').value;
          subj.audioName = document.getElementById('sAudio').value;
      }
      syncToLocalStorage(globalData);
      renderCards(false);
      renderSidebar();
      renderTree(); 
      alert("âœ… ì €ì¥ ë° ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }


  async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // [ìˆ˜ì • 2] ê´€ë¦¬ì ë¡œê·¸ì¸ (Firebase DB ë¹„ë°€ë²ˆí˜¸ ëŒ€ì¡°)
  async function toggleAdmin() {
    if(isAdmin) {
      if(confirm("ê´€ë¦¬ì ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.setItem('kac_admin_mode','0');
        location.reload();
      }
    } else {
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      if(!pw) return;

      try {
          // ì…ë ¥ë°›ì€ ë¹„ë²ˆ ì•”í˜¸í™”
          const inputHash = await sha256(pw.toUpperCase());
          
          // Firebaseì—ì„œ ê´€ë¦¬ì ë¹„ë²ˆ ê°€ì ¸ì˜¤ê¸°
          const snapshot = await db.ref('security/admin_pw').once('value');
          let serverHash = snapshot.val();
          
          // ì„œë²„ì— ë¹„ë²ˆ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’(ì´ˆê¸°ê°’) ì‚¬ìš© (CATC1234 í•´ì‹œ)
          if(!serverHash) serverHash = "db2d3257df630ebeb488b0a9435b863702a0a25694205626359045b8427f311c";

          if(inputHash === serverHash) {
              alert("ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.");
              localStorage.setItem('kac_admin_mode','1');
              location.reload();
          } else {
              alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
      } catch(e) {
          console.error(e);
          alert("ì¸ì¦ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì¸í„°ë„· ì—°ê²° í™•ì¸)");
      }
    }
  }

  function openGithubModal() {
    document.getElementById('ghOwner').value = localStorage.getItem('kac_gh_owner') || '';
    document.getElementById('ghRepo').value = localStorage.getItem('kac_gh_repo') || '';
    document.getElementById('ghToken').value = localStorage.getItem('kac_gh_token') || '';
    document.getElementById('settingsModal').style.display = 'none';
    document.getElementById('githubModal').style.display = 'flex';
  }

  async function uploadToGithub() {
    const owner = document.getElementById('ghOwner').value.trim();
    const repo = document.getElementById('ghRepo').value.trim();
    const token = document.getElementById('ghToken').value.trim();
    const path = "data.json"; 
    const branch = "main"; 

    if(!owner || !repo || !token) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    localStorage.setItem('kac_gh_owner', owner);
    localStorage.setItem('kac_gh_repo', repo);
    localStorage.setItem('kac_gh_token', token);

    const btn = document.getElementById('btnGhUpload');
    const originalText = btn.textContent;
    btn.textContent = "ì—…ë¡œë“œ ì¤‘...";
    btn.disabled = true;

    try {
        reconstructGlobalDataFromLocal();
        globalData.meta.lastUpdated = new Date().toISOString().split('T')[0];
        const jsonString = JSON.stringify(globalData, null, 2);
        const contentBase64 = btoa(unescape(encodeURIComponent(jsonString)));

        const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
        let sha = "";
        const getRes = await fetch(getUrl, {
            method: "GET",
            headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" }
        });
        if (getRes.ok) {
            const getData = await getRes.json();
            sha = getData.sha;
        }

        const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const bodyData = {
            message: `Update data.json via Web (${new Date().toLocaleString()})`,
            content: contentBase64,
            branch: branch
        };
        if (sha) bodyData.sha = sha;

        const putRes = await fetch(putUrl, {
            method: "PUT",
            headers: {
                "Authorization": `token ${token}`,
                "Accept": "application/vnd.github.v3+json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(bodyData)
        });

        if (putRes.ok) {
            alert("âœ… ì„±ê³µì ìœ¼ë¡œ GitHubì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì ì‹œ í›„(ì•½ 1~3ë¶„) í˜ì´ì§€ì— ë°˜ì˜ë©ë‹ˆë‹¤.");
            document.getElementById('githubModal').style.display = 'none';
        } else {
            const errData = await putRes.json();
            throw new Error(errData.message);
        }
    } catch (e) {
        alert("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
        console.error(e);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
  }

  function openPwChangeModal() {
      document.getElementById('settingsModal').style.display='none';
      document.getElementById('pwChangeModal').style.display='flex';
      document.getElementById('newPw').value = '';
  }

  async function executePwChange() {
      const target = document.getElementById('pwTarget').value;
      const newPw = document.getElementById('newPw').value.trim().toUpperCase();
      if(!newPw) return alert("ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      const confirmPw = prompt(`[${target==='entry'?'êµìœ¡ìƒ':'ê´€ë¦¬ì'} ë¹„ë°€ë²ˆí˜¸]ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì¸ì„ ìœ„í•´ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
      if(newPw !== confirmPw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

      const newHash = await sha256(newPw);
      if(target === 'entry') globalData.security.entry_pw = newHash;
      else globalData.security.admin_pw = newHash;

      document.getElementById('pwChangeModal').style.display='none';
      alert("âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ì£¼ì˜: [ë³€ê²½ì‚¬í•­ ì €ì¥] ë˜ëŠ” [GitHub ì—…ë¡œë“œ]ë¥¼ ëˆŒëŸ¬ì•¼ ì™„ì „íˆ ì ìš©ë©ë‹ˆë‹¤!");
      openSettings(); 
  }

  let tempSlotIdx = -1;
  function openEdit(id, slotIdx = -1) {
    editingCardId = id;
    tempSlotIdx = slotIdx;
    
    if(id === 'NEW') {
      document.getElementById('editName').value = '';
      document.getElementById('editCode').value = '';
      document.getElementById('editColor').value = '#2563eb';
      // ì‹ ê·œ ìƒì„± ì‹œ ê¸°ë³¸ê°’
      document.getElementById('chkVisible').checked = true;
      document.getElementById('chkAdminOnly').checked = false;
      document.getElementById('chkSidebar').checked = true;
    } else {
      const t = globalData.categories.find(c => c && c.id === id);
      document.getElementById('editName').value = t.name;
      document.getElementById('editCode').value = t.code;
      document.getElementById('editColor').value = t.color;
      
      const acc = t.access || { visible: true, adminOnly: false, showSidebar: true };
      document.getElementById('chkVisible').checked = acc.visible;
      document.getElementById('chkAdminOnly').checked = acc.adminOnly;
      document.getElementById('chkSidebar').checked = acc.showSidebar;
    }
    document.getElementById('cardEditModal').style.display='flex';
  }

  function saveCardEdit() {
    const name = document.getElementById('editName').value;
    const code = document.getElementById('editCode').value;
    const color = document.getElementById('editColor').value;
    
    // ì²´í¬ë°•ìŠ¤ ê°’ ì½ê¸°
    const access = {
        visible: document.getElementById('chkVisible').checked,
        adminOnly: document.getElementById('chkAdminOnly').checked,
        showSidebar: document.getElementById('chkSidebar').checked
    };

    if(editingCardId === 'NEW') {
      const newCat = { id: 'CAT_' + Date.now(), name, code, color, access, menus: [] };
      if(tempSlotIdx !== -1) { globalData.categories[tempSlotIdx] = newCat; } 
      else {
          const emptyIdx = globalData.categories.indexOf(null);
          if(emptyIdx !== -1) globalData.categories[emptyIdx] = newCat;
          else globalData.categories.push(newCat);
      }
    } else {
      const t = globalData.categories.find(c => c && c.id === editingCardId);
      if(t) { 
          t.name = name; t.code = code; t.color = color; 
          t.access = access; // access ì—…ë°ì´íŠ¸
      }
    }
    syncToLocalStorage(globalData);
    renderCards(false);
    renderSidebar(); // ì‚¬ì´ë“œë°”ë„ ì—…ë°ì´íŠ¸
    document.getElementById('cardEditModal').style.display='none';
  }

  function openMovePageModal(idx) {
    moveSrcIndex = idx;
    const select = document.getElementById('moveTargetPage'); 
    select.innerHTML = '';
    const totalPages = Math.ceil(globalData.categories.length / itemsPerPage);
    for(let i=1; i<=totalPages; i++) {
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = `${i} í˜ì´ì§€ë¡œ ì´ë™`;
        select.appendChild(opt);
    }
    const newPageOpt = document.createElement('option');
    newPageOpt.value = 'NEW'; newPageOpt.textContent = "ìƒˆ í˜ì´ì§€ë¡œ ì´ë™ (ë§ˆì§€ë§‰)";
    select.appendChild(newPageOpt);
    document.getElementById('movePageModal').style.display='flex';
  }

  function executeMovePage() {
    const val = document.getElementById('moveTargetPage').value;
    const item = globalData.categories[moveSrcIndex];
    globalData.categories[moveSrcIndex] = null;
    if(val === 'NEW') {
        const currentLen = globalData.categories.length;
        const newStart = Math.ceil(currentLen / itemsPerPage) * itemsPerPage;
        for(let i=currentLen; i<newStart; i++) globalData.categories.push(null);
        globalData.categories.push(item);
        for(let i=0; i<itemsPerPage-1; i++) globalData.categories.push(null);
    } else {
        const page = parseInt(val);
        const startIdx = (page-1) * itemsPerPage;
        const endIdx = startIdx + itemsPerPage;
        let foundEmpty = -1;
        for(let i=startIdx; i<endIdx; i++) {
            if(globalData.categories[i] === null) { foundEmpty = i; break; }
        }
        if(foundEmpty !== -1) globalData.categories[foundEmpty] = item;
        else { alert("í•´ë‹¹ í˜ì´ì§€ì— ë¹ˆ ê³µê°„ì´ ì—†ìŠµë‹ˆë‹¤."); globalData.categories[moveSrcIndex] = item; return; }
    }
    document.getElementById('movePageModal').style.display='none';
    renderCards(false);
    syncToLocalStorage(globalData);
  }

  function deleteCard(idx) {
    if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í•˜ìœ„ ë©”ë‰´ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)")) {
      globalData.categories[idx] = null; 
      syncToLocalStorage(globalData);
      renderCards(false);
      renderSidebar();
    }
  }

  function exportJsonData() {
    reconstructGlobalDataFromLocal();
    globalData.meta.lastUpdated = new Date().toISOString().split('T')[0];
    const str = JSON.stringify(globalData, null, 2);
    const blob = new Blob([str], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "data.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    alert("data.json íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nì„œë²„/í´ë”ì˜ ê¸°ì¡´ íŒŒì¼ì„ ë®ì–´ì“°ê¸° í•´ì£¼ì„¸ìš”.");
  }

  function setTheme(m) { document.body.className = m==='dark'?'dark-mode':''; localStorage.setItem('kac_theme', m); document.getElementById('btnDay').classList.toggle('active', m==='light'); document.getElementById('btnNight').classList.toggle('active', m==='dark'); }

  init();
// [ìˆ˜ì • 3] íŒŒì´ì–´ë² ì´ìŠ¤ ì €ì¥ í•¨ìˆ˜
async function saveToFirebase() {
    if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
    if(!confirm("âš ï¸ ì£¼ì˜: í˜„ì¬ í™”ë©´ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì„œë²„ì— ë®ì–´ì”ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const btn = document.querySelector('.btn-success'); // ì €ì¥ ë²„íŠ¼ ì°¾ê¸°
    const originalText = btn ? btn.innerText : "";
    if(btn) btn.innerText = "ì €ì¥ ì¤‘...";

    try {
        // í˜„ì¬ ë¡œì»¬ì˜ ìµœì‹  ìƒíƒœë¥¼ globalDataë¡œ ì¬êµ¬ì„±
        reconstructGlobalDataFromLocal();
        
        // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
        globalData.meta = globalData.meta || {};
        globalData.meta.lastUpdated = new Date().toISOString();

        // íŒŒì´ì–´ë² ì´ìŠ¤ì— ë®ì–´ì“°ê¸°
        await db.ref('/').set(globalData);
        
        alert("âœ… ì„œë²„ ì €ì¥ ì™„ë£Œ!\nì´ì œ ë‹¤ë¥¸ ì‚¬ëŒë„ ë³€ê²½ëœ ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    } catch(e) {
        console.error(e);
        alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message);
    } finally {
        if(btn) btn.innerText = originalText;
    }
}

</script>
</body>
</html>