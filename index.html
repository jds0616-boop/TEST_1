<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>KAC CNS Training Platform</title>
<!-- Firebase ì—”ì§„(ë¼ì´ë¸ŒëŸ¬ë¦¬) ë¶ˆëŸ¬ì˜¤ê¸° -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
  // ì„œë²„ ì ‘ì† ì£¼ì†Œ ì„¤ì •
  const firebaseConfig = {
    apiKey: "AIzaSyAUt6WqxWjRoB9xgAWXq2YhVMQutaOZCBc",
    authDomain: "catc-dfb9a.firebaseapp.com",
    databaseURL: "https://catc-dfb9a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "catc-dfb9a",
    storageBucket: "catc-dfb9a.firebasestorage.app",
    messagingSenderId: "669905270724",
    appId: "1:669905270724:web:c89fcc1d9c8f81b3071691",
    measurementId: "G-H1ME51B4MZ"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
<script>
  if(sessionStorage.getItem('kac_access_token') !== 'granted') {
    location.replace('login.html');
  }
</script>
<style>
  @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
  
  :root { 
    --navy: #0f172a; --bg-main: #f0f4f8; --bg-card: #ffffff; 
    --text-main: #000000; --text-sub: #334155;
    --border-card: 2px solid transparent; 
    --shadow: 0 10px 25px rgba(0,0,0,0.05);
    --btn-bg: #f8fafc; --btn-border: #e2e8f0; --btn-text: #64748b;
    --header-h: 75px;
    --search-border: #cbd5e1;
    --search-shadow: 0 8px 30px rgba(15, 23, 42, 0.12);
    --icon-size-idx: 60px;
    --label-size-idx: 24px;
  }

  body.dark-mode {
    --navy: #020617; --bg-main: #0f172a; --bg-card: #1e293b; 
    --text-main: #f1f5f9; --text-sub: #cbd5e1;
    --border-card: 2px solid rgba(255,255,255,0.1); 
    --shadow: 0 10px 30px rgba(0,0,0,0.5);
    --btn-bg: rgba(255,255,255,0.05); --btn-border: rgba(255,255,255,0.2); --btn-text: #e2e8f0;
    --search-border: rgba(255,255,255,0.1);
    --search-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
  html, body { width: 100%; height: 100%; overflow: hidden; }
  body { background: var(--bg-main); display: flex; flex-direction: column; color: var(--text-main); transition: background 0.3s, color 0.3s; }

  /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: none !important; align-items: center; justify-content: center; }
  .modal-overlay[style*="display: flex"] { display: flex !important; }
  .modal-card { background: var(--bg-card); padding: 35px; border-radius: 25px; width: 450px; color: var(--text-main); box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
  .modal-card.large { width: 1000px; max-width: 95%; height: 85vh; }
  .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; border-bottom: 1px solid var(--btn-border); padding-bottom: 10px; }

  /* í—¤ë” ìŠ¤íƒ€ì¼ */
  header { height: var(--header-h); background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 5000; position: fixed; top: 0; left: 0; width: 100%; }
  .header-left { display: flex; align-items: center; gap: 15px; z-index: 10; min-width: 0; flex-shrink: 1; }
  .hamburger-btn { cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; flex-shrink: 0; }
  .hamburger-btn:hover { background: rgba(255,255,255,0.1); }
  .hamburger-btn svg { width: 24px; height: 24px; fill: #fff; }
  .logo-text { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .header-center-title { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 5; white-space: nowrap; }
  .page-headline { font-size: 24px; font-weight: 800; color: #fff; letter-spacing: -0.5px; cursor: default; }
  body.admin-mode .page-headline { cursor: pointer; opacity: 0.9; }
  .page-badge { font-size: 12px; font-weight: 800; color: #0f172a; background: #38bdf8; padding: 4px 10px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .header-right { display: flex; align-items: center; gap: 15px; z-index: 10; flex-shrink: 0; }
  .theme-toggle { display: flex; gap: 5px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); margin-right: 10px; }
  .theme-btn { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; opacity: 0.5; }
  .theme-btn.active { background: #fff; opacity: 1; color: var(--navy); }
  .theme-btn svg { width: 16px; height: 16px; fill: currentColor; }
  .kac-logo-img { height: 30px; width: auto; display: block; object-fit: contain; }
  .settings-btn { display: flex; padding: 8px; width: 34px; height: 34px; border-radius: 100px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: 0.3s; color: #cbd5e1; }

  /* ì‚¬ì´ë“œë°” */
  .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 6000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
  .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
  .sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100vh; background: var(--bg-card); z-index: 6001; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 5px 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; border-right: 1px solid var(--btn-border); }
  .sidebar.active { left: 0; }
  .sidebar-header { height: var(--header-h); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--btn-border); font-weight: 800; font-size: 18px; justify-content: space-between; color: var(--text-main); }
  .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
  .sb-item { padding: 12px 15px; cursor: pointer; border-radius: 10px; color: var(--text-main); font-weight: 600; display: flex; align-items: center; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
  .sb-item:hover { background: var(--btn-bg); color: #2563eb; }
  .sb-sub-list { display: none; padding-left: 20px; margin-bottom: 5px; }
  .sb-sub-list.open { display: block; animation: slideDown 0.2s; }
  .sb-sub-item { padding: 8px 15px; font-size: 13px; color: var(--text-sub); cursor: pointer; border-left: 2px solid var(--btn-border); transition: 0.2s; }
  .sb-sub-item:hover { border-left-color: #2563eb; color: #2563eb; background: rgba(37,99,235,0.05); }

  /* ê²€ìƒ‰ ë° ì¹´ë“œ ì˜ì—­ */
  .content-wrapper { width: 100%; height: 100%; padding-top: 135px; padding-bottom: 120px; overflow: hidden; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  .search-bar { width: 100%; padding: 18px 30px 18px 65px; border-radius: 50px; border: 2px solid #cbd5e1; background: #fff; color: #000; font-size: 16px; font-weight: 600; box-shadow: 0 8px 30px rgba(15, 23, 42, 0.12); transition: 0.3s; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 25px center; background-size: 24px; }
  .search-results { position: absolute; top: calc(100% + 15px); left: 0; right: 0; background: var(--bg-card); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; max-height: 400px; overflow-y: auto; z-index: 2001; }
  .search-results.active { display: block; }
  
  #cardContainer { display: flex; flex-wrap: wrap; gap: 30px; width: 100%; justify-content: center; padding: 20px; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s; }
  .card { background: var(--bg-card); width: 280px; height: 280px; padding: 30px 20px; border-radius: 25px; box-shadow: var(--shadow); border: var(--border-card); cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-left: 10px solid transparent; color: var(--text-main); --card-color: #64748b; border-left-color: var(--card-color); }
  .card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px -5px var(--card-color); }
  .icon-box { width: 100px; height: 100px; border-radius: 30px; margin-bottom: 20px; font-weight: 900; display: flex; align-items: center; justify-content: center; background: var(--btn-bg); border: 1px solid var(--btn-border); font-size: var(--icon-size-idx, 60px); color: var(--card-color); }
  .card h2 { font-size: var(--label-size-idx, 24px); font-weight: 800; text-align: center; }

  /* í‘¸í„° ë° QR */
  .main-footer { width: 100%; height: auto; background: var(--navy); padding: 25px 30px; text-align: center; color: rgba(255,255,255,0.7); font-size: 13px; line-height: 1.6; border-top: 1px solid rgba(255,255,255,0.1); position: absolute; bottom: 0; left: 0; display: flex; align-items: center; justify-content: center; gap: 40px; z-index: 1000; }
  .qr-code-img { width: 65px; height: 65px; background: white; padding: 4px; border-radius: 10px; cursor: pointer; }
  .qr-zoom-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 10000; display: none; align-items: center; justify-content: center; flex-direction: column; cursor: zoom-out; backdrop-filter: blur(10px); }
  .qr-zoom-overlay img { width: 400px; height: 400px; background: white; padding: 20px; border-radius: 20px; }

  /* íŠ¸ë¦¬ ì—ë””í„° */
  .tree-container { display: flex; height: 500px; border: 1px solid var(--btn-border); border-radius: 10px; overflow: hidden; margin-top: 15px; }
  .tree-sidebar { width: 35%; background: var(--bg-main); border-right: 1px solid var(--btn-border); overflow-y: auto; padding: 10px; }
  .tree-content { width: 65%; padding: 20px; overflow-y: auto; background: var(--bg-card); }
  .t-node-row { display: flex; align-items: center; padding: 4px 0; }
  .t-toggle-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; }
  .t-label { padding: 6px 10px; cursor: pointer; border-radius: 6px; font-size: 13px; flex: 1; }
  .t-label.selected { background: #2563eb; color: #fff; }
  .t-children { display: none; padding-left: 18px; border-left: 1px solid var(--btn-border); margin-left: 11px; }
  .t-children.open { display: block; }

  #loadingSpinner { position: fixed; inset: 0; background: var(--bg-main); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
  .spinner { width: 50px; height: 50px; border: 5px solid #cbd5e1; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
  @keyframes spin { 100% { transform: rotate(360deg); } }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

  @media (max-width: 768px) {
    .logo-text { position: absolute; left: 50%; transform: translateX(-50%); font-size: 16px !important; }
    .content-wrapper { padding-top: 155px !important; }
    #cardContainer { flex-direction: column; }
    .card { width: 100%; height: auto; flex-direction: row; padding: 10px 12px; gap: 15px; min-height: 50px; }
    .icon-box { width: 36px; height: 36px; font-size: 18px; margin-bottom: 0; }
    .main-footer { position: fixed !important; bottom: 0; flex-direction: column; gap: 10px; }
  }
</style>
</head>
<body>

<div id="loadingSpinner"><div class="spinner"></div><div style="font-weight:700; color:#64748b;">ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</div></div>
<div id="searchOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1500; display:none; backdrop-filter:blur(2px);"></div>

<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="sidebar" class="sidebar">
  <div class="sidebar-header"><span>ì „ì²´ ë©”ë‰´</span><div style="cursor:pointer" onclick="toggleSidebar()">âœ•</div></div>
  <div class="sidebar-content" id="sidebarContent"></div>
</div>

<header>
  <div class="header-left">
    <div class="hamburger-btn" onclick="toggleSidebar()"><svg viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg></div>
    <div class="logo-text" onclick="location.reload()">KAC CNS Training Platform</div>
  </div>
  <div class="header-center-title"><span id="pageHeadline" class="page-headline" onclick="editPageTitle()"></span><span id="pageBadge" class="page-badge">Page 1</span></div>
  <div class="header-right">
    <div class="theme-toggle">
      <div class="theme-btn" id="btnDay" onclick="setTheme('light')">â˜€ï¸</div>
      <div class="theme-btn" id="btnNight" onclick="setTheme('dark')">ğŸŒ™</div>
    </div>
    <div class="settings-btn" onclick="openSettings()">âš™ï¸</div>
    <img src="logo.png" alt="KAC Logo" class="kac-logo-img">
  </div>
</header>

<div class="content-wrapper">
  <div class="center-content-box">
    <div class="search-wrapper-outer">
      <div class="search-container">
        <input type="text" id="mainSearch" class="search-bar" placeholder="ì‹œì„¤ëª… ë˜ëŠ” êµìœ¡ ì£¼ì œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”..." autocomplete="off">
        <div id="searchResults" class="search-results"></div>
      </div>
    </div>
    <div id="cardContainerWrapper"><main id="cardContainer"></main></div>
    <div id="pagination" class="pagination"></div>
  </div>
  <footer class="main-footer">
    <div class="footer-qr-wrapper"><img id="qrCodeImg" src="" alt="QR" class="qr-code-img" onclick="zoomQR(true)"></div>
    <div class="footer-content" id="footerContent"></div>
    <span style="cursor:pointer; font-size:11px; opacity:0.5;" onclick="openFooterEditModal()">ìˆ˜ì •</span>
  </footer>
</div>

<div id="qrZoomOverlay" class="qr-zoom-overlay" onclick="zoomQR(false)">
    <img id="qrZoomImg" src="" alt="QR">
    <div style="text-align:center; color:white; margin-top:20px;">
        <p style="font-size:18px; font-weight:800; color:#38bdf8;">QRì½”ë“œë¥¼ ì°ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì•ˆë‚´ë©ë‹ˆë‹¤.</p>
        <p style="margin-top:10px;">ë¬¸ì˜ : jds0616@airport.co.kr (ds.Jang)</p>
    </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</div>
    <div id="guestSettings"><button class="btn-modal" style="width:100%; padding:12px; background:#0f172a; color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer;" onclick="toggleAdmin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button></div>
    <div id="adminSettings" style="display:none;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
          <button class="btn-modal" style="flex:1; background:#ef4444; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;" onclick="toggleAdmin()">ë¡œê·¸ì•„ì›ƒ</button>
          <button class="btn-modal" style="flex:1; background:#10b981; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;" onclick="saveToFirebase()">â˜ï¸ ì„œë²„ ì €ì¥</button>
      </div>
      <button class="btn-modal" style="width:100%; background:#4f46e5; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; margin-bottom:10px;" onclick="openIntegratedAdmin()">ğŸ—‚ï¸ ì¢…í•© ê´€ë¦¬ (Tree Editor)</button>
    </div>
    <button class="btn-modal" style="width:100%; background:#64748b; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; margin-top:10px;" onclick="closeModal('settingsModal')">ë‹«ê¸°</button>
  </div>
</div>

<!-- í†µí•© ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="integratedAdminModal" class="modal-overlay">
  <div class="modal-card modal-card large">
    <div class="modal-title">ğŸ—‚ï¸ ì „ì²´ ë°ì´í„° ì¢…í•© ê´€ë¦¬</div>
    <div class="tree-container">
        <div class="tree-sidebar" id="treeRoot"></div>
        <div class="tree-content" id="treeDetail">í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</div>
    </div>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-modal" style="flex:1; background:#2563eb; color:white; border:none; padding:12px; border-radius:8px; font-weight:700; cursor:pointer;" onclick="saveIntegratedData()">ì €ì¥ ë° ì ìš©</button>
        <button class="btn-modal" style="flex:1; background:#64748b; color:white; border:none; padding:12px; border-radius:8px; font-weight:700; cursor:pointer;" onclick="closeModal('integratedAdminModal')">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- í•˜ë‹¨ë°” í…ìŠ¤íŠ¸ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="footerEditModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">ğŸ“ í•˜ë‹¨ ë¬¸êµ¬ ìˆ˜ì •</div>
    <textarea id="footerTextInput" style="width:100%; height:150px; padding:10px; border-radius:8px; border:1px solid #ddd;"></textarea>
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn-modal" style="flex:1; background:#2563eb; color:white; border:none; padding:12px; border-radius:8px; font-weight:700; cursor:pointer;" onclick="saveFooterText()">ì €ì¥</button>
        <button class="btn-modal" style="flex:1; background:#64748b; color:white; border:none; padding:12px; border-radius:8px; font-weight:700; cursor:pointer;" onclick="closeModal('footerEditModal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
  // --- ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™” ---
  function normalizeArray(v) { return Array.isArray(v) ? v : (v && typeof v === 'object' ? Object.values(v) : []); }
  let globalData = { categories: [], config: {}, security: {} };
  let isAdmin = localStorage.getItem('kac_admin_mode') === '1';
  let currentPage = 1, itemsPerPage = 5;
  let searchIndex = [], currentTreeSelection = null;

  async function ensureAnonAuth() {
    return new Promise((resolve) => {
      firebase.auth().onAuthStateChanged((user) => {
        if (user) resolve(); 
        else firebase.auth().signInAnonymously().catch(() => resolve());
      });
    });
  }

  // --- í•µì‹¬ í•¨ìˆ˜ êµ¬í˜„ (ë¬´í•œ ë¡œë”© ë°©ì§€) ---
  function applyConfig(cfg) {
    if(!cfg) return;
    if(cfg.iconSize) document.documentElement.style.setProperty('--icon-size-idx', cfg.iconSize + 'px');
    if(cfg.labelSize) document.documentElement.style.setProperty('--label-size-idx', cfg.labelSize + 'px');
    updateHeadline();
  }

  function updateHeadline() {
    const titles = globalData.config.pageTitles || {};
    document.getElementById('pageHeadline').textContent = titles[currentPage] || "í•­í–‰ì•ˆì „ì‹œì„¤ êµìœ¡ í”Œë«í¼";
    document.getElementById('pageBadge').textContent = `Page ${currentPage}`;
  }

  function editPageTitle() {
    if(!isAdmin) return;
    const newVal = prompt("í˜ì´ì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", document.getElementById('pageHeadline').textContent);
    if(newVal) {
        if(!globalData.config.pageTitles) globalData.config.pageTitles = {};
        globalData.config.pageTitles[currentPage] = newVal;
        updateHeadline();
    }
  }

  function ensurePageSlots() {
    if(!globalData.categories) globalData.categories = [];
    const count = globalData.categories.length;
    const needed = Math.ceil(count / itemsPerPage) * itemsPerPage || itemsPerPage;
    for(let i=count; i<needed; i++) globalData.categories.push(null);
  }

  function reconstructGlobalDataFromLocal() {
    const order = JSON.parse(localStorage.getItem('kac_index_order') || '[]');
    globalData.categories = order.map(id => {
      if(!id) return null;
      const style = JSON.parse(localStorage.getItem(`kac_style_${id}`) || '{}');
      const menus = JSON.parse(localStorage.getItem(`kac_menu_${id}`) || '[]');
      return { id, ...style, menus };
    });
  }

  function syncToLocalStorage(data) {
    const order = [];
    data.categories.forEach(cat => {
      if(cat) {
        order.push(cat.id);
        localStorage.setItem(`kac_style_${cat.id}`, JSON.stringify({name:cat.name, code:cat.code, color:cat.color, access:cat.access}));
      } else order.push(null);
    });
    localStorage.setItem('kac_index_order', JSON.stringify(order));
  }

  // --- ë Œë”ë§ í•¨ìˆ˜ ---
  function renderCards(anim) {
    const container = document.getElementById('cardContainer');
    const pag = document.getElementById('pagination');
    container.innerHTML = ''; pag.innerHTML = '';
    const list = isAdmin ? globalData.categories : globalData.categories.filter(c => c && c.access?.visible !== false);
    const isMob = window.innerWidth <= 768;

    if(isMob) {
      list.forEach(c => c && createCard(c, container));
    } else {
      const tp = Math.ceil(list.length / itemsPerPage) || 1;
      const start = (currentPage - 1) * itemsPerPage;
      list.slice(start, start + itemsPerPage).forEach(c => c && createCard(c, container));
      for(let i=1; i<=tp; i++) {
        const dot = document.createElement('div');
        dot.className = `page-dot ${i===currentPage?'active':''}`;
        dot.onclick = () => { currentPage = i; renderCards(); };
        pag.appendChild(dot);
      }
    }
    updateHeadline();
  }

  function createCard(c, target) {
    const div = document.createElement('div');
    div.className = 'card';
    div.style.setProperty('--card-color', c.color || '#64748b');
    div.onclick = () => location.href = `facility.html?type=${c.id}`;
    div.innerHTML = `<div class="icon-box">${c.code || '?'}</div><h2>${c.name}</h2>`;
    target.appendChild(div);
  }

  function renderSidebar() {
    const container = document.getElementById('sidebarContent');
    container.innerHTML = '';
    globalData.categories.forEach(cat => {
      if(!cat || (cat.access?.visible === false && !isAdmin)) return;
      const div = document.createElement('div');
      div.className = 'sb-item';
      div.textContent = cat.name;
      div.onclick = () => location.href = `facility.html?type=${cat.id}`;
      container.appendChild(div);
    });
  }

  function buildSearchIndex() {
    searchIndex = [];
    globalData.categories.forEach(cat => {
      if(!cat || !cat.menus) return;
      cat.menus.forEach(m => {
        searchIndex.push({ name: m.label, catId: cat.id, catName: cat.name });
      });
    });
  }

  // --- í†µí•© ê´€ë¦¬ (Tree Editor) ---
  function openIntegratedAdmin() {
    closeModal('settingsModal');
    document.getElementById('integratedAdminModal').style.display = 'flex';
    renderTree();
  }

  function renderTree() {
    const root = document.getElementById('treeRoot');
    root.innerHTML = '';
    globalData.categories.forEach((cat, cIdx) => {
        if(!cat) return;
        const div = document.createElement('div');
        div.className = 't-node-row';
        div.innerHTML = `<div class="t-toggle-btn">â–¼</div><div class="t-label" onclick="selectTreeNode('cat', ${cIdx})">ğŸ“‚ ${cat.name}</div>`;
        root.appendChild(div);
    });
  }

  function selectTreeNode(type, idx) {
    currentTreeSelection = { type, idx };
    const detail = document.getElementById('treeDetail');
    if(type === 'cat') {
        const cat = globalData.categories[idx];
        detail.innerHTML = `<h3>ì¹´í…Œê³ ë¦¬ ìˆ˜ì •</h3>ëª…ì¹­: <input type="text" id="editTreeName" value="${cat.name}" style="width:100%; padding:8px; margin:10px 0;">`;
    }
  }

  function saveIntegratedData() {
    if(currentTreeSelection?.type === 'cat') {
        globalData.categories[currentTreeSelection.idx].name = document.getElementById('editTreeName').value;
    }
    renderCards(); renderSidebar();
    alert("ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  // --- ê¸°íƒ€ ê¸°ëŠ¥ ---
  function setupQRCode() {
    const url = window.location.href.split('index.html')[0] + "login.html";
    const api = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
    document.getElementById('qrCodeImg').src = api;
    document.getElementById('qrZoomImg').src = api;
  }
  function zoomQR(s) { document.getElementById('qrZoomOverlay').style.display = s ? 'flex' : 'none'; }
  function loadFooterText() { document.getElementById('footerContent').innerHTML = globalData.config.footerText || "<p>Â© 2026 Korea Airports Corporation.</p>"; }
  function openFooterEditModal() { document.getElementById('footerTextInput').value = document.getElementById('footerContent').innerText; document.getElementById('footerEditModal').style.display = 'flex'; }
  function saveFooterText() { globalData.config.footerText = `<p>${document.getElementById('footerTextInput').value}</p>`; loadFooterText(); closeModal('footerEditModal'); }
  function openSettings() { document.getElementById('adminSettings').style.display = isAdmin ? 'block' : 'none'; document.getElementById('guestSettings').style.display = isAdmin ? 'none' : 'block'; document.getElementById('settingsModal').style.display = 'flex'; }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
  function setTheme(m) { document.body.className = m === 'dark' ? 'dark-mode' : ''; localStorage.setItem('kac_theme', m); }
  function toggleThemeMobile() { setTheme(localStorage.getItem('kac_theme') === 'dark' ? 'light' : 'dark'); }
  async function toggleAdmin() { if(isAdmin) { localStorage.removeItem('kac_admin_mode'); location.reload(); } else { const pw = prompt("ê´€ë¦¬ì ë¹„ë²ˆ"); if(pw === "CATC1234") { localStorage.setItem('kac_admin_mode', '1'); location.reload(); } } }
  async function saveToFirebase() { if(confirm("ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { try { await db.ref('/').set(globalData); alert("ì €ì¥ ì™„ë£Œ"); } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); } } }

  // --- ì‹œìŠ¤í…œ ì‹œì‘ ---
  async function init() {
    await ensureAnonAuth();
    setTheme(localStorage.getItem('kac_theme') || 'light');
    try {
      const snap = await db.ref('/').once('value');
      if(snap.exists()) {
        globalData = snap.val();
        globalData.categories = normalizeArray(globalData.categories);
        syncToLocalStorage(globalData);
        if(globalData.config) applyConfig(globalData.config);
      } else reconstructGlobalDataFromLocal();
    } catch(e) { reconstructGlobalDataFromLocal(); }
    
    ensurePageSlots(); renderCards(); renderSidebar(); buildSearchIndex(); setupQRCode(); loadFooterText();
    document.getElementById('loadingSpinner').style.opacity = '0';
    setTimeout(() => document.getElementById('loadingSpinner').style.display='none', 500);
  }

  init();
</script>
</body>
</html>