<!-- START OF FILE login.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - KAC CNS Training Platform</title>
<!-- [ìˆ˜ì • 1] Firebase SDK ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<!-- [ì¶”ê°€] QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
  * { box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
  body { 
    background: #0f172a; height: 100vh; display: flex; flex-direction: column; 
    align-items: center; justify-content: center; margin: 0; color: #fff;
  }
  .login-card {
    background: #1e293b; padding: 40px; border-radius: 20px; width: 400px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .logo { font-size: 24px; font-weight: 800; margin-bottom: 30px; display: block; }
  .logo span { color: #3b82f6; }
  
  .info-text { font-size: 13px; color: #94a3b8; margin-bottom: 20px; word-break: keep-all; }
  
  input {
    width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #334155;
    background: #0f172a; color: #fff; margin-bottom: 15px; font-size: 16px; outline: none;
    transition: 0.3s;
  }
  input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
  
  button {
    width: 100%; padding: 15px; border-radius: 10px; border: none;
    background: #3b82f6; color: #fff; font-size: 16px; font-weight: 700;
    cursor: pointer; transition: 0.3s;
  }
  button:hover { background: #2563eb; transform: translateY(-2px); }
  button:active { transform: translateY(0); }
  
  .message {
    margin-top: 15px; font-size: 14px; min-height: 20px; color: #ef4444; font-weight: 500;
  }
</style>
</head>
<body>
  <div class="login-card">
    <div class="logo">KAC <span>CNS</span> Platform</div>
    <p class="info-text">êµìœ¡ìƒ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input type="password" id="pwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeyup="if(window.event.keyCode==13){tryLogin()}">
    <button id="btnAction" onclick="tryLogin()">ì ‘ì†í•˜ê¸°</button>
    <div id="msg" class="message"></div>

    <!-- [ì¶”ê°€] ë¡œê·¸ì¸ ì¹´ë“œ í•˜ë‹¨ ê³µìœ  ë²„íŠ¼ -->
    <div style="margin-top: 25px; padding-top: 15px; border-top: 1px dashed #334155;">
        <button onclick="showLoginQr()" style="background: transparent; border: 1px solid #4b5563; color: #94a3b8; font-size: 12px; padding: 8px; width: auto; height: auto;">
            ğŸ“± ëª¨ë°”ì¼ ì£¼ì†Œ ê³µìœ  (QR)
        </button>
    </div>
  </div>

  <!-- [ì¶”ê°€] QR íŒì—… ë ˆì´ì–´ -->
  <div id="loginQrModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;" onclick="this.style.display='none'">
      <div style="background:#fff; padding:25px; border-radius:24px; text-align:center; box-shadow: 0 20px 40px rgba(0,0,0,0.4);" onclick="event.stopPropagation()">
          <h3 style="color:#000; font-size:18px; margin-bottom:10px; font-weight:800;">KAC í”Œë«í¼ ì ‘ì† QR</h3>
          <p style="color:#64748b; font-size:12px; margin-bottom:20px;">ë™ë£Œì˜ ìŠ¤ë§ˆíŠ¸í° ì¹´ë©”ë¼ë¡œ ì°ì–´ì£¼ì„¸ìš”.</p>
          <div id="loginQrcode" style="display:inline-block; padding:10px; background:#fff; border-radius:12px; border:1px solid #e2e8f0;"></div>
          <div style="margin-top:20px;">
              <button onclick="document.getElementById('loginQrModal').style.display='none'" style="width:100%; padding:12px; border-radius:12px; border:none; background:#0f172a; color:#fff; font-weight:700; cursor:pointer;">ë‹«ê¸°</button>
          </div>
      </div>
  </div>

  <script>
    // [ìˆ˜ì • 2] Firebase ì„¤ì • ë° ì´ˆê¸°í™”
  const firebaseConfig = {
    apiKey: "AIzaSyAUt6WqxWjRoB9xgAWXq2YhVMQutaOZCBc",
    authDomain: "catc-dfb9a.firebaseapp.com",
    databaseURL: "https://catc-dfb9a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "catc-dfb9a",
    storageBucket: "catc-dfb9a.firebasestorage.app",
    messagingSenderId: "669905270724",
    appId: "1:669905270724:web:c89fcc1d9c8f81b3071691",
    measurementId: "G-H1ME51B4MZ"
  };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // SHA-256 ì•”í˜¸í™” í•¨ìˆ˜
    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // [ìˆ˜ì • 3] íŒŒì´ì–´ë² ì´ìŠ¤ ì—°ë™ ë¡œê·¸ì¸ í•¨ìˆ˜
    async function tryLogin() {
        const input = document.getElementById('pwInput').value.trim().toUpperCase();
        const msgBox = document.getElementById('msg');
        
        if(!input) {
            msgBox.textContent = "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        msgBox.style.color = "#94a3b8";
        msgBox.textContent = "ì„œë²„ ì—°ê²° ë° í™•ì¸ ì¤‘...";

        try {
            // 1. ìµëª… ë¡œê·¸ì¸ ì‹œë„ (DB ì½ê¸° ê¶Œí•œ íšë“ìš©)
            await auth.signInAnonymously();

            // 2. Firebase DBì—ì„œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œê°’ ê°€ì ¸ì˜¤ê¸°
            // 'security' í´ë” ë°‘ì— 'entry_pw' ê°’ì„ í•œ ë²ˆë§Œ ì½ì–´ì˜´
            const snapshot = await db.ref('security/entry_pw').once('value');
            
            if (!snapshot.exists()) {
                throw new Error("ì„œë²„ì— ë¹„ë°€ë²ˆí˜¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. (DB í™•ì¸ í•„ìš”)");
            }
            
            const serverHash = snapshot.val();
            const inputHash = await sha256(input);

            // 3. ë¹„ë°€ë²ˆí˜¸ ë¹„êµ
            if(inputHash === serverHash) {
                msgBox.style.color = "#4ade80";
                msgBox.textContent = "ì ‘ì† ì„±ê³µ! ì´ë™í•©ë‹ˆë‹¤...";
                localStorage.setItem('kac_login_time', new Date().getTime());
                sessionStorage.setItem('kac_access_token', 'granted');
                
                // [ìˆ˜ì •] ë¦¬ë‹¤ì´ë ‰íŠ¸(ëª©ì ì§€ ê¸°ì–µ) ë¡œì§ ì ìš©
                const urlParams = new URLSearchParams(window.location.search);
                const redirectUrl = urlParams.get('redirect');
                const targetPath = redirectUrl ? decodeURIComponent(redirectUrl) : 'index.html';

                setTimeout(() => location.replace(targetPath), 500);
            } else {
                throw new Error("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        } catch(e) {
            console.error("ë¡œê·¸ì¸ ì—ëŸ¬:", e);
            msgBox.style.color = "#ef4444";
            
            // ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ë³€ê²½
            if(e.code === 'auth/operation-not-allowed') {
                msgBox.textContent = "ë¡œê·¸ì¸ ì„¤ì • ì˜¤ë¥˜ (ê´€ë¦¬ì ë¬¸ì˜)";
            } else if(e.message.includes("ë¹„ë°€ë²ˆí˜¸")) {
                msgBox.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            } else {
                msgBox.textContent = "ì„œë²„ ì ‘ì† ì‹¤íŒ¨. ì¸í„°ë„·ì„ í™•ì¸í•˜ì„¸ìš”.";
            }
            
            document.getElementById('pwInput').value = '';
            document.getElementById('pwInput').focus();
        }
    }

    // [ì¶”ê°€] ë¡œê·¸ì¸ í˜ì´ì§€ ì „ìš© QR ìƒì„± í•¨ìˆ˜
    function showLoginQr() {
        const modal = document.getElementById('loginQrModal');
        const container = document.getElementById('loginQrcode');
        container.innerHTML = '';
        
        // í˜„ì¬ ë©”ì¸ ì£¼ì†Œë¥¼ QRë¡œ ë³€í™˜
        const siteUrl = window.location.origin + window.location.pathname;
        
        new QRCode(container, {
            text: siteUrl,
            width: 160,
            height: 160,
            colorDark : "#0f172a",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
        modal.style.display = 'flex';
    }
    
    // ìë™ ë¡œê·¸ì¸ ì²´í¬
    window.onload = function() {
        const loginTime = localStorage.getItem('kac_login_time');
        const now = new Date().getTime();
        const expiry = 5 * 60 * 60 * 1000; // 5ì‹œê°„

        if(loginTime && (now - loginTime < expiry)) {
            sessionStorage.setItem('kac_access_token', 'granted');
            
            // ìë™ ë¡œê·¸ì¸ ì‹œì—ë„ ëª©ì ì§€ê°€ ìˆë‹¤ë©´ ê·¸ê³³ìœ¼ë¡œ ì´ë™
            const urlParams = new URLSearchParams(window.location.search);
            const redirectUrl = urlParams.get('redirect');
            const targetPath = redirectUrl ? decodeURIComponent(redirectUrl) : 'index.html';
            
            location.replace(targetPath);
        }
    }
  </script>
</body>
</html>