<!-- START OF FILE viewer_list.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>ê³¼ëª© ë¦¬ìŠ¤íŠ¸ - KAC CNS Training Platform</title>
<script>
  // [ë³´ì•ˆ] ë¡œê·¸ì¸ ì„¸ì…˜ ì²´í¬
  if(sessionStorage.getItem('kac_access_token') !== 'granted') {
    location.replace('login.html'); 
  }
</script>
<!-- [ìˆ˜ì • 1] Firebase SDK ì¶”ê°€ -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
  :root { 
    --theme-color: #2563eb; 
    --theme-rgb: 37, 99, 235;

    --navy: #0f172a; --bg-main: #f0f4f8; --bg-card: #ffffff; 
    --text-main: #000000; --text-sub: #334155; 
    --border-card: transparent; --shadow: 0 5px 15px rgba(0,0,0,0.05);
    --btn-bg: #f8fafc; --btn-border: #e2e8f0; --btn-text: #64748b;
    --pill-bg: #f1f5f9; --pill-text: #94a3b8; --pill-border: #e2e8f0;
    --title-color: #1e293b;
    --header-h: 75px;

    --tree-pos-x: 0px; 
    --spine-left: 65px; 
  }
  body.dark-mode {
    --navy: #020617; --bg-main: #0f172a; --bg-card: #1e293b; 
    --text-main: #f1f5f9; --text-sub: #cbd5e1; 
    --border-card: 1px solid rgba(255,255,255,0.1); 
    --shadow: 0 5px 20px rgba(0,0,0,0.5);
    --btn-bg: rgba(255,255,255,0.05); --btn-border: rgba(255,255,255,0.2); --btn-text: #e2e8f0;
    --pill-bg: rgba(255,255,255,0.05); --pill-text: #cbd5e1; --pill-border: rgba(255,255,255,0.2);
    --title-color: #ffffff;
  }
  
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
  body { background: var(--bg-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text-main); transition: 0.3s; }

  /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
  .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 6000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
  .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
  .sidebar { position: fixed; top: 0; left: -300px; width: 280px; height: 100vh; background: var(--bg-card); z-index: 6001; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 5px 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; border-right: 1px solid var(--btn-border); }
  .sidebar.active { left: 0; }
  .sidebar-header { height: var(--header-h); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--btn-border); font-weight: 800; font-size: 18px; justify-content: space-between; color: var(--text-main); }
  .sidebar-close { cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
  .sidebar-close:hover { background: var(--btn-bg); }
  .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
  
  .sb-item { padding: 12px 15px; cursor: pointer; border-radius: 10px; color: var(--text-main); font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: space-between; font-size: 14px; }
  .sb-item:hover { background: var(--btn-bg); color: #2563eb; }
  .sb-item.active { background: #eff6ff; border-left: 4px solid #2563eb; color: #2563eb; }
  body.dark-mode .sb-item.active { background: rgba(37,99,235,0.1); }

  .sb-sub-list { display: none; padding-left: 20px; margin-bottom: 5px; animation: slideDown 0.2s ease-out; }
  .sb-sub-list.open { display: block; }
  .sb-sub-item { padding: 10px 15px; font-size: 13px; color: var(--text-sub); cursor: pointer; border-left: 2px solid var(--btn-border); transition: 0.2s; margin-top: 2px; }
  .sb-sub-item:hover { border-left-color: #2563eb; color: #2563eb; background: rgba(37,99,235,0.05); }
  
  .sb-sub-item.active { background: rgba(37, 99, 235, 0.1); color: #2563eb; font-weight: 700; border-left-color: transparent; border-radius: 8px; }
  body.dark-mode .sb-sub-item.active { background: rgba(37, 99, 235, 0.2); color: #60a5fa; }

  .sb-toggle { font-size: 10px; color: #94a3b8; transition: 0.2s; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

  /* ê²€ìƒ‰ ì˜¤ë²„ë ˆì´ */
  #searchOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1500; display: none; backdrop-filter: blur(4px); animation: fadeIn 0.3s; }
  #searchOverlay.active { display: block; }
  
  body.search-mode header { z-index: 2000; position: relative; }
  body.search-mode .header-center { z-index: 2001; }
  body.search-mode .search-dropdown { z-index: 2002; }
  
  body.search-mode main, body.search-mode .bottom-nav, body.search-mode .header-left, body.search-mode .header-right { 
      opacity: 0.3; pointer-events: none; filter: blur(2px); transition: 0.3s; 
  }

  /* í—¤ë” ìŠ¤íƒ€ì¼ */
  header { height: var(--header-h); background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 1000; flex-shrink: 0; gap: 20px; position: relative; transition: 0.3s; }
  
  .header-left { display: flex; align-items: center; min-width: 250px; z-index: 10; white-space: nowrap; transition: opacity 0.2s; gap: 15px; } 
  .header-center { 
      position: absolute; left: 50%; transform: translateX(-50%); 
      width: 400px; max-width: 100%; z-index: 20; transition: width 0.3s; 
      display: flex; align-items: center; gap: 15px; /* í–„ë²„ê±°ì™€ ê²€ìƒ‰ì°½ ê°„ê²© */
  }
  .header-right { display: flex; align-items: center; gap: 15px; min-width: 250px; justify-content: flex-end; z-index: 30; }

/* í–„ë²„ê±° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .hamburger-btn { cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; flex-shrink: 0; }
  .hamburger-btn:hover { background: rgba(255,255,255,0.1); }
  .hamburger-btn svg { width: 24px; height: 24px; fill: #fff; }

  /* [ìˆ˜ì •] PCì—ì„œëŠ” 'mobile-only' í´ë˜ìŠ¤ê°€ ë¶™ì€(ì„¼í„°) ë²„íŠ¼ì„ ìˆ¨ê¹€ */
  .hamburger-btn.mobile-only { display: none; } 

  body.header-overlap .header-left { opacity: 0; pointer-events: none; width: 0; overflow: hidden; min-width: 0; }
  body.header-overlap .header-center { width: 80%; }

  /* ëª¨ë°”ì¼(1100px ì´í•˜) ì„¤ì • */
  @media (max-width: 1100px) {
    .header-left, .header-right { display: none !important; }
    .header-center { position: relative; left: auto; transform: none; width: 100%; max-width: 100%; }
    header { padding: 0 20px; }
    .header-search { width: 100% !important; }

    /* [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œëŠ” ì„¼í„°ì— ìˆëŠ” 'mobile-only' ë²„íŠ¼ì„ ë‹¤ì‹œ ë³´ì´ê²Œ í•¨ */
    .hamburger-btn.mobile-only { display: flex; }
  }
  
  .logo-text { font-size: 20px; font-weight: 800; white-space: nowrap; cursor: pointer; transition: opacity 0.2s; }
  .logo-text:hover { opacity: 0.8; }
  
  .breadcrumb { display: flex; align-items: center; color: #94a3b8; font-weight: 500; font-size: 16px; margin-left: 0px; }
  .crumb-link { cursor: pointer; transition: color 0.2s; }
  .crumb-link:hover { color: #fff; } 
  .crumb-current { cursor: default; } 

  .header-search {
    width: 100%; 
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50px; padding: 12px 30px; color: #fff; font-size: 16px; font-weight: 600;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: 25px center; background-size: 20px;
    padding-left: 55px; transition: 0.3s;
    background-color: var(--navy);
  }
  .header-search:focus { outline: none; background-color: var(--navy); border-color: rgba(255,255,255,0.5); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
  .header-search::placeholder { color: rgba(255,255,255,0.5); font-weight: 400; }

  .search-dropdown {
    position: absolute; top: 110%; left: 0; right: 0; width: 100%; margin: 0 auto;
    background: var(--bg-card); border-radius: 15px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border-card);
    overflow: hidden; display: none; max-height: 400px; overflow-y: auto;
  }
  .search-dropdown.active { display: block; }
  .result-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--btn-border); transition: 0.2s; }
  .result-item:hover { background: rgba(var(--theme-rgb), 0.05); }
  .result-info { display: flex; flex-direction: column; gap: 2px; text-align: left; }
  .res-title { font-weight: 700; color: var(--text-main); font-size: 14px; }
  .res-path { font-size: 11px; color: var(--text-sub); opacity: 0.7; }
  .res-tag { font-size: 12px; font-weight: 900; padding: 4px 10px; border-radius: 6px; color: #fff; min-width: 50px; text-align: center; }
  
  .kac-logo-img { height: 30px; width: auto; display: block; object-fit: contain; }

  .theme-toggle { display: flex; gap: 5px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); margin-right: 10px; }
  .theme-btn { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; opacity: 0.5; }
  .theme-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }
  .theme-btn.active { background: #fff; opacity: 1; color: var(--navy); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .theme-btn svg { width: 16px; height: 16px; fill: currentColor; }

  .settings-btn { 
    display: flex; padding: 8px; width: 34px; height: 34px; 
    border-radius: 100px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); 
    align-items: center; justify-content: center; font-size: 18px; 
    cursor: pointer; transition: 0.3s; color: #cbd5e1;
  }
  .settings-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

  body.preview-active .add-card { display: none !important; }
  body.preview-active .ctrl-btns { visibility: hidden; }

  main { flex: 1; overflow-y: auto; padding: 40px; padding-bottom: 150px; display: flex; flex-direction: column; align-items: center; gap: 0px; }

  /* íŠ¸ë¦¬ êµ¬ì¡° + Facility ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .tree-container {
      display: flex; flex-direction: column; align-items: center; width: 100%; position: relative;
      transform: translateX(var(--tree-pos-x, 0px));
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  .fac-top-card {
      background: rgba(var(--theme-rgb), 0.08); 
      width: 100%; max-width: 900px;
      padding: 20px 30px; border-radius: 20px;
      box-shadow: var(--shadow);
      border: 2px solid var(--theme-color);
      border-left: 8px solid var(--theme-color);
      display: flex; align-items: center; justify-content: space-between;
      color: var(--text-main);
      z-index: 5; margin-bottom: 25px;
      position: relative;
      transition: 0.2s;
      cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì»¤ì„œ ë³€ê²½ */
  }
  .fac-top-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(var(--theme-rgb), 0.15); }
  body.dark-mode .fac-top-card { background: rgba(var(--theme-rgb), 0.15); }
  
  .fac-left-group { display: flex; align-items: center; gap: 20px; flex: 1; }
  .fac-tag-pill {
      background: var(--theme-color); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-weight: 900; font-size: 16px;
      min-width: 80px; text-align: center; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: 0.2s; z-index: 10;
  }
  .fac-title { font-size: 22px; font-weight: 800; word-break: keep-all; }

  .tree-spine { position: absolute; top: 100px; bottom: 40px; left: calc(50% - 450px + var(--spine-left)); width: 3px; background: rgba(var(--theme-rgb), 0.3); z-index: 0; border-radius: 2px; }
  .card-wrapper::before { content: ''; position: absolute; top: 50%; left: var(--spine-left); width: 40px; height: 3px; background: rgba(var(--theme-rgb), 0.3); transform: translateY(-50%); z-index: -1; }
  .card-wrapper { position: relative; width: 100%; max-width: 900px; display: flex; justify-content: flex-end; margin-bottom: 20px; z-index: 1; padding-left: calc(var(--spine-left) + 40px); }
  
  .subject-card { 
    background: var(--bg-card); width: 100%; padding: 25px 35px; border-radius: 18px; box-shadow: var(--shadow); border: 1px solid transparent;
    display: flex; justify-content: space-between; align-items: center; transition: 0.3s; border-left: 10px solid var(--theme-color); 
    cursor: pointer; color: var(--text-main); position: relative; overflow: visible; 
  }
  .subject-card:hover { transform: translateX(5px); border-color: var(--theme-color); box-shadow: 0 5px 20px rgba(var(--theme-rgb), 0.2); }
  .subject-card.inactive { border-left-color: #94a3b8 !important; opacity: 0.7; background: #f8fafc; }
  body.dark-mode .subject-card.inactive { background: #1e293b; opacity: 0.6; }
  .subject-card.dragging { opacity: 0.5; border: 2px dashed #94a3b8; background: rgba(255,255,255,0.05); }
  .subject-card.drag-over { border: 2px solid var(--theme-color); transform: scale(1.02); box-shadow: 0 0 15px rgba(var(--theme-rgb), 0.2); z-index: 10; }

  .last-viewed-icon {
    position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: none; 
    align-items: center; justify-content: center; gap: 8px; color: #10b981; 
    font-size: 13px; font-weight: 800; white-space: nowrap; background: rgba(16, 185, 129, 0.1); 
    padding: 8px 16px; border-radius: 50px; border: 1px solid rgba(16, 185, 129, 0.3); z-index: 0; pointer-events: none;
  }
  body.admin-mode .last-viewed-icon { right: -140px !important; background: #10b981; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 100; }
  .subject-card.last-viewed { border: 2px solid #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.2); }
  .subject-card.last-viewed .last-viewed-icon { display: flex; }
  .last-viewed-icon svg { width: 24px; height: 24px; fill: currentColor; }

  .subj-title { font-size: 20px; font-weight: 800; color: var(--title-color); transition: 0.3s; }
  body.dark-mode .subj-title { text-shadow: 0 0 15px rgba(255,255,255,0.15); }

  .add-card { border: 2px dashed #cbd5e1; background: transparent; justify-content: center; color: #94a3b8; font-weight: 800; }
  .add-card:hover { border-color: #64748b; color: #64748b; background: rgba(255,255,255,0.5); transform: none; box-shadow: none; }

  .status-group { display: flex; gap: 8px; margin-top: 8px; }
  .status-pill { font-size: 11px; font-weight: 800; padding: 4px 10px; border-radius: 6px; background: var(--pill-bg); color: var(--pill-text); border: 1px solid var(--pill-border); }
  .status-pill.on { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
  body.dark-mode .status-pill.on { background: rgba(22, 163, 74, 0.2); color: #86efac; border-color: #166534; }
  .status-pill.link { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
  body.dark-mode .status-pill.link { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border-color: #1e40af; }
  .status-pill.dev { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
  body.dark-mode .status-pill.dev { background: rgba(255,255,255,0.1); color: #94a3b8; border-color: rgba(255,255,255,0.1); }

  .ctrl-btns { display: flex; gap: 10px; z-index: 50; position: relative; }
  .btn-action { padding: 8px 14px; border-radius: 8px; border: 1px solid var(--btn-border); background: var(--btn-bg); font-size: 12px; font-weight: 700; color: var(--btn-text); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
  .btn-action:hover { background: rgba(128,128,128,0.2); color: var(--text-main); }
  .btn-del { color: #ef4444; border-color: #fee2e2; }
  .btn-del:hover { background: #fee2e2; }

  /* ì˜¤ë²„ë ˆì´ */
  #pdfOverlay { 
      position: fixed; inset: 0; background: #000; 
      display: none; z-index: 7000; overflow: hidden; 
      transition: 0.3s; touch-action: none; flex-direction: column; 
  }
  
  /* PC ê¸°ë³¸ í—¤ë” */
  .v-header { 
      position: absolute; top: 0; left: 0; right: 0; height: 80px; 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 0 40px; z-index: 8000; color: #fff; 
      background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); flex-shrink: 0; 
  }
  .v-header-left { display: flex; align-items: center; gap: 25px; }
  .close-v { font-size: 32px; cursor: pointer; transition: 0.3s; opacity: 0.8; }
  .close-v:hover { color: #ef4444; opacity: 1; }
  .v-title-box { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); padding: 10px 25px; border-radius: 100px; backdrop-filter: blur(5px); font-weight: 800; font-size: 16px; letter-spacing: -0.5px; }
  .v-header-right { display: flex; align-items: center; gap: 20px; }
  
  .v-icon-btn { cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; opacity: 0.8; padding: 5px; }
  .v-icon-btn:hover { opacity: 1; transform: scale(1.05); }
  .v-icon-btn.active { color: #facc15; opacity: 1; transform: scale(1.1); }
  .v-icon-btn.disabled { opacity: 0.2; pointer-events: none; cursor: default; }
  .v-icon-btn svg { width: 26px; height: 26px; fill: currentColor; }
  
  /* PC ì˜¤ë””ì˜¤ íŒ¨ë„ */
  #audioPanel { 
      position: absolute; top: 85px; right: 40px; left: auto;
      width: 340px; height: auto; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
      border-radius: 15px; display: none; flex-direction: column; justify-content: center; gap: 10px; 
      padding: 15px 20px; transition: opacity 0.2s; z-index: 8500; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: #000; border: 1px solid rgba(0,0,0,0.1);
  }
  #audioPanel.open { display: flex; animation: fadeIn 0.2s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

  .audio-ctrl-row { display: flex; align-items: center; gap: 15px; width: 100%; }
  .audio-btn { background: var(--navy); color: #fff; border: none; width: 34px; height: 34px; border-radius: 50%; cursor: pointer; flex-shrink: 0; display:flex; align-items:center; justify-content:center; }
  #audioProgress { flex: 1; accent-color: var(--navy); cursor: pointer; height: 4px; }
  .volume-row { display: flex; align-items: center; gap: 10px; font-size: 11px; font-weight: 800; color: #666; margin-left: 45px; }
  #volumeControl { width: 80px; accent-color: #64748b; height: 4px; }
  
  /* í•˜ë‹¨ í˜ì´ì§€ ì§„í–‰ë°” */
  .progress-hit-area { position: absolute; bottom: 0; left: 0; height: 40px; width: 100%; z-index: 9000; cursor: pointer; display: flex; align-items: flex-end; flex-shrink: 0; }
  .progress-track { width: 100%; height: 6px; background: rgba(255,255,255,0.3); position: relative; transition: height 0.2s, background 0.2s; }
  .progress-hit-area:hover .progress-track { background: rgba(255,255,255,0.5); height: 8px; }
  .progress-fill { height: 100%; width: 0%; background: #ef4444; position: relative; }
  .progress-handle { position: absolute; right: -7px; bottom: 0; width: 14px; height: 9px; background: #ef4444; border-radius: 7px 7px 0 0; border: 2px solid #fff; border-bottom: none; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 9100; }
  .progress-flag { position: absolute; right: -30px; bottom: 35px; background: #1e293b; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 800; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s; transform: translateY(10px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 9200; }
  .progress-flag::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-width: 5px 5px 0; border-style: solid; border-color: #1e293b transparent transparent transparent; }
  .progress-hit-area:hover .progress-flag, .progress-hit-area.dragging .progress-flag { opacity: 1; transform: translateY(0); }
  
  .viewer-body { width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; cursor: default; overflow: hidden; position: relative; background: #000; }
  
  canvas { 
      box-shadow: 0 0 50px rgba(0,0,0,0.8); pointer-events: none; 
      max-width: 100%; max-height: 100%; width: auto; height: auto; 
      object-fit: contain; opacity: 1; transition: none; 
  }

  #pageContainer { position: relative; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }

  .bottom-nav { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background: var(--navy); padding: 15px 45px; border-radius: 100px; display: flex; gap: 40px; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; border: 1px solid rgba(255,255,255,0.1); }
  .nav-item { color: #fff; cursor: pointer; font-size: 18px; font-weight: 700; transition: 0.3s; opacity: 0.8; display: flex; align-items: center; gap: 10px; }
  .nav-item:hover { opacity: 1; transform: translateY(-3px); }
  .nav-icon { width: 24px; height: 24px; fill: currentColor; }

  body.dark-mode .bottom-nav { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.3); }
  body.dark-mode .nav-item { color: #e2e8f0; opacity: 1; }
  
  .mobile-only-nav { display: none; }

  .mobile-top-bar { display: none; }

  .creator-info { position: fixed; bottom: 5px; width: 100%; text-align: center; font-size: 11px; color: var(--text-sub); opacity: 0.5; font-weight: 500; z-index: 500; pointer-events: none; }
  .creator-info b { font-weight: 700; }
  body.dark-mode .creator-info { color: #fff; opacity: 0.3; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: none; align-items: center; justify-content: center; }
  .modal-card { background: var(--bg-card); padding: 35px; border-radius: 25px; width: 500px; color: var(--text-main); box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
  .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; border-bottom: 1px solid var(--btn-border); padding-bottom: 10px; }
  .setting-group { margin-bottom: 25px; }
  .setting-label { font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; display: block; }
  .setting-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--btn-border); background: var(--btn-bg); color: var(--text-main); font-size: 14px; }
  
  body.dark-mode .setting-input, 
  body.dark-mode select.setting-input { background-color: #334155 !important; color: #ffffff !important; border: 1px solid rgba(255,255,255,0.3); }
  body.dark-mode select.setting-input option { background-color: #1e293b; color: #ffffff; }
  body.dark-mode .modal-card { background-color: #1e293b; border: 1px solid rgba(255,255,255,0.1); }

  .btn-row { display: flex; gap: 10px; margin-top: 30px; }
  .btn-modal { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
  .btn-primary { background: var(--navy); color: #fff; }
  .btn-secondary { background: var(--btn-border); color: var(--text-sub); }
  .btn-danger { background: #ef4444; color: #fff; }

  .batch-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .batch-table th, .batch-table td { padding: 8px; border: 1px solid var(--btn-border); text-align: center; }
  .batch-table th { background: var(--btn-bg); font-weight: 700; color: var(--text-sub); }
  .batch-input { width: 100%; border: none; background: transparent; color: var(--text-main); }

  .icon-mobile { display: none; }
  .icon-pc { display: block; }
  .mobile-top-bar { display: none; }

  /* ========================================= */
  /* [ëª¨ë°”ì¼ ì „ìš© ìµœì í™”] */
  /* ========================================= */
  @media (max-width: 768px) {
    .v-header, #audioPanel, .mobile-top-exit-btn { display: none !important; }

    /* [ìˆ˜ì •] ëª¨ë°”ì¼ í•˜ë‹¨ ì—¬ë°± + ìƒë‹¨ ì—¬ë°± 13px ë” ìœ„ë¡œ (ê¸°ì¡´ 0 15px -> -13px margin) */
    main { padding: 0 15px 150px 15px !important; }

    .tree-container { align-items: flex-start; }
    .tree-spine { display: block !important; left: 24px; top: 60px; bottom: 30px; width: 3px; background: rgba(var(--theme-rgb), 0.3); }
    
    /* [ìˆ˜ì •] ìƒë‹¨ ëª…í•¨ ì¹´ë“œ ì˜ì—­ (Sticky + ìœ„ë¡œ 13px ì˜¬ë¦¼) */
    .tree-container > .fac-top-card { 
        position: sticky;
        top: 0;
        z-index: 600 !important;
        
        background: var(--bg-main) !important; 
        
        width: calc(100% + 30px); 
        max-width: none;
        margin: -13px -15px 25px -15px !important; /* ì—¬ê¸°ë¥¼ ì¡°ì •í•˜ì—¬ ìœ„ë¡œ ì˜¬ë¦¼ */
        padding: 10px 15px 15px 15px; 
        
        border: none; 
        border-radius: 0;
        box-shadow: none; 
        
        flex-direction: column !important;
        align-items: stretch !important;
    }
    
    .fac-top-card::after {
        content: '';
        display: block;
        position: absolute;
        inset: 10px 15px 15px 15px;
        background: var(--bg-card);
        border: 3px solid var(--theme-color);
        border-radius: 20px;
        z-index: -1;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* ë‚´ë¶€ ìš”ì†Œ ì¬ë°°ì¹˜ */
    .fac-left-group { 
        width: 100%; 
        flex-direction: row !important; 
        align-items: center; 
        gap: 12px; 
        padding: 15px;
        z-index: 1;
    }
    
    .fac-tag-pill { font-size: 13px; padding: 6px 12px; min-width: auto; align-self: center; margin: 0; }
    .fac-title { font-size: 18px; line-height: 1.3; flex: 1; text-align: left; }
    
    .card-wrapper { display: block; margin-bottom: 10px; padding-left: 55px; width: 100%; }
    .card-wrapper::before { display: block !important; left: 26px; width: 34px; top: 50%; height: 3px; background: rgba(var(--theme-rgb), 0.3); }
    .card-wrapper::after { content: ''; position: absolute; left: 22px; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; border-radius: 50%; background: var(--theme-color); border: 2px solid var(--bg-main); z-index: 2; }
    
    /* [ìˆ˜ì •] ëª¨ë°”ì¼ ì¹´ë“œ ìŠ¬ë¦¼í™” ë° ë¶ˆí•„ìš” ìš”ì†Œ ì œê±° */
    .subject-card { 
        padding: 18px 20px; 
        border-radius: 15px; 
        min-height: auto; 
        display: flex; 
        flex-direction: row; 
        align-items: center; 
        gap: 0; 
    }
    .status-group, .ctrl-btns { display: none !important; } /* PDF, Audio, ë²„íŠ¼ ìˆ¨ê¹€ */

    .subj-title { font-size: 15px; padding-right: 0; word-break: keep-all; line-height: 1.2; margin-bottom: 0; flex: 1; }
    
    .bottom-nav { width: 90%; bottom: 20px; padding: 16px 0; gap: 30px; border-radius: 50px; justify-content: center; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
    .nav-item { font-size: 14px; gap: 6px; font-weight: 800; }
    .nav-icon { width: 20px !important; height: 20px !important; }

    .header-search { font-size: 14px; padding: 10px 20px 10px 45px; background-size: 18px; background-position: 15px center; }

    .mobile-top-bar {
        display: flex !important;
        height: 60px !important;
        background: rgba(20, 20, 25, 0.85) !important;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        align-items: center; padding: 0 15px; gap: 15px;
        position: absolute; top: 0; left: 0; right: 0;
        z-index: 8000;
    }

    .mobile-exit-btn {
        width: 36px; height: 36px;
        background: rgba(255,255,255,0.1); color: #fff;
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; flex-shrink: 0; padding: 0;
    }
    .mobile-exit-btn svg { width: 20px; height: 20px; fill: #ef4444; }

    .mobile-audio-group {
        flex: 1; display: flex; align-items: center; gap: 12px;
        min-width: 0;
        background: rgba(0,0,0,0.3);
        padding: 6px 12px; border-radius: 50px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .audio-btn-sm {
        width: 32px; height: 32px; border-radius: 50%; border: none;
        background: #fff; color: #000; flex-shrink: 0;
        display: flex; align-items: center; justify-content: center; 
        font-size: 14px; padding-left: 2px;
    }

    .audio-slider-sm {
        flex: 1; height: 6px; border-radius: 10px;
        appearance: none; -webkit-appearance: none;
        background: rgba(255,255,255,0.2); cursor: pointer; overflow: hidden;
    }
    .audio-slider-sm::-webkit-slider-thumb {
        -webkit-appearance: none; width: 0; height: 10px;
        box-shadow: -100vw 0 0 100vw #2563eb; background: #2563eb;
    }

    .audio-time-sm { 
        font-size: 11px; font-family: monospace; font-weight: 700;
        color: rgba(255,255,255,0.8); width: 35px; text-align: right; 
    }

    .mobile-audio-icon-right {
        width: 36px; height: 36px;
        display: flex; align-items: center; justify-content: center;
        background: rgba(250, 204, 21, 0.1); border-radius: 12px;
        color: #facc15; flex-shrink: 0;
    }
    .mobile-audio-icon-right svg { width: 20px; height: 20px; fill: currentColor; }

    .viewer-body { 
        position: absolute !important;
        top: 60px !important; bottom: 10px !important; left: 0 !important; right: 0 !important;
        width: 100% !important; height: auto !important; 
        padding: 0 !important; background: #000; display: block !important; 
        overflow-y: scroll !important; -webkit-overflow-scrolling: touch;
    }
    
    canvas { display: block !important; width: 100% !important; height: auto !important; }
    
    #pageContainer { min-height: 100% !important; height: auto !important; display: block !important; padding-bottom: 50px !important; }

    .subject-card.last-viewed .last-viewed-icon { 
        display: flex; position: absolute; 
        left: auto !important; right: 15px !important; top: 50%; transform: translateY(-50%); 
        width: 24px; height: 24px; border-radius: 50%; background: #10b981; 
        border: 2px solid #fff; padding: 0; justify-content: center; align-items: center; 
        z-index: 10; 
    }
    .icon-pc { display: none !important; }
    .icon-mobile { display: block !important; }
    .last-viewed-icon span { display: none !important; }
    .last-viewed-icon svg { width: 14px; height: 14px; fill: #fff; margin: 0; }

    .progress-hit-area {
        position: absolute !important; bottom: 0 !important; left: 0 !important; right: 0 !important;
        height: 10px !important; background: #1e293b; z-index: 9000;
    }

    /* [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œë§Œ ë³´ì´ëŠ” ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ */
    .mobile-only-nav { display: flex !important; }
  }
</style>
</head>
<body oncontextmenu="return false;">

<!-- ê²€ìƒ‰ ë°°ê²½ ì˜¤ë²„ë ˆì´ -->
<div id="searchOverlay"></div>

<!-- ì‚¬ì´ë“œë°” -->
<div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="sidebar" class="sidebar">
  <div class="sidebar-header">
    <span>ì „ì²´ ë©”ë‰´</span>
    <div class="sidebar-close" onclick="toggleSidebar()">âœ•</div>
  </div>
  <div class="sidebar-content" id="sidebarContent"></div>
</div>

<header>
  <div class="header-left" id="headerLeft">
    <!-- [ìˆ˜ì • 1] PCìš© í–„ë²„ê±° ë²„íŠ¼ì„ ì¢Œì¸¡ ë§¨ ì•ì— ì¶”ê°€ -->
    <div class="hamburger-btn" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </div>

    <div class="logo-text" onclick="location.href='index.html'">KAC CNS Training Platform</div>
    <div class="breadcrumb" id="breadcrumbContainer"></div>
  </div>

  <div class="header-center" id="headerCenter">
    <!-- [ìˆ˜ì • 2] ê¸°ì¡´ ì¤‘ì•™ ë²„íŠ¼ì— 'mobile-only' í´ë˜ìŠ¤ ì¶”ê°€ (PCì—ì„œëŠ” ìˆ¨ê²¨ì§) -->
    <div class="hamburger-btn mobile-only" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </div>
    <input type="text" id="searchInput" class="header-search" placeholder="ì˜ˆì‹œ) í•­ê³µí†µì‹ ìš© ë°ì´í„°ë§í¬, VOR, ILS..." autocomplete="off">
    <div id="searchDropdown" class="search-dropdown"></div>
  </div>

  <div class="header-right">
    <div class="theme-toggle">
      <div class="theme-btn" id="btnDay" onclick="setTheme('light')" title="ì£¼ê°„ ëª¨ë“œ"><svg viewBox="0 0 24 24"><path d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,5.29C7.24,6.03 7.06,6.79 7,7.59C6.94,8.39 7.03,9.19 7.26,9.95L3.34,7M3.36,17L7.26,14.04C7.03,14.81 6.94,15.61 7,16.41C7.06,17.21 7.24,17.97 7.5,18.71L3.36,17M20.65,7L16.74,9.95C16.97,9.19 17.06,8.39 17,7.59C16.94,6.79 16.76,6.03 16.5,5.29L20.65,7M20.64,17L16.5,18.71C16.76,17.97 16.94,17.21 17,16.41C17.06,15.61 16.97,14.81 16.74,14.04L20.64,17M12,22L9.61,18.58C10.35,18.85 11.16,19 12,19C12.84,19 13.65,18.85 14.39,18.58L12,22Z"/></svg></div>
      <div class="theme-btn" id="btnNight" onclick="setTheme('dark')" title="ì•¼ê°„ ëª¨ë“œ"><svg viewBox="0 0 24 24"><path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C6.94,10.39 9.79,16.87 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.36,12.31 6.2,9.5 6.04,6.68C3.23,9.82 3.34,14.64 6.35,17.66C9.37,20.67 14.19,20.78 17.33,17.97Z"/></svg></div>
    </div>
    
    <div class="settings-btn" onclick="openSettings()" title="ì„¤ì •">âš™ï¸</div>
    <img src="logo.png" alt="KAC Logo" class="kac-logo-img">
  </div>
</header>

<main id="subjectList"></main>

<!-- ê°œë³„ ì—…ë¡œë“œ ëª¨ë‹¬ -->
<div id="uploadModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">ìë£Œ ë“±ë¡ ë° ìˆ˜ì •</div>
    <input type="text" id="editSubjectName" placeholder="ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" class="setting-input" style="margin-bottom:15px;">
    <label class="setting-label">ìƒíƒœ ì„¤ì •</label>
    <select id="editActiveStatus" class="setting-input" style="margin-bottom:15px;">
        <option value="true">ğŸŸ¢ í™œì„± (ì„œë¹„ìŠ¤ ì¤‘)</option>
        <option value="false">ğŸš§ ë¹„í™œì„± (ê°œë°œ ì¤‘)</option>
    </select>
    
    <label class="setting-label">ğŸ“„ PDF íŒŒì¼ ê²½ë¡œ (ì˜ˆ: COMM/manual.pdf)</label>
    <input type="text" id="inputPdfName" class="setting-input" placeholder="ì˜ˆ: COMM/manual.pdf" style="margin-bottom:10px;">
    
    <label class="setting-label">ğŸ”— ì™¸ë¶€ ë§í¬ ì£¼ì†Œ (ì„ íƒ)</label>
    <input type="text" id="inputLinkUrl" class="setting-input" placeholder="ì˜ˆ: https://..." style="margin-bottom:10px;">

    <!-- ì˜¤ë””ì˜¤ ì…ë ¥ ë¶€ë¶„ -->
    <label class="setting-label">ğŸµ ì˜¤ë””ì˜¤ íŒŒì¼ ê²½ë¡œ (í™•ì¥ì ì œì™¸)</label>
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <input type="text" id="inputAudioName" class="setting-input" placeholder="ì˜ˆ: COMM/audio" style="flex: 1;">
        <select id="inputAudioExt" class="setting-input" style="width: 100px;">
            <option value=".mp3">MP3</option>
            <option value=".wav">WAV</option>
        </select>
    </div>
    
    <div class="btn-row">
      <button onclick="saveFiles()" class="btn-modal btn-primary">ì €ì¥</button>
      <button onclick="document.getElementById('uploadModal').style.display='none'" class="btn-modal btn-secondary">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ì´ë™ ëª¨ë‹¬ -->
<div id="moveModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">ğŸ“‚ ê³¼ëª© ì´ë™</div>
    <p style="font-size:13px; color:var(--text-sub); margin-bottom:20px;">
      ì„ íƒí•œ ê³¼ëª©ì„ ë‹¤ë¥¸ ë©”ë‰´ë¡œ ì´ë™í•©ë‹ˆë‹¤.
    </p>
    <select id="moveTargetSelect" class="setting-input" style="margin-bottom:20px;"></select>
    <div class="btn-row">
      <button onclick="executeMove()" class="btn-modal btn-primary">ì´ë™ í™•ì¸</button>
      <button onclick="document.getElementById('moveModal').style.display='none'" class="btn-modal btn-secondary">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-title">âš™ï¸ ì„¤ì • ë° ê´€ë¦¬</div>
    
    <div class="setting-group">
      <label class="setting-label">ğŸ› ï¸ ì‹œìŠ¤í…œ ê´€ë¦¬</label>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="modalAdminBtn" class="btn-modal btn-secondary" onclick="toggleAdmin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
        <button id="modalPreviewBtn" class="btn-modal btn-secondary" onclick="togglePreview()" style="display:none;">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
      </div>
      <!-- [ìˆ˜ì • 2] ì„œë²„ ì €ì¥ ë²„íŠ¼ ì¶”ê°€ -->
      <button id="btnSaveServer" class="btn-modal btn-success" onclick="saveToFirebase()" style="display:none; margin-top:10px; background:#10b981;">
        â˜ï¸ ì„œë²„ì— ë³€ê²½ì‚¬í•­ ì €ì¥
      </button>
    </div>
    
    <div class="setting-group">
      <label class="setting-label">â†”ï¸ íŠ¸ë¦¬ ë ˆì´ì•„ì›ƒ ê°€ë¡œ ìœ„ì¹˜ ì¡°ì • (px)</label>
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="range" id="treePosRange" min="-500" max="500" step="10" style="flex:1" oninput="updateTreePos(this.value)">
        <span id="treePosVal" style="font-size:12px; font-weight:700; width:50px; text-align:right;">0</span>
      </div>
      <p style="font-size:11px; color:var(--text-sub); margin-top:5px;">* ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ì¢Œ(-) ìš°(+)ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
    </div>

    <div id="batchAdminGroup" class="setting-group" style="display:none;">
      <label class="setting-label">ğŸ“¦ ëŒ€ëŸ‰ ë“±ë¡ ê´€ë¦¬</label>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <button class="btn-modal btn-primary" style="flex:1" onclick="openBatchAddModal()">ì¼ê´„ ì…ë ¥ (ì‹ ê·œ)</button>
        <button class="btn-modal btn-secondary" style="flex:1" onclick="openBatchEditModal()">ì¼ê´„ ìˆ˜ì • (ê¸°ì¡´)</button>
      </div>
      <p style="font-size:11px; color:var(--text-sub);">* GitHub files í´ë” ë‚´ì˜ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    </div>

    <div class="btn-row">
      <button class="btn-modal btn-secondary" onclick="document.getElementById('settingsModal').style.display='none'">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ì¼ê´„ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="batchModal" class="modal-overlay">
  <div class="modal-card" style="width: 1000px; max-width: 95%;">
    <div class="modal-title" id="batchModalTitle">ğŸ“‹ ì¼ê´„ ìë£Œ ë“±ë¡</div>
    <div style="overflow-y:auto; max-height:50vh; border:1px solid var(--btn-border); margin-bottom:20px;">
        <table class="batch-table" id="batchTable">
            <thead>
                <tr>
                    <th style="width:40px;">No.</th>
                    <th>ê³¼ëª©ëª…</th>
                    <th style="width:200px;">PDF ê²½ë¡œ</th>
                    <th style="width:200px;">ë§í¬ ì£¼ì†Œ</th>
                    <th style="width:150px;">ì˜¤ë””ì˜¤ ê²½ë¡œ</th>
                </tr>
            </thead>
            <tbody id="batchTbody"></tbody>
        </table>
    </div>
    <div class="btn-row">
      <button id="batchSaveBtn" class="btn-modal btn-primary">ì €ì¥</button>
      <button onclick="document.getElementById('batchModal').style.display='none'" class="btn-modal btn-secondary">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div id="pdfOverlay" onmousedown="handleMouseNav(event)">
  
  <div class="mobile-top-bar" onmousedown="event.stopPropagation()" onclick="event.stopPropagation()">
      <div class="mobile-exit-btn" onclick="closeViewer()">
          <svg viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </div>
      <div id="mobileAudioGroup" class="mobile-audio-group" style="display:none;">
          <button id="mobilePlayBtn" class="audio-btn-sm">â–¶</button>
          <input type="range" id="mobileAudioProgress" class="audio-slider-sm" value="0">
          <span id="mobileAudioTime" class="audio-time-sm">00:00</span>
      </div>
      <div id="mobileAudioIconRight" class="mobile-audio-icon-right" style="display:none;">
          <svg viewBox="0 0 24 24"><path d="M12,2A3,3 0 0,0 9,5V11A3,3 0 0,0 12,14A3,3 0 0,0 15,11V5A3,3 0 0,0 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,1 12,16A5,5 0 0,1 17,11H19Z"/></svg>
      </div>
  </div>

  <div class="v-header" onmousedown="event.stopPropagation()">
    <div class="v-header-left">
      <div class="close-v" onclick="closeViewer()">âœ•</div>
      <div id="vTitle" class="v-title-box"></div>
    </div>
    <div class="v-header-right">
      <div class="v-icon-btn" id="fsBtn" onmousedown="event.stopPropagation()" onclick="toggleFullScreen(event)" title="ì „ì²´í™”ë©´ ì „í™˜">
        <svg id="iconExpand" viewBox="0 0 24 24"><path d="M5,5H10V7H7V10H5V5M14,5H19V10H17V7H14V5M17,14H19V19H14V17H17V14M10,17H7V14H5V19H10V17Z"/></svg>
        <svg id="iconCompress" viewBox="0 0 24 24" style="display:none;"><path d="M14,14H19V16H16V19H14V14M5,14H10V19H8V16H5V14M8,5H10V10H5V8H8V5M14,5H16V8H19V10H14V5Z"/></svg>
      </div>
      <div class="v-icon-btn" onmousedown="event.stopPropagation()" onclick="downloadPdf(event)" title="ë‹¤ìš´ë¡œë“œ">
        <svg viewBox="0 0 24 24"><path d="M14,2L20,8V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2H14M18,20V9H13V4H6V20H18M12,19L8,15H10.5V11H13.5V15H16L12,19Z"/></svg>
      </div>
      <div id="audioBtn" class="v-icon-btn" onmousedown="event.stopPropagation()" onclick="toggleAudioPanel(event)" title="ì˜¤ë””ì˜¤">
        <svg viewBox="0 0 24 24"><path d="M12,2A3,3 0 0,0 9,5V11A3,3 0 0,0 12,14A3,3 0 0,0 15,11V5A3,3 0 0,0 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,1 12,16A5,5 0 0,1 17,11H19Z"/></svg>
        <span>(Audio)</span>
      </div>
    </div>
  </div>
  
  <div id="audioPanel" onmousedown="event.stopPropagation()" onclick="event.stopPropagation()">
    <div class="audio-ctrl-row">
      <button id="playBtn" class="audio-btn">â–¶</button>
      <input type="range" id="audioProgress" value="0" onmousedown="event.stopPropagation()">
      <span id="audioTime" style="font-size:11px; font-weight:800; color:var(--navy); width:40px; text-align:center;">00:00</span>
    </div>
    <div class="volume-row">
      ğŸ”Š <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="1" onmousedown="event.stopPropagation()">
    </div>
  </div>

  <div id="viewerBody" class="viewer-body">
    <div id="pageContainer"></div>
  </div>

  <div id="progressHitArea" class="progress-hit-area" onmousedown="event.stopPropagation()">
    <div class="progress-track">
      <div id="pageFill" class="progress-fill">
        <div class="progress-handle"></div>
        <div id="progressFlag" class="progress-flag">0 / 0</div>
      </div>
    </div>
  </div>
</div>

<audio id="mainAudio"></audio>

<div class="bottom-nav">
  <div class="nav-item" onclick="history.back()">
    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    ë’¤ë¡œê°€ê¸°
  </div>
  <div class="nav-item" onclick="location.href='index.html'">
    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    í™ˆìœ¼ë¡œ
  </div>
  <!-- [ìˆ˜ì •] ëª¨ë°”ì¼ í•˜ë‹¨ ì£¼/ì•¼ê°„ ë²„íŠ¼ -->
  <div class="nav-item mobile-only-nav" onclick="toggleThemeMobile()">
    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,5.29C7.24,6.03 7.06,6.79 7,7.59C6.94,8.39 7.03,9.19 7.26,9.95L3.34,7M3.36,17L7.26,14.04C7.03,14.81 6.94,15.61 7,16.41C7.06,17.21 7.24,17.97 7.5,18.71L3.36,17M20.65,7L16.74,9.95C16.97,9.19 17.06,8.39 17,7.59C16.94,6.79 16.76,6.03 16.5,5.29L20.65,7M20.64,17L16.5,18.71C16.76,17.97 16.94,17.21 17,16.41C17.06,15.61 16.97,14.81 16.74,14.04L20.64,17M12,22L9.61,18.58C10.35,18.85 11.16,19 12,19C12.84,19 13.65,18.85 14.39,18.58L12,22Z"/></svg>
    í…Œë§ˆ
  </div>
</div>

<div class="creator-info">Developed by <b>DooSeok, JANG</b> (jds0616@airport.co.kr)</div>

<script>
  // [ìˆ˜ì • 3] PDFJS ì›Œì»¤ ì„¤ì • (ê¸°ì¡´ ìœ ì§€)
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";

  // [ìˆ˜ì • 4] Firebase ì„¤ì • ë° ì´ˆê¸°í™”
  const firebaseConfig = {
    apiKey: "AIzaSyAUt6WqxWjRoB9xgAWXq2YhVMQutaOZCBc",
    authDomain: "catc-dfb9a.firebaseapp.com",
    databaseURL: "https://catc-dfb9a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "catc-dfb9a",
    storageBucket: "catc-dfb9a.firebasestorage.app",
    messagingSenderId: "669905270724",
    appId: "1:669905270724:web:c89fcc1d9c8f81b3071691",
    measurementId: "G-H1ME51B4MZ"
  };


  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  const params = new URLSearchParams(location.search);
  const type = params.get('type');
  const menuName = params.get('menu');
  const menuId = params.get('id');
  
  let isAdmin = localStorage.getItem('kac_admin_mode') === '1';
  let isPreview = localStorage.getItem('kac_preview_active') === '1';

  let subjects = [];
  let currentMenuData = null;
  let allData = null; // ì „ì²´ ë°ì´í„°ë¥¼ ë‹´ì„ ë³€ìˆ˜ (ì €ì¥ìš©)

  // ë·°ì–´ ê´€ë ¨ ë³€ìˆ˜
  let pdfDoc = null, pageNum = 1, isRendering = false, isDragging = false;
  const canvasContainer = document.getElementById('pageContainer');
  const viewerBody = document.getElementById('viewerBody');
  const overlay = document.getElementById('pdfOverlay');
  const hitArea = document.getElementById('progressHitArea');
  const audioPlayer = document.getElementById('mainAudio');
  const searchInput = document.getElementById('searchInput');
  const searchDropdown = document.getElementById('searchDropdown');
  const sOverlay = document.getElementById('searchOverlay');
  let allSubjectsIndex = [];

  // [ìˆ˜ì • 5] ì„¤ì • ëª¨ë‹¬ ì—´ê¸° (ë²„íŠ¼ ì œì–´ ì¶”ê°€)
  function openSettings() {
    const modal = document.getElementById('settingsModal');
    const adminBtn = document.getElementById('modalAdminBtn');
    const batchGroup = document.getElementById('batchAdminGroup');
    const previewBtn = document.getElementById('modalPreviewBtn');
    const saveBtn = document.getElementById('btnSaveServer'); // ì €ì¥ ë²„íŠ¼

    if(isAdmin) {
        if(adminBtn) adminBtn.textContent = "ë¡œê·¸ì•„ì›ƒ";
        if(batchGroup) batchGroup.style.display = 'block'; 
        if(saveBtn) saveBtn.style.display = 'block'; // ê´€ë¦¬ìì¼ ë•Œ ì €ì¥ ë²„íŠ¼ í‘œì‹œ
        if(previewBtn) {
            previewBtn.style.display = 'block'; 
            previewBtn.textContent = isPreview ? "ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸° ì¢…ë£Œ" : "ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸° ì‹œì‘";
            previewBtn.className = isPreview ? "btn-modal btn-preview-active" : "btn-modal btn-secondary";
        }
    } else {
        if(adminBtn) adminBtn.textContent = "ê´€ë¦¬ì ë¡œê·¸ì¸";
        if(batchGroup) batchGroup.style.display = 'none'; 
        if(saveBtn) saveBtn.style.display = 'none';
        if(previewBtn) previewBtn.style.display = 'none'; 
    }

    const currentPos = localStorage.getItem('kac_tree_pos') || 0;
    const range = document.getElementById('treePosRange');
    const valDisplay = document.getElementById('treePosVal');
    if(range) range.value = currentPos;
    if(valDisplay) valDisplay.textContent = currentPos;

    modal.style.display = 'flex';
  }

  // [ìˆ˜ì • 6] ì´ˆê¸°í™” í•¨ìˆ˜ (Firebase ì—°ë™)
  async function init() {
    try {
        setTheme(localStorage.getItem('kac_theme') || 'light');
        if(isAdmin) document.body.classList.add('admin-mode');
        if(isPreview) document.body.classList.add('preview-active');
        
        // 1. ìµëª… ë¡œê·¸ì¸ (DB ì½ê¸° ê¶Œí•œ)
        if (!auth.currentUser) {
            await auth.signInAnonymously();
        }

        // 2. Firebase ë°ì´í„° ë¡œë“œ
        const snapshot = await db.ref('/').once('value');
        if (snapshot.exists()) {
            allData = snapshot.val(); // ì „ì²´ ë°ì´í„° ë©”ëª¨ë¦¬ì— ì €ì¥ (ì €ì¥ì‹œ ì‚¬ìš©)
            
            // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
            const currentCat = allData.categories ? allData.categories.find(c => c && c.id === type) : null;
            
            if(currentCat && currentCat.menus) {
                // í˜„ì¬ ë©”ë‰´ ì°¾ê¸°
                const currentMenu = currentCat.menus.find(m => m.id === menuId);
                if(currentMenu) {
                    subjects = currentMenu.subjects || [];
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™” (ì˜¤í”„ë¼ì¸/ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
                    localStorage.setItem(`kac_subs_${type}_${menuId}`, JSON.stringify(subjects));
                }
            }
        }

        // 3. ë¡œì»¬ ë°ì´í„° í´ë°± (ì„œë²„ ì‹¤íŒ¨ì‹œ)
        if (!subjects || subjects.length === 0) {
            const localData = localStorage.getItem(`kac_subs_${type}_${menuId}`);
            if (localData) subjects = JSON.parse(localData);
        }

        // 4. ë©”ë‰´ ì •ë³´ ì„¸íŒ…
        const menuList = JSON.parse(localStorage.getItem(`kac_menu_${type}`) || '[]');
        currentMenuData = menuList.find(m => m.dataId === menuId) || { label: menuName, line1: 'Tag' };

        // 5. ìŠ¤íƒ€ì¼ ì ìš©
        const sData = localStorage.getItem(`kac_style_${type}`);
        const style = sData ? JSON.parse(sData) : { name: type, color: '#2563eb' };
        applyStyles(style);

        // 6. UI ë Œë”ë§
        const savedPos = localStorage.getItem('kac_tree_pos') || 0;
        document.documentElement.style.setProperty('--tree-pos-x', savedPos + 'px');

        render();
        buildSearchIndex();
        checkAutoOpen();
        renderSidebar();

    } catch (err) {
        console.error("Init Error:", err);
        alert("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // [ìˆ˜ì • 7] íŒŒì´ì–´ë² ì´ìŠ¤ ì €ì¥ í•¨ìˆ˜ (ë¬¸êµ¬ ë° UI í”¼ë“œë°± ê°•í™”)
  async function saveToFirebase() {
      if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
      
      if(!confirm("í˜„ì¬ ëª©ë¡ì˜ ë³€ê²½ì‚¬í•­(ì¶”ê°€, ìˆ˜ì •, ì‚­ì œ)ì„ ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì €ì¥ í›„ì—ëŠ” ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.")) return;

      const btn = document.getElementById('btnSaveServer');
      const originalText = btn.innerText;
      
      btn.innerText = "ì„œë²„ ì „ì†¡ ì¤‘...";
      btn.disabled = true;

      try {
          if(!allData || !allData.categories) {
              const snap = await db.ref('/').once('value');
              allData = snap.val();
          }

          if (!allData || !allData.categories) throw new Error("ì„œë²„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          const catIndex = allData.categories.findIndex(c => c && c.id === type);
          if (catIndex !== -1) {
              const menus = allData.categories[catIndex].menus || [];
              const menuIndex = menus.findIndex(m => m.id === menuId);
              
              if (menuIndex !== -1) {
                  // í˜„ì¬ ìˆ˜ì •ëœ subjects ë°°ì—´ì„ ì „ì²´ ë°ì´í„° êµ¬ì¡°ì— ì‚½ì…
                  allData.categories[catIndex].menus[menuIndex].subjects = subjects;
                  
                  if(!allData.meta) allData.meta = {};
                  allData.meta.lastUpdated = new Date().toISOString();

                  await db.ref('/').set(allData); // ì„œë²„ ë®ì–´ì“°ê¸°
                  alert("âœ… ì„œë²„ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
              } else {
                  throw new Error("ì„œë²„ ë°ì´í„°ì—ì„œ í˜„ì¬ ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }
          } else {
              throw new Error("ì„œë²„ ë°ì´í„°ì—ì„œ í˜„ì¬ ì‹œì„¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
      } catch(e) {
          console.error(e);
          alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message);
      } finally {
          btn.innerText = originalText;
          btn.disabled = false;
      }
  }

  // [ìˆ˜ì • 8] ê´€ë¦¬ì ë¡œê·¸ì¸ (DB ë¹„ë²ˆ ì²´í¬)
  async function toggleAdmin() {
    if(isAdmin) { 
        if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
            localStorage.setItem('kac_admin_mode','0'); 
            location.reload(); 
        } 
    } else { 
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"); 
        if(!pw) return;
        
        try {
            const inputHash = await sha256(pw.toUpperCase());
            const snapshot = await db.ref('security/admin_pw').once('value');
            let serverHash = snapshot.val();
            if(!serverHash) serverHash = "db2d3257df630ebeb488b0a9435b863702a0a25694205626359045b8427f311c"; // Default

            if(inputHash === serverHash) { 
                localStorage.setItem('kac_admin_mode','1'); 
                location.reload(); 
            } else { 
                alert('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜');
            }
        } catch(e) {
            alert("ì¸ì¦ ì˜¤ë¥˜");
        }
    } 
  }

  // --- ê¸°ì¡´ ë¡œì§ ìœ ì§€ (ë Œë”ë§, ë·°ì–´, ì‚¬ì´ë“œë°” ë“±) ---

  function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      const ov = document.getElementById('sidebarOverlay');
      sb.classList.toggle('active');
      ov.classList.toggle('active');
  }

function renderSidebar() {
      const content = document.getElementById('sidebarContent');
      content.innerHTML = '';
      const order = JSON.parse(localStorage.getItem('kac_index_order') || '[]');
      
      order.forEach(tid => {
          if(!tid) return;
          const style = JSON.parse(localStorage.getItem(`kac_style_${tid}`) || '{}');
          
          const acc = style.access || { visible: true, adminOnly: false, showSidebar: true };
          if (!acc.visible || !acc.showSidebar) return;
          if (acc.adminOnly && !isAdmin) return;
          
          const isActive = tid === type; 
          const itemClass = isActive ? 'sb-item active' : 'sb-item';
          const menus = JSON.parse(localStorage.getItem(`kac_menu_${tid}`) || '[]');
          
          let subHtml = '';
          let validMenuCount = 0; 

          if(menus.length > 0) {
              const listClass = isActive ? 'sb-sub-list open' : 'sb-sub-list';
              let tempHtml = `<div class="${listClass}" id="sb-sub-${tid}">`;
              
              menus.forEach(m => {
                  const isMenuVisible = (m.visible !== undefined) ? m.visible : true;
                  if(isMenuVisible) {
                      validMenuCount++;
                      const isSubActive = (tid === type && m.dataId === menuId);
                      const subClass = isSubActive ? 'sb-sub-item active' : 'sb-sub-item';
                      tempHtml += `<div class="${subClass}" onclick="location.href='viewer_list.html?type=${tid}&menu=${encodeURIComponent(m.label)}&id=${m.dataId}'">
                          ${m.label}
                      </div>`;
                  }
              });
              tempHtml += '</div>';
              if(validMenuCount > 0) subHtml = tempHtml;
          }

          const arrow = validMenuCount > 0 ? `<span class="sb-toggle">${isActive ? 'â–¼' : 'â–¶'}</span>` : '';
          let namePrefix = (isAdmin && acc.adminOnly) ? "(ê´€ë¦¬ì) " : "";

          const item = document.createElement('div');
          item.innerHTML = `
            <div class="${itemClass}" onclick="toggleSubMenu('${tid}', this)">
                <span style="display:flex;align-items:center;gap:10px;">
                    <span style="width:10px;height:10px;border-radius:50%;background:${style.color || '#2563eb'}"></span>
                    ${namePrefix}${style.name || tid}
                </span>
                ${arrow}
            </div>
            ${subHtml}
          `;
          content.appendChild(item);
      });
  }

  function toggleSubMenu(id, el) {
      const list = document.getElementById(`sb-sub-${id}`);
      if(list) {
          const toggleIcon = el.querySelector('.sb-toggle');
          if(list.classList.contains('open')) {
              list.classList.remove('open');
              if(toggleIcon) toggleIcon.innerText = 'â–¶';
          } else {
              list.classList.add('open');
              if(toggleIcon) toggleIcon.innerText = 'â–¼';
          }
      } else {
          location.href = `facility.html?type=${id}`;
      }
  }

  window.addEventListener('pageshow', () => {
      const savedStatus = localStorage.getItem('kac_admin_mode') === '1';
      if (isAdmin !== savedStatus) location.reload();
      const savedPreview = localStorage.getItem('kac_preview_active') === '1';
      if(isPreview !== savedPreview) location.reload();
  });

  window.addEventListener('storage', (e) => {
      if (e.key === 'kac_admin_mode' || e.key === 'kac_preview_active') location.reload();
  });

  function loadSubjectsFromLocal() {
      if(!type || !menuId) return false;
      const data = localStorage.getItem(`kac_subs_${type}_${menuId}`);
      if (data) {
          try { subjects = JSON.parse(data); return true; } catch(e) { return false; }
      }
      return false;
  }

  function applyStyles(style) {
      const typeName = style.name || type || 'Unknown';
      const themeColor = style.color || '#2563eb';
      document.documentElement.style.setProperty('--theme-color', themeColor);
      document.documentElement.style.setProperty('--theme-rgb', hexToRgb(themeColor));
      const bc = document.getElementById('breadcrumbContainer');
      if(bc) {
          bc.innerHTML = '';
          const midSpan = document.createElement('span');
          midSpan.innerHTML = ` &nbsp;>&nbsp; ${typeName}`;
          midSpan.className = 'crumb-link';
          midSpan.onclick = () => location.href = `facility.html?type=${type}`;
          const currSpan = document.createElement('span');
          currSpan.innerHTML = ` &nbsp;>&nbsp; ${menuName || 'ìƒì„¸'}`;
          currSpan.className = 'crumb-current';
          bc.appendChild(midSpan);
          bc.appendChild(currSpan);
      }
  }

  function hexToRgb(hex) {
    let c;
    if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
        c= hex.substring(1).split('');
        if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
        c= '0x'+c.join('');
        return [(c>>16)&255, (c>>8)&255, c&255].join(',');
    }
    return '37, 99, 235'; 
  }

  function checkHeaderOverlap() {
    const left = document.getElementById('headerLeft');
    const center = document.getElementById('headerCenter');
    if(!left || !center) return;
    if (left.getBoundingClientRect().right + 20 > center.getBoundingClientRect().left) {
        document.body.classList.add('header-overlap');
    } else {
        document.body.classList.remove('header-overlap');
    }
  }
  window.addEventListener('resize', checkHeaderOverlap);
  window.addEventListener('load', checkHeaderOverlap);

  function setTheme(mode) {
    document.body.className = (document.body.className.replace('dark-mode','').trim() + (mode==='dark' ? ' dark-mode' : '')).trim();
    localStorage.setItem('kac_theme', mode);
    document.getElementById('btnDay').classList.toggle('active', mode==='light');
    document.getElementById('btnNight').classList.toggle('active', mode==='dark');
  }

  // [ì¶”ê°€] ëª¨ë°”ì¼ìš© í…Œë§ˆ í† ê¸€ í•¨ìˆ˜
  function toggleThemeMobile() {
      const current = localStorage.getItem('kac_theme') || 'light';
      setTheme(current === 'light' ? 'dark' : 'light');
  }

  async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  function togglePreview() {
    isPreview = !isPreview;
    localStorage.setItem('kac_preview_active', isPreview ? '1' : '0');
    document.body.classList.toggle('preview-active', isPreview);
    location.reload();
  }

  function updateTreePos(val) {
      document.documentElement.style.setProperty('--tree-pos-x', val + 'px');
      document.getElementById('treePosVal').textContent = val;
      localStorage.setItem('kac_tree_pos', val);
  }

  let currentEditIdx = -1;
  let viewingIndex = -1; 

  async function render() {
    const list = document.getElementById('subjectList'); list.innerHTML = '';
    const lastViewedId = sessionStorage.getItem('kac_last_viewed_id');

    const treeContainer = document.createElement('div');
    treeContainer.className = 'tree-container';
    
    // [ìˆ˜ì •] ìƒë‹¨ ëª…í•¨ ë°•ìŠ¤ ìƒì„± ë° í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    const facCard = document.createElement('div');
    facCard.className = 'fac-top-card'; 
    facCard.onclick = () => location.href = `facility.html?type=${type}`; // í´ë¦­ ì‹œ ìƒìœ„ ì´ë™

    const leftGroup = document.createElement('div');
    leftGroup.className = 'fac-left-group';

    const tag = document.createElement('div');
    tag.className = 'fac-tag-pill';
    tag.textContent = currentMenuData ? (currentMenuData.line1 || 'Tag') : 'Tag';
    
    const title = document.createElement('div');
    title.className = 'fac-title';
    title.textContent = currentMenuData ? currentMenuData.label : (menuName || "êµìœ¡ ê³¼ì • ëª©ë¡");

    leftGroup.appendChild(tag);
    leftGroup.appendChild(title);
    facCard.appendChild(leftGroup);

    if(isAdmin && !isPreview) {
        const rightGroup = document.createElement('div');
        rightGroup.className = 'ctrl-btns';
        rightGroup.innerHTML = `
            <button class="btn-action" style="cursor:not-allowed; opacity:0.6;">ìˆ˜ì •</button>
            <button class="btn-action btn-del" style="cursor:not-allowed; opacity:0.6;">ì‚­ì œ</button>
        `;
        rightGroup.onclick = (e) => e.stopPropagation();
        facCard.appendChild(rightGroup);
    }

    treeContainer.appendChild(facCard);

    const spine = document.createElement('div');
    spine.className = 'tree-spine';
    treeContainer.appendChild(spine);

    if(subjects.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.padding = '50px';
        emptyMsg.style.color = 'var(--text-sub)';
        emptyMsg.style.opacity = '0.7';
        emptyMsg.innerHTML = `<div style="font-size:40px; margin-bottom:10px;">ğŸ“­</div><div style="font-weight:700;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        treeContainer.appendChild(emptyMsg);
    }

    for (let i = 0; i < subjects.length; i++) {
      const sub = subjects[i];
      const isActive = sub.active !== false; 
      const hasPdf = !!sub.pdfName;
      const hasAudio = !!sub.audioName;
      const hasLink = !!sub.link;
      
      const wrapper = document.createElement('div');
      wrapper.className = 'card-wrapper';

      const card = document.createElement('div'); 
      const isLast = lastViewedId === sub.id;
      card.className = `subject-card ${isActive ? '' : 'inactive'} ${isLast ? 'last-viewed' : ''}`;
      card.id = `card-${i}`; 

      if(isAdmin && !isPreview) {
        card.setAttribute('draggable', 'true');
        card.ondragstart = (e) => handleDragStart(e, i);
        card.ondragover = (e) => handleDragOver(e);
        card.ondrop = (e) => handleDrop(e, i);
        card.ondragend = (e) => handleDragEnd(e);
      }
      
      card.onclick = () => { 
        if(!isActive) { 
            if(isAdmin) { if(!confirm("í˜„ì¬ ê°œë°œ ì¤‘ì¸ ê³¼ì •ì…ë‹ˆë‹¤.\nê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì—´ëŒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; } 
            else { alert("í˜„ì¬ ê³¼ì • ê°œë°œì¤‘ìœ¼ë¡œ ì‚¬ìš© ë¶ˆê°€í•©ë‹ˆë‹¤."); return; }
        } 
        sessionStorage.setItem('kac_last_viewed_id', sub.id);
        document.querySelectorAll('.subject-card').forEach(c => c.classList.remove('last-viewed'));
        card.classList.add('last-viewed');
        if(hasLink) { window.open(sub.link, '_blank'); return; }
        openViewer(i); 
      };

      const statusTag = isActive ? '' : '<span class="status-pill dev">ğŸš§ ê°œë°œì¤‘</span>';
      const moveBtn = (isAdmin && !isPreview) ? `<button class="btn-action" onclick="event.stopPropagation(); openMoveModal(${i})" title="ì´ë™"><svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M20,6h-8l-2-2H4C2.89,4,2,4.89,2,6v12c0,1.1,0.89,2,2,2h16c1.1,0,2-0.9,2-2V8C22,6.9,21.1,6,20,6z M20,18H4V6h5.17l2,2H20V18z M12,14h2v2h-2v2l-3.5-3.5L12,11V14z"/></svg> ì´ë™</button>` : '';

      const pdfLabel = hasPdf 
        ? `<span class="status-pill on"><span class="pill-icon">ğŸ“„</span> <span class="status-text">PDF ${sub.pdfName}</span></span>` 
        : `<span class="status-pill"><span class="pill-icon">ğŸ“„</span> <span class="status-text">PDF ë¯¸ë“±ë¡</span></span>`;
        
      const audioLabel = hasAudio 
        ? `<span class="status-pill on"><span class="pill-icon">ğŸ§</span> <span class="status-text">Audio ${sub.audioName}</span></span>` 
        : `<span class="status-pill"><span class="pill-icon">ğŸ§</span> <span class="status-text">Audio ë¯¸ë“±ë¡</span></span>`;

      card.innerHTML = `
        <div class="last-viewed-icon">
            <!-- PCìš© ëˆˆ ì•„ì´ì½˜ (ì •ìƒ ì½”ë“œ) -->
            <svg class="icon-pc" viewBox="0 0 24 24" style="width:14px;height:14px;fill:currentColor;">
                <path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/>
            </svg>
            
            <!-- ëª¨ë°”ì¼ìš© ì²´í¬ ì•„ì´ì½˜ (ì •ìƒ ì½”ë“œ) -->
            <svg class="icon-mobile" viewBox="0 0 24 24" style="width:14px;height:14px;fill:currentColor;">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>

            <span>Last Viewed</span>
        </div>
        <div>
            <div class="subj-title">${statusTag} ${sub.name}</div>
            <div class="status-group">
                ${pdfLabel}
                ${audioLabel}
                ${hasLink ? `<span class="status-pill link">ğŸ”— <span class="status-text">Link ì—°ê²°ë¨</span></span>` : ''}
            </div>
        </div>
        <div class="ctrl-btns">${(isAdmin && !isPreview) ? `${moveBtn}<button class="btn-action" onclick="event.stopPropagation(); openUploadMenu(${i})">ìˆ˜ì •</button><button class="btn-action btn-del" onclick="event.stopPropagation(); deleteSubject(${i})">ì‚­ì œ</button>` : `<button class="btn-action" style="visibility:hidden">.</button>`}</div>`;
      
      wrapper.appendChild(card);
      treeContainer.appendChild(wrapper);
    }

    if(isAdmin && !isPreview) {
      const wrapper = document.createElement('div');
      wrapper.className = 'card-wrapper';
      const addBtn = document.createElement('div');
      addBtn.className = 'subject-card add-card';
      addBtn.innerHTML = '+ ìƒˆë¡œìš´ êµìœ¡ ê³¼ì •(Subject) ì¶”ê°€';
      addBtn.onclick = () => { const n = prompt("ìƒˆ ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"); if(n) { subjects.push({ id: Date.now().toString(), name: n, active: true }); saveSubjects(); } };
      wrapper.appendChild(addBtn);
      treeContainer.appendChild(wrapper);
    }
    
    list.appendChild(treeContainer);

    checkAutoOpen();
    checkHeaderOverlap();
    
    if(lastViewedId) {
        const activeCard = document.querySelector('.subject-card.last-viewed');
        if(activeCard) {
             setTimeout(() => activeCard.scrollIntoView({ behavior: 'smooth', block: 'center' }), 500);
        }
    }
  }

  function saveFiles() {
    const idx = currentEditIdx;
    const name = document.getElementById('editSubjectName').value;
    const isActiveStr = document.getElementById('editActiveStatus').value; 
    
    if(!name) return alert("ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    
    subjects[idx].name = name;
    subjects[idx].active = (isActiveStr === 'true');
    subjects[idx].pdfName = document.getElementById('inputPdfName').value.trim();
    subjects[idx].link = document.getElementById('inputLinkUrl').value.trim();

    let aPath = document.getElementById('inputAudioName').value.trim();
    const aExt = document.getElementById('inputAudioExt').value;
    
    if (aPath) {
        if(aPath.startsWith('/')) aPath = aPath.substring(1);
        
        if(aPath.toLowerCase().endsWith('.mp3')) aPath = aPath.slice(0, -4);
        if(aPath.toLowerCase().endsWith('.wav')) aPath = aPath.slice(0, -4);
        
        subjects[idx].audioName = aPath + aExt; 
    } else {
        subjects[idx].audioName = '';
    }
    
    saveSubjects();
    document.getElementById('uploadModal').style.display = 'none';
  }

  function openUploadMenu(idx) { 
    currentEditIdx = idx; 
    const sub = subjects[idx];
    document.getElementById('editSubjectName').value = sub.name; 
    document.getElementById('editActiveStatus').value = (sub.active !== false).toString();
    document.getElementById('inputPdfName').value = sub.pdfName || '';
    document.getElementById('inputLinkUrl').value = sub.link || '';

    let aFull = sub.audioName || '';
    let aPath = aFull;
    let aExt = '.mp3';

    if (aFull.toLowerCase().endsWith('.wav')) {
        aExt = '.wav';
        aPath = aFull.slice(0, -4);
    } else if (aFull.toLowerCase().endsWith('.mp3')) {
        aExt = '.mp3';
        aPath = aFull.slice(0, -4);
    }

    document.getElementById('inputAudioName').value = aPath;
    document.getElementById('inputAudioExt').value = aExt;

    document.getElementById('uploadModal').style.display = 'flex'; 
  }

  let movingSubjectIndex = -1;
  function openMoveModal(idx) {
    movingSubjectIndex = idx;
    const select = document.getElementById('moveTargetSelect');
    select.innerHTML = '<option value="">-- ì´ë™í•  ë©”ë‰´ ì„ íƒ --</option>';
    const types = JSON.parse(localStorage.getItem('kac_index_order') || '[]');
    
    types.forEach(t => {
      if(!t) return;
      const menus = JSON.parse(localStorage.getItem(`kac_menu_${t}`) || '[]');
      const style = JSON.parse(localStorage.getItem(`kac_style_${t}`) || '{}');
      if(menus.length > 0) {
        const group = document.createElement('optgroup');
        group.label = style.name || t;
        menus.forEach(m => {
          if (t === type && m.dataId === menuId) return;
          const option = document.createElement('option');
          option.value = `${t}|${m.dataId}`;
          option.textContent = m.label;
          group.appendChild(option);
        });
        if (group.children.length > 0) select.appendChild(group);
      }
    });
    document.getElementById('moveModal').style.display = 'flex';
  }

  function executeMove() {
    const value = document.getElementById('moveTargetSelect').value;
    if(!value) return alert("ì„ íƒí•´ì£¼ì„¸ìš”.");
    const [targetType, targetMenuId] = value.split('|');
    const subjectToMove = subjects[movingSubjectIndex];
    const targetKey = `kac_subs_${targetType}_${targetMenuId}`;
    const targetSubjects = JSON.parse(localStorage.getItem(targetKey) || '[]');
    targetSubjects.push(subjectToMove);
    localStorage.setItem(targetKey, JSON.stringify(targetSubjects));
    subjects.splice(movingSubjectIndex, 1);
    saveSubjects();
    alert("ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.");
    document.getElementById('moveModal').style.display = 'none';
  }

  function saveSubjects() { localStorage.setItem(`kac_subs_${type}_${menuId}`, JSON.stringify(subjects)); render(); }
  
  // [ìˆ˜ì •] ê³¼ëª© ì‚­ì œ í•¨ìˆ˜ (ì„œë²„ ë¹„ë²ˆ í™•ì¸ ë° ë¡œì§ ë³´ê°•)
  async function deleteSubject(i) {
    const subName = subjects[i].name;
    if(!confirm(`'${subName}' ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ì¦‰ì‹œ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

    const input = prompt("ì‚­ì œë¥¼ í™•ì •í•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    if (!input) return;

    try {
        const inputHash = await sha256(input.toUpperCase());
        // Firebaseì—ì„œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        const snapshot = await db.ref('security/admin_pw').once('value');
        let serverHash = snapshot.val();
        if(!serverHash) serverHash = "db2d3257df630ebeb488b0a9435b863702a0a25694205626359045b8427f311c";

        if(inputHash === serverHash) {
            subjects.splice(i, 1); // ë°°ì—´ì—ì„œ ì‚­ì œ
            saveSubjects(); // UI ì—…ë°ì´íŠ¸ ë° ë¡œì»¬ ì €ì¥
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nìµœì¢… ë°˜ì˜ì„ ìœ„í•´ ë°˜ë“œì‹œ 'ì„œë²„ì— ë³€ê²½ì‚¬í•­ ì €ì¥' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    } catch(e) {
        console.error(e);
        alert("ì¸ì¦ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  function openBatchAddModal() {
    if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
    document.getElementById('batchModalTitle').textContent = "ğŸ“‹ ì¼ê´„ ìë£Œ ë“±ë¡ (ì‹ ê·œ ì¶”ê°€)";
    const tbody = document.getElementById('batchTbody'); tbody.innerHTML = '';
    for(let i=0; i<30; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td><input type="text" class="batch-input" placeholder="ê³¼ëª©ëª…" name="name"></td><td><input type="text" class="batch-input" placeholder="PDF ê²½ë¡œ" name="pdf"></td><td><input type="text" class="batch-input" placeholder="ë§í¬ ì£¼ì†Œ" name="link"></td><td><input type="text" class="batch-input" placeholder="ì˜¤ë””ì˜¤ ê²½ë¡œ" name="audio"></td>`;
        tbody.appendChild(tr);
    }
    document.getElementById('batchSaveBtn').onclick = saveBatchAddData;
    document.getElementById('settingsModal').style.display = 'none';
    document.getElementById('batchModal').style.display = 'flex';
  }

  function openBatchEditModal() {
    if(!isAdmin) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
    document.getElementById('batchModalTitle').textContent = "ğŸ“‹ ì¼ê´„ ìë£Œ ìˆ˜ì • (ê¸°ì¡´ ëª©ë¡)";
    const tbody = document.getElementById('batchTbody'); tbody.innerHTML = '';
    subjects.forEach((sub, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td><input type="text" class="batch-input" value="${sub.name}" name="name" data-idx="${i}"></td><td><input type="text" class="batch-input" value="${sub.pdfName || ''}" name="pdf" data-idx="${i}"></td><td><input type="text" class="batch-input" value="${sub.link || ''}" name="link" data-idx="${i}"></td><td><input type="text" class="batch-input" value="${sub.audioName || ''}" name="audio" data-idx="${i}"></td>`;
        tbody.appendChild(tr);
    });
    document.getElementById('batchSaveBtn').onclick = saveBatchEditData;
    document.getElementById('settingsModal').style.display = 'none';
    document.getElementById('batchModal').style.display = 'flex';
  }

  function saveBatchAddData() {
    const rows = document.querySelectorAll('#batchTbody tr');
    let addedCount = 0;
    for(const row of rows) {
        const name = row.querySelector('input[name="name"]').value.trim();
        const pdf = row.querySelector('input[name="pdf"]').value.trim();
        const link = row.querySelector('input[name="link"]').value.trim();
        const audio = row.querySelector('input[name="audio"]').value.trim();
        if(name) {
            const newId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
            subjects.push({ id: newId, name: name, active: true, pdfName: pdf, link: link, audioName: audio });
            addedCount++;
        }
    }
    if(addedCount > 0) { 
        saveSubjects(); 
        alert(`${addedCount}ê°œ ê³¼ëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nìµœì¢… ë°˜ì˜ì„ ìœ„í•´ 'ì„œë²„ì— ì €ì¥' ë²„íŠ¼ì„ ê¼­ ëˆŒëŸ¬ì£¼ì„¸ìš”.`); 
        document.getElementById('batchModal').style.display = 'none'; 
    } 
    else { alert("ì…ë ¥ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤."); }
  }

  function saveBatchEditData() {
    const rows = document.querySelectorAll('#batchTbody tr');
    let updatedCount = 0;
    for(const row of rows) {
        const nameInput = row.querySelector('input[name="name"]');
        const idx = parseInt(nameInput.getAttribute('data-idx'));
        if(subjects[idx]) {
            subjects[idx].name = nameInput.value.trim();
            subjects[idx].pdfName = row.querySelector('input[name="pdf"]').value.trim();
            subjects[idx].link = row.querySelector('input[name="link"]').value.trim();
            subjects[idx].audioName = row.querySelector('input[name="audio"]').value.trim();
            updatedCount++;
        }
    }
    if(updatedCount > 0) { 
        saveSubjects(); 
        alert(`ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\nìµœì¢… ë°˜ì˜ì„ ìœ„í•´ 'ì„œë²„ì— ì €ì¥' ë²„íŠ¼ì„ ê¼­ ëˆŒëŸ¬ì£¼ì„¸ìš”.`); 
        document.getElementById('batchModal').style.display = 'none'; 
    }
  }

  function buildSearchIndex() {
    allSubjectsIndex = [];
    try {
        const order = JSON.parse(localStorage.getItem('kac_index_order') || '[]');
        order.forEach(t => {
            if(!t) return;
            const ms = JSON.parse(localStorage.getItem(`kac_menu_${t}`) || '[]');
            const s = JSON.parse(localStorage.getItem(`kac_style_${t}`) || '{}');
            ms.forEach(m => {
                const subData = localStorage.getItem(`kac_subs_${t}_${m.dataId}`);
                if(subData) {
                    JSON.parse(subData).forEach(sub => {
                        allSubjectsIndex.push({ 
                            name: sub.name, type: t, code: s.code || t.substring(0,1), 
                            menuName: m.label, menuId: m.dataId, subId: sub.id, 
                            active: sub.active !== false, link: sub.link, color: s.color 
                        });
                    });
                }
            });
        });
    } catch(e) { console.error("Search Index Build Error", e); }
  }

  if(searchInput) {
    searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim().toLowerCase();
        if(query.length === 0) { searchDropdown.classList.remove('active'); return; }
        const matches = allSubjectsIndex.filter(item => item.name.toLowerCase().includes(query) || item.menuName.toLowerCase().includes(query));
        renderSearchResults(matches, query);
    });
    
    searchInput.addEventListener('focus', () => { 
        document.body.classList.add('search-mode');
        sOverlay.classList.add('active');
        if(searchInput.value.trim().length > 0) searchDropdown.classList.add('active'); 
    });
  }
  
  if(sOverlay) {
    sOverlay.addEventListener('click', () => {
        document.body.classList.remove('search-mode');
        sOverlay.classList.remove('active');
        searchDropdown.classList.remove('active');
    });
  }

  function renderSearchResults(list, query) {
    searchDropdown.innerHTML = ''; searchDropdown.classList.add('active');
    if(list.length === 0) { searchDropdown.innerHTML = `<div style="padding:15px; text-align:center; opacity:0.6;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`; return; }
    list.forEach(item => {
      const div = document.createElement('div'); div.className = 'result-item';
      const highlightName = item.name.replace(new RegExp(`(${query})`, 'gi'), `<span style="color:${item.color}; font-weight:900;">$1</span>`);
      div.innerHTML = `<div class="result-info"><div class="res-title">${highlightName}</div><div class="res-path">${item.type} > ${item.menuName}</div></div><div class="res-tag" style="background:${item.color}">${item.code}</div>`;
      div.onclick = () => { 
        if(!item.active && !isAdmin) { alert("í˜„ì¬ ê³¼ì • ê°œë°œì¤‘ìœ¼ë¡œ ì‚¬ìš© ë¶ˆê°€í•©ë‹ˆë‹¤."); return; } 
        if(item.link) { window.open(item.link, '_blank'); return; }
        location.href = `viewer_list.html?type=${item.type}&menu=${encodeURIComponent(item.menuName)}&id=${item.menuId}&autoOpen=${item.subId}`; 
      };
      searchDropdown.appendChild(div);
    });
  }

  function checkAutoOpen() {
    const autoId = params.get('autoOpen');
    if(autoId && subjects.length > 0) { 
        const targetIdx = subjects.findIndex(s => s.id === autoId); 
        if(targetIdx !== -1) setTimeout(() => openViewer(targetIdx), 300); 
    }
  }

  let dragSrcIndex = null;
  function handleDragStart(e, index) { dragSrcIndex = index; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
  function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.target.closest('.subject-card').classList.add('drag-over'); e.dataTransfer.dropEffect = 'move'; return false; }
  function handleDrop(e, index) { if (e.stopPropagation) e.stopPropagation(); e.target.closest('.subject-card').classList.remove('drag-over'); if (dragSrcIndex !== null && dragSrcIndex !== index) { const movedItem = subjects.splice(dragSrcIndex, 1)[0]; subjects.splice(index, 0, movedItem); saveSubjects(); } return false; }
  function handleDragEnd(e) { document.querySelectorAll('.subject-card').forEach(card => { card.classList.remove('dragging'); card.classList.remove('drag-over'); }); }

async function openViewer(idx) {
    document.querySelectorAll('.subject-card').forEach(c => c.classList.remove('last-viewed'));
    viewingIndex = idx; 

    const sub = subjects[idx];
    let pdfName = sub.pdfName;
    
    if(!pdfName) return alert("ë“±ë¡ëœ PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
    if (pdfName.startsWith('/')) pdfName = pdfName.substring(1);
    if (!pdfName.toLowerCase().endsWith('.pdf')) pdfName += '.pdf';

    const pdfUrl = `files/${pdfName}`;
    
    let audioUrl = null;
    if(sub.audioName) {
        let aName = sub.audioName.trim();
        if(aName.startsWith('/')) aName = aName.substring(1);
        audioUrl = `files/${aName}`;
    }

    overlay.style.display = 'flex'; 
    
    try {
      if (overlay.requestFullscreen) await overlay.requestFullscreen();
      else if (overlay.webkitRequestFullscreen) await overlay.webkitRequestFullscreen();
    } catch(e) { console.log(e); }

    document.getElementById('vTitle').textContent = sub.name;
    
    try {
        const task = pdfjsLib.getDocument(pdfUrl);
        pdfDoc = await task.promise;
        viewerBody.innerHTML = ''; viewerBody.appendChild(canvasContainer); canvasContainer.innerHTML = '';
        pageNum = 1; renderPage('none');
    } catch(e) {
        alert("PDF ë¡œë“œ ì‹¤íŒ¨: " + pdfUrl + "\níŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        closeViewer();
        return;
    }
    
    const grp = document.getElementById('mobileAudioGroup');
    const iconR = document.getElementById('mobileAudioIconRight');
    const pcBtn = document.getElementById('audioBtn');
    const pcPanel = document.getElementById('audioPanel');
    
    if(audioUrl) {
        audioPlayer.src = audioUrl;
        audioPlayer.load();
        
        if(window.innerWidth <= 768) {
            grp.style.display = 'flex';
            iconR.style.display = 'flex';
        }
        
        pcBtn.style.display = 'flex';       
        pcBtn.classList.remove('disabled');
        
    } else {
        audioPlayer.src = "";
        
        grp.style.display = 'none';
        iconR.style.display = 'none';
        
        pcPanel.classList.remove('open');
        
        pcBtn.style.display = 'none'; 
        pcBtn.classList.add('disabled');
    }
    
    updateIconState(); 
  }

  function toggleFullScreen(e) {
    e.stopPropagation();
    if (!document.fullscreenElement) document.getElementById('pdfOverlay').requestFullscreen().catch(err => {});
    else if (document.exitFullscreen) document.exitFullscreen();
  }

  function updateIconState() {
    const isFs = !!document.fullscreenElement;
    document.getElementById('iconExpand').style.display = isFs ? 'none' : 'block';
    document.getElementById('iconCompress').style.display = isFs ? 'block' : 'none';
  }
  document.addEventListener('fullscreenchange', updateIconState);

  function closeViewer() { 
    if (document.fullscreenElement) document.exitFullscreen(); 
    overlay.style.display = 'none'; 
    audioPlayer.pause(); 
    
    if(viewingIndex !== -1) {
        const card = document.getElementById(`card-${viewingIndex}`);
        if(card) {
            card.classList.add('last-viewed');
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
  }

  function downloadPdf(e) { 
      e.stopPropagation(); 
      if(pdfDoc) {
          const sub = subjects[viewingIndex];
          let pdfName = sub.pdfName;
          if (!pdfName.toLowerCase().endsWith('.pdf')) pdfName += '.pdf';
          const a = document.createElement('a'); 
          a.href = `files/${pdfName}`; 
          a.download = pdfName; 
          a.click(); 
      }
  }
  
  function toggleAudioPanel(e) { 
    e.stopPropagation(); 
    if(document.getElementById('audioBtn').classList.contains('disabled')) return;
    const panel = document.getElementById('audioPanel');
    if (panel.classList.contains('open')) panel.classList.remove('open');
    else panel.classList.add('open');
  }

  async function renderPage(dir) {
    if(isRendering) return; isRendering = true;

    if(pdfDoc) { 
        document.getElementById('pageFill').style.width = `${((pageNum-1)/(pdfDoc.numPages-1))*100}%`; 
        document.getElementById('progressFlag').textContent = `${pageNum} / ${pdfDoc.numPages}`; 
    }
    
    const newCanvas = document.createElement('canvas'); 
    const ctx = newCanvas.getContext('2d');
    const page = await pdfDoc.getPage(pageNum);
    
    const isMobile = window.innerWidth <= 768;
    let viewport;
    
    if (isMobile) {
        const unscaledViewport = page.getViewport({ scale: 1 });
        const scale = (window.innerWidth / unscaledViewport.width) * 1.5; 
        viewport = page.getViewport({ scale: scale });
    } else {
        const unscaledViewport = page.getViewport({ scale: 1 });
        const availableHeight = window.innerHeight; 
        const scaleY = availableHeight / unscaledViewport.height;
        const scaleX = window.innerWidth / unscaledViewport.width;
        const baseScale = Math.min(scaleX, scaleY) * 0.98; 
        viewport = page.getViewport({ scale: baseScale }); 
    }
    
    newCanvas.width = viewport.width; 
    newCanvas.height = viewport.height;
    
    if(isMobile) {
        newCanvas.style.display = 'block';
        newCanvas.style.width = '100%'; 
        newCanvas.style.height = 'auto'; 
    }

    await page.render({ canvasContext: ctx, viewport }).promise;
    
    const oldCanvas = canvasContainer.querySelector('canvas');
    if (oldCanvas) {
        oldCanvas.replaceWith(newCanvas);
    } else {
        canvasContainer.innerHTML = '';
        canvasContainer.appendChild(newCanvas);
    }
    
    if(isMobile) {
        viewerBody.scrollTop = 0;
    }

    isRendering = false;
  }

  function nextPage() { if(pdfDoc && pageNum < pdfDoc.numPages) { pageNum++; renderPage('next'); } }
  function prevPage() { if(pdfDoc && pageNum > 1) { pageNum--; renderPage('prev'); } }
  
  function handleMouseNav(e) { 
    if(isDragging) return; 
    if(e.button === 0) nextPage(); 
    if(e.button === 2) prevPage(); 
  }

  if(hitArea) {
      hitArea.addEventListener('mousedown', (e) => { e.preventDefault(); e.stopPropagation(); isDragging = true; hitArea.classList.add('dragging'); updateProgress(e.clientX); });
      window.addEventListener('mousemove', (e) => { if(!isDragging || !pdfDoc) return; updateProgress(e.clientX); });
      window.addEventListener('mouseup', () => { if(isDragging) { isDragging = false; hitArea.classList.remove('dragging'); renderPage('none'); } });

      hitArea.addEventListener('touchstart', (e) => {
          e.preventDefault(); e.stopPropagation();
          isDragging = true; hitArea.classList.add('dragging');
          updateProgress(e.touches[0].clientX);
      }, {passive: false});

      hitArea.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          e.preventDefault(); e.stopPropagation();
          updateProgress(e.touches[0].clientX);
      }, {passive: false});

      hitArea.addEventListener('touchend', (e) => {
          if (isDragging) {
              isDragging = false; hitArea.classList.remove('dragging');
              renderPage('none');
          }
      });
  }

  function updateProgress(clientX) {
    const rect = hitArea.getBoundingClientRect(); 
    const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
    const newPage = Math.max(1, Math.min(Math.round((x/rect.width) * (pdfDoc.numPages - 1)) + 1, pdfDoc.numPages));
    
    if(newPage !== pageNum) { 
        pageNum = newPage; 
        document.getElementById('pageFill').style.width = `${((pageNum-1)/(pdfDoc.numPages-1))*100}%`; 
        document.getElementById('progressFlag').textContent = `${pageNum} / ${pdfDoc.numPages}`; 
        if(!isDragging) renderPage('none'); 
    }
  }

  document.getElementById('playBtn').onclick = (e) => { 
      e.stopPropagation(); 
      if(!audioPlayer.src || audioPlayer.src === window.location.href) { alert("ì¬ìƒí•  ì˜¤ë””ì˜¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      if(audioPlayer.paused) { 
          audioPlayer.play().then(() => { document.getElementById('playBtn').textContent = "â¸"; }).catch(err => { alert("ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨"); });
      } else { 
          audioPlayer.pause(); document.getElementById('playBtn').textContent = "â–¶"; 
      } 
  };
  
  document.getElementById('mobilePlayBtn').onclick = (e) => {
      e.stopPropagation();
      if(audioPlayer.paused) { 
          audioPlayer.play(); 
          document.getElementById('mobilePlayBtn').innerText = "â¸";
      } else { 
          audioPlayer.pause(); 
          document.getElementById('mobilePlayBtn').innerText = "â–¶";
      }
  };

  const mProg = document.getElementById('mobileAudioProgress');
  mProg.onclick = (e) => e.stopPropagation();
  mProg.oninput = (e) => { 
      e.stopPropagation();
      if(audioPlayer.duration) {
          audioPlayer.currentTime = (e.target.value / 100) * audioPlayer.duration; 
      }
  };

  audioPlayer.ontimeupdate = () => { 
      const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
      const m = Math.floor(audioPlayer.currentTime/60);
      const s = Math.floor(audioPlayer.currentTime%60);
      const timeStr = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

      document.getElementById('audioProgress').value = pct; 
      document.getElementById('audioTime').textContent = timeStr;
      
      document.getElementById('mobileAudioProgress').value = pct;
      document.getElementById('mobileAudioTime').innerText = timeStr;
  };
  
  const aProg = document.getElementById('audioProgress');
  aProg.oninput = (e) => { e.stopPropagation(); audioPlayer.currentTime = (e.target.value / 100) * audioPlayer.duration; };
  aProg.addEventListener('touchstart', (e) => e.stopPropagation(), {passive: false});

  document.getElementById('volumeControl').oninput = (e) => { audioPlayer.volume = e.target.value; };
  
  window.onkeydown = (e) => { 
    if(overlay.style.display === 'flex') { 
        if(e.key === "ArrowRight") nextPage(); 
        if(e.key === "ArrowLeft") prevPage(); 
        if(e.key === "Escape") closeViewer();
    } 
  };

  let touchStartY = 0;
  let touchEndY = 0;
  const minSwipeDistance = 50; 

  overlay.addEventListener('touchstart', e => { touchStartY = e.changedTouches[0].screenY; }, {passive: true});
  overlay.addEventListener('touchend', e => { touchEndY = e.changedTouches[0].screenY; handleSwipe(); }, {passive: true});

  function handleSwipe() {
      const distance = touchStartY - touchEndY;
      if (distance > minSwipeDistance) { nextPage(); } else if (distance < -minSwipeDistance) { prevPage(); }
  }
  
  init();
</script>
</body>
</html>